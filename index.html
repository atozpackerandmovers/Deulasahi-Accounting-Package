<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deulasahi Bazar Committee - Accounting System v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, serverTimestamp, where, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, setPersistence, browserSessionPersistence, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyCBpyB-PXrF1xUQlTBem4-H35LG1KRpCjw",
          authDomain: "deulasahi-account.firebaseapp.com",
          projectId: "deulasahi-account",
          storageBucket: "deulasahi-account.appspot.com",
          messagingSenderId: "729974065764",
          appId: "1:729974065764:web:da5606651957a1746a6d71"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        await setPersistence(auth, browserSessionPersistence);
        
        window.db = db;
        window.auth = auth;
        window.firestore = { collection, addDoc, getDocs, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, serverTimestamp, where, limit };
        
        // Simplified App Controller
        class AppController {
            constructor() {
                this.currentUser = null;
                this.currentRole = 'member';
                this.accounts = [];
                this.transactions = [];
                this.isOnline = navigator.onLine;
                this.init();
            }
            
            async init() {
                this.setupNetworkListeners();
                this.setupAuthListener();
                this.setupEventListeners();
                this.showLoginView();
            }
            
            setupNetworkListeners() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.showToast('Back online! Syncing data...', 'success');
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.showToast('You are offline. Changes will be saved locally.', 'warning');
                });
            }
            
            setupAuthListener() {
                onAuthStateChanged(auth, (user) => {
                    this.currentUser = user;
                    if (user) {
                        this.handleSuccessfulLogin();
                    } else {
                        this.handleLogout();
                    }
                });
            }
            
            setupEventListeners() {
                // Login form
                document.getElementById('loginForm')?.addEventListener('submit', (e) => this.handleLogin(e));
                
                // Logout button
                document.getElementById('logoutBtn')?.addEventListener('click', () => this.logout());
                
                // Role switching
                document.getElementById('memberTab')?.addEventListener('click', () => this.switchRole('member'));
                document.getElementById('adminTab')?.addEventListener('click', () => this.switchRole('admin'));
            }
            
            switchRole(role) {
                const memberTab = document.getElementById('memberTab');
                const adminTab = document.getElementById('adminTab');
                const currentRoleInput = document.getElementById('currentRole');
                
                if (role === 'member') {
                    memberTab.className = 'px-3 py-2 rounded bg-blue-600 text-white';
                    adminTab.className = 'px-3 py-2 rounded bg-gray-200';
                } else {
                    memberTab.className = 'px-3 py-2 rounded bg-gray-200';
                    adminTab.className = 'px-3 py-2 rounded bg-purple-600 text-white';
                }
                
                this.currentRole = role;
                if (currentRoleInput) {
                    currentRoleInput.value = role;
                }
            }
            
            async handleLogin(e) {
                e.preventDefault();
                const form = e.target;
                const email = form.querySelector('input[type="email"]').value.trim();
                const password = form.querySelector('input[type="password"]').value;
                
                if (!email || !password) {
                    this.showToast('Please enter email and password', 'error');
                    return;
                }
                
                try {
                    this.showLoading(true);
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    this.showToast(error.message || 'Login failed', 'error');
                } finally {
                    this.showLoading(false);
                }
            }
            
            async handleSuccessfulLogin() {
                try {
                    this.showLoading(true);
                    await this.loadData();
                    this.showAppView();
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.showToast('Error loading data. Working in offline mode.', 'warning');
                    this.showAppView();
                } finally {
                    this.showLoading(false);
                }
            }
            
            handleLogout() {
                this.currentUser = null;
                this.accounts = [];
                this.transactions = [];
                this.showLoginView();
            }
            
            async logout() {
                try {
                    await signOut(auth);
                    this.showToast('Logged out successfully', 'success');
                } catch (error) {
                    console.error('Logout error:', error);
                }
            }
            
            showLoginView() {
                document.getElementById('loginView').classList.remove('hidden');
                document.getElementById('appView').classList.add('hidden');
            }
            
            showAppView() {
                document.getElementById('loginView').classList.add('hidden');
                document.getElementById('appView').classList.remove('hidden');
                wireTabs('#mainNav');
                this.updateDashboard();
            }
            
            async loadData() {
                if (this.isOnline) {
                    await this.loadFromFirebase();
                } else {
                    this.loadFromLocal();
                }
            }
            
            async loadFromFirebase() {
                try {
                    // Load accounts
                    const accountsQuery = query(collection(db, 'accounts'), orderBy('createdAt', 'desc'));
                    const accountsSnapshot = await getDocs(accountsQuery);
                    this.accounts = accountsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Load transactions
                    const transactionsQuery = query(collection(db, 'transactions'), orderBy('createdAt', 'desc'));
                    const transactionsSnapshot = await getDocs(transactionsQuery);
                    this.transactions = transactionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Save to local storage as backup
                    localStorage.setItem('accounts', JSON.stringify(this.accounts));
                    localStorage.setItem('transactions', JSON.stringify(this.transactions));
                    
                } catch (error) {
                    console.error('Firebase load error:', error);
                    throw error;
                }
            }
            
            loadFromLocal() {
                try {
                    this.accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                    this.transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
                } catch (error) {
                    console.error('Local storage load error:', error);
                    this.accounts = [];
                    this.transactions = [];
                }
            }
            
            updateDashboard() {
                const totalCredit = this.transactions.filter(t => t.type === 'credit').reduce((sum, t) => sum + t.amount, 0);
                const totalDebit = this.transactions.filter(t => t.type === 'debit').reduce((sum, t) => sum + t.amount, 0);
                const netBalance = totalCredit - totalDebit;
                
                document.getElementById('totalCredit').textContent = `₹${totalCredit.toFixed(2)}`;
                document.getElementById('totalDebit').textContent = `₹${totalDebit.toFixed(2)}`;
                document.getElementById('totalAccounts').textContent = this.accounts.length;
                
                const netBalanceEl = document.getElementById('netBalance');
                netBalanceEl.textContent = `₹${netBalance.toFixed(2)}`;
                netBalanceEl.className = `text-lg sm:text-2xl font-bold ${netBalance >= 0 ? 'text-green-600' : 'text-red-600'}`;
                
                this.updateRecentTransactions();
            }
            
            updateRecentTransactions() {
                const container = document.getElementById('recentTransactions');
                if (!container) return;
                
                const recentTx = this.transactions.slice(0, 5);
                
                if (recentTx.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">No transactions yet. Add your first transaction!</p>';
                    return;
                }
                
                container.innerHTML = recentTx.map(tx => {
                    const account = this.accounts.find(acc => acc.id === tx.accountId);
                    return `
                        <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg ${tx.type === 'credit' ? 'border-l-4 border-l-green-500' : 'border-l-4 border-l-red-500'}">
                            <div class="flex-1">
                                <p class="font-medium text-gray-900">${account ? account.name : 'Account'}</p>
                                <p class="text-sm text-gray-600">${tx.description || 'No description'}</p>
                                <p class="text-xs text-gray-500">${new Date(tx.date).toLocaleDateString()}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold ${tx.type === 'credit' ? 'text-green-600' : 'text-red-600'}">
                                    ${tx.type === 'credit' ? '+' : '-'}₹${tx.amount.toFixed(2)}
                                </p>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            showLoading(show) {
                const loader = document.getElementById('loadingIndicator');
                if (loader) {
                    loader.classList.toggle('hidden', !show);
                }
            }
            
            showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                const messageEl = document.getElementById('toastMessage');
                
                if (!toast || !messageEl) return;
                
                messageEl.textContent = message;
                
                // Set color based on type
                toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2 ${
                    type === 'success' ? 'bg-green-500 text-white' :
                    type === 'error' ? 'bg-red-500 text-white' :
                    type === 'warning' ? 'bg-yellow-500 text-white' :
                    'bg-blue-500 text-white'
                }`;
                
                toast.classList.remove('hidden');
                
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 3000);
            }
        }
        
        // Tab Navigation System
        function wireTabs(scopeSel) {
            const scope = document.querySelector(scopeSel);
            if (!scope) return;
            
            const links = scope.querySelectorAll('.tab-link');
            const sections = document.querySelectorAll('.tab-section');
            
            links.forEach(link => {
                link.addEventListener('click', (ev) => {
                    ev.preventDefault();
                    
                    // Update active state
                    links.forEach(l => {
                        l.classList.remove('active', 'border-blue-500', 'text-blue-600');
                        l.classList.add('border-transparent', 'text-gray-500');
                    });
                    link.classList.add('active', 'border-blue-500', 'text-blue-600');
                    link.classList.remove('border-transparent', 'text-gray-500');
                    
                    // Show/hide sections
                    const targetId = link.dataset.target;
                    sections.forEach(s => s.classList.add('hidden'));
                    const target = document.getElementById(targetId);
                    if (target) target.classList.remove('hidden');
                });
            });
            
            // Auto-click first tab
            const firstTab = links[0];
            if (firstTab) firstTab.click();
        }
        
        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new AppController();
        });
        
        // Make functions globally available
        window.wireTabs = wireTabs;
    </script>
    
    <script type="module">
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc }
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const auth = getAuth();
        const db = getFirestore();

        document.getElementById("loginBtn")?.addEventListener("click", async (e) => {
          e.preventDefault();
          const email = document.getElementById("loginEmail")?.value.trim();
          const password = document.getElementById("loginPassword")?.value.trim();

          if (!email || !password) {
            alert("Please enter both email and password");
            return;
          }

          try {
            // Show loading
            const loginBtn = document.getElementById("loginBtn");
            const originalText = loginBtn.textContent;
            loginBtn.textContent = "Logging in...";
            loginBtn.disabled = true;

            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const uid = userCredential.user.uid;

            // Fetch role from Firestore
            const docRef = doc(db, "users", uid);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
              const data = docSnap.data();
              if (data.role === "admin") {
                window.location.hash = "#/admin";
                // Store role for later use
                sessionStorage.setItem('userRole', 'admin');
              } else {
                window.location.hash = "#/member";
                // Store role for later use
                sessionStorage.setItem('userRole', 'member');
              }
            } else {
              alert("No role assigned. Contact admin.");
              await auth.signOut();
            }

            // Reset button
            loginBtn.textContent = originalText;
            loginBtn.disabled = false;

          } catch (error) {
            // Reset button
            const loginBtn = document.getElementById("loginBtn");
            loginBtn.textContent = "Login";
            loginBtn.disabled = false;
            
            alert("Login failed: " + error.message);
          }
        });

        onAuthStateChanged(auth, async (user) => {
          // user ଥିଲେ ଭ୍ୟୁ ଖୋଲନ୍ତୁ, ନହେଲେ login ଦେଖାନ୍ତୁ
          if (user) {
            // Check if we already have role in session
            const storedRole = sessionStorage.getItem('userRole');
            if (storedRole) {
              if (!location.hash) {
                location.hash = storedRole === 'admin' ? '#/admin' : '#/member';
              }
            } else {
              // Fetch role from Firestore if not in session
              try {
                const docRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                  const data = docSnap.data();
                  sessionStorage.setItem('userRole', data.role || 'member');
                  if (!location.hash) {
                    location.hash = data.role === 'admin' ? '#/admin' : '#/member';
                  }
                } else {
                  // Default to member if no role found
                  sessionStorage.setItem('userRole', 'member');
                  if (!location.hash) location.hash = '#/member';
                }
              } catch (error) {
                console.error('Error fetching user role:', error);
                // Default to member on error
                sessionStorage.setItem('userRole', 'member');
                if (!location.hash) location.hash = '#/member';
              }
            }
          } else {
            // Clear stored role on logout
            sessionStorage.removeItem('userRole');
          }
        });
    </script>
    
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const memberTab = document.getElementById('memberTab');
        const adminTab = document.getElementById('adminTab');
        const roleInput = document.getElementById('currentRole');

        memberTab?.addEventListener('click', () => {
          if (roleInput) roleInput.value = 'member';
          memberTab.className = 'px-3 py-2 rounded bg-blue-600 text-white cursor-pointer';
          adminTab.className = 'px-3 py-2 rounded bg-gray-200 cursor-pointer';
        });

        adminTab?.addEventListener('click', () => {
          if (roleInput) roleInput.value = 'admin';
          adminTab.className = 'px-3 py-2 rounded bg-purple-600 text-white cursor-pointer';
          memberTab.className = 'px-3 py-2 rounded bg-gray-200 cursor-pointer';
        });
      });
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden;
        }
        
        .gradient-bg {
               class AppController {
            constructor() {
                this.currentUser = null;
                this.currentRole = 'member';
                this.accounts = [];
                this.transactions = [];
                this.isOnline = navigator.onLine;
                this.init();
            }
            
            async init() {
                this.setupNetworkListeners();
                this.setupAuthListener();
                this.setupEventListeners();
                this.showLoginView();
            }
            
            setupNetworkListeners() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.showToast('Back online! Syncing data...', 'success');
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.showToast('You are offline. Changes will be saved locally.', 'warning');
                });
            }
            
            setupAuthListener() {
                onAuthStateChanged(auth, (user) => {
                    this.currentUser = user;
                    if (user) {
                        this.handleSuccessfulLogin();
                    } else {
                        this.handleLogout();
                    }
                });
            }
            
            setupEventListeners() {
                // Login form
                document.getElementById('loginForm')?.addEventListener('submit', (e) => this.handleLogin(e));
                
                // Logout button
                document.getElementById('logoutBtn')?.addEventListener('click', () => this.logout());
                
                // Role switching
                document.getElementById('memberTab')?.addEventListener('click', () => this.switchRole('member'));
                document.getElementById('adminTab')?.addEventListener('click', () => this.switchRole('admin'));
            }
            
            switchRole(role) {
                const memberTab = document.getElementById('memberTab');
                const adminTab = document.getElementById('adminTab');
                const currentRoleInput = document.getElementById('currentRole');
                
                if (role === 'member') {
                    memberTab.className = 'px-3 py-2 rounded bg-blue-600 text-white';
                    adminTab.className = 'px-3 py-2 rounded bg-gray-200';
                } else {
                    memberTab.className = 'px-3 py-2 rounded bg-gray-200';
                    adminTab.className = 'px-3 py-2 rounded bg-purple-600 text-white';
                }
                
                this.currentRole = role;
                if (currentRoleInput) {
                    currentRoleInput.value = role;
                }
            }
            
            async handleLogin(e) {
                e.preventDefault();
                const form = e.target;
                const email = form.querySelector('input[type="email"]').value.trim();
                const password = form.querySelector('input[type="password"]').value;
                
                if (!email || !password) {
                    this.showToast('Please enter email and password', 'error');
                    return;
                }
                
                try {
                    this.showLoading(true);
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    this.showToast(error.message || 'Login failed', 'error');
                } finally {
                    this.showLoading(false);
                }
            }
            
            async handleSuccessfulLogin() {
                try {
                    this.showLoading(true);
                    await this.loadData();
                    this.showAppView();
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.showToast('Error loading data. Working in offline mode.', 'warning');
                    this.showAppView();
                } finally {
                    this.showLoading(false);
                }
            }
            
            handleLogout() {
                this.currentUser = null;
                this.accounts = [];
                this.transactions = [];
                this.showLoginView();
            }
            
            async logout() {
                try {
                    await signOut(auth);
                    this.showToast('Logged out successfully', 'success');
                } catch (error) {
                    console.error('Logout error:', error);
                }
            }
            
            showLoginView() {
                document.getElementById('loginView').classList.remove('hidden');
                document.getElementById('appView').classList.add('hidden');
            }
            
            showAppView() {
                document.getElementById('loginView').classList.add('hidden');
                document.getElementById('appView').classList.remove('hidden');
                wireTabs('#mainNav');
                this.updateDashboard();
            }
            
            async loadData() {
                if (this.isOnline) {
                    await this.loadFromFirebase();
                } else {
                    this.loadFromLocal();
                }
            }
            
            async loadFromFirebase() {
                try {
                    // Load accounts
                    const accountsQuery = query(collection(db, 'accounts'), orderBy('createdAt', 'desc'));
                    const accountsSnapshot = await getDocs(accountsQuery);
                    this.accounts = accountsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Load transactions
                    const transactionsQuery = query(collection(db, 'transactions'), orderBy('createdAt', 'desc'));
                    const transactionsSnapshot = await getDocs(transactionsQuery);
                    this.transactions = transactionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Save to local storage as backup
                    localStorage.setItem('accounts', JSON.stringify(this.accounts));
                    localStorage.setItem('transactions', JSON.stringify(this.transactions));
                    
                } catch (error) {
                    console.error('Firebase load error:', error);
                    throw error;
                }
            }
            
            loadFromLocal() {
                try {
                    this.accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                    this.transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
                } catch (error) {
                    console.error('Local storage load error:', error);
                    this.accounts = [];
                    this.transactions = [];
                }
            }
            
            updateDashboard() {
                const totalCredit = this.transactions.filter(t => t.type === 'credit').reduce((sum, t) => sum + t.amount, 0);
                const totalDebit = this.transactions.filter(t => t.type === 'debit').reduce((sum, t) => sum + t.amount, 0);
                const netBalance = totalCredit - totalDebit;
                
                document.getElementById('totalCredit').textContent = `₹${totalCredit.toFixed(2)}`;
                document.getElementById('totalDebit').textContent = `₹${totalDebit.toFixed(2)}`;
                document.getElementById('totalAccounts').textContent = this.accounts.length;
                
                const netBalanceEl = document.getElementById('netBalance');
                netBalanceEl.textContent = `₹${netBalance.toFixed(2)}`;
                netBalanceEl.className = `text-lg sm:text-2xl font-bold ${netBalance >= 0 ? 'text-green-600' : 'text-red-600'}`;
                
                this.updateRecentTransactions();
            }
            
            updateRecentTransactions() {
                const container = document.getElementById('recentTransactions');
                if (!container) return;
                
                const recentTx = this.transactions.slice(0, 5);
                
                if (recentTx.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">No transactions yet. Add your first transaction!</p>';
                    return;
                }
                
                container.innerHTML = recentTx.map(tx => {
                    const account = this.accounts.find(acc => acc.id === tx.accountId);
                    return `
                        <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg ${tx.type === 'credit' ? 'border-l-4 border-l-green-500' : 'border-l-4 border-l-red-500'}">
                            <div class="flex-1">
                                <p class="font-medium text-gray-900">${account ? account.name : 'Account'}</p>
                                <p class="text-sm text-gray-600">${tx.description || 'No description'}</p>
                                <p class="text-xs text-gray-500">${new Date(tx.date).toLocaleDateString()}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold ${tx.type === 'credit' ? 'text-green-600' : 'text-red-600'}">
                                    ${tx.type === 'credit' ? '+' : '-'}₹${tx.amount.toFixed(2)}
                                </p>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            showLoading(show) {
                const loader = document.getElementById('loadingIndicator');
                if (loader) {
                    loader.classList.toggle('hidden', !show);
                }
            }
            
            showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                const messageEl = document.getElementById('toastMessage');
                
                if (!toast || !messageEl) return;
                
                messageEl.textContent = message;
                
                // Set color based on type
                toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2 ${
                    type === 'success' ? 'bg-green-500 text-white' :
                    type === 'error' ? 'bg-red-500 text-white' :
                    type === 'warning' ? 'bg-yellow-500 text-white' :
                    'bg-blue-500 text-white'
                }`;
                
                toast.classList.remove('hidden');
                
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 3000);
            }
        }
        
        // Tab Navigation System
        function wireTabs(scopeSel) {
            const scope = document.querySelector(scopeSel);
            if (!scope) return;
            
            const links = scope.querySelectorAll('.tab-link');
            const sections = document.querySelectorAll('.tab-section');
            
            links.forEach(link => {
                link.addEventListener('click', (ev) => {
                    ev.preventDefault();
                    
                    // Update active state
                    links.forEach(l => {
                        l.classList.remove('active', 'border-blue-500', 'text-blue-600');
                        l.classList.add('border-transparent', 'text-gray-500');
                    });
                    link.classList.add('active', 'border-blue-500', 'text-blue-600');
                    link.classList.remove('border-transparent', 'text-gray-500');
                    
                    // Show/hide sections
                    const targetId = link.dataset.target;
                    sections.forEach(s => s.classList.add('hidden'));
                    const target = document.getElementById(targetId);
                    if (target) target.classList.remove('hidden');
                });
            });
            
            // Auto-click first tab
            const firstTab = links[0];
            if (firstTab) firstTab.click();
        }
        
        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new AppController();
        });
        
        // Make functions globally available
        window.wireTabs = wireTabs;
    </script>
    
    <script type="module">
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc }
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const auth = getAuth();
        const db = getFirestore();

        document.getElementById("loginBtn")?.addEventListener("click", async (e) => {
          e.preventDefault();
          const email = document.getElementById("loginEmail")?.value.trim();
          const password = document.getElementById("loginPassword")?.value.trim();

          if (!email || !password) {
            alert("Please enter both email and password");
            return;
          }

          try {
            // Show loading
            const loginBtn = document.getElementById("loginBtn");
            const originalText = loginBtn.textContent;
            loginBtn.textContent = "Logging in...";
            loginBtn.disabled = true;

            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const uid = userCredential.user.uid;

            // Fetch role from Firestore
            const docRef = doc(db, "users", uid);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
              const data = docSnap.data();
              if (data.role === "admin") {
                window.location.hash = "#/admin";
                // Store role for later use
                sessionStorage.setItem('userRole', 'admin');
              } else {
                window.location.hash = "#/member";
                // Store role for later use
                sessionStorage.setItem('userRole', 'member');
              }
            } else {
              alert("No role assigned. Contact admin.");
              await auth.signOut();
            }

            // Reset button
            loginBtn.textContent = originalText;
            loginBtn.disabled = false;

          } catch (error) {
            // Reset button
            const loginBtn = document.getElementById("loginBtn");
            loginBtn.textContent = "Login";
            loginBtn.disabled = false;
            
            alert("Login failed: " + error.message);
          }
        });

        onAuthStateChanged(auth, async (user) => {
          // user ଥିଲେ ଭ୍ୟୁ ଖୋଲନ୍ତୁ, ନହେଲେ login ଦେଖାନ୍ତୁ
          if (user) {
            // Check if we already have role in session
            const storedRole = sessionStorage.getItem('userRole');
            if (storedRole) {
              if (!location.hash) {
                location.hash = storedRole === 'admin' ? '#/admin' : '#/member';
              }
            } else {
              // Fetch role from Firestore if not in session
              try {
                const docRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                  const data = docSnap.data();
                  sessionStorage.setItem('userRole', data.role || 'member');
                  if (!location.hash) {
                    location.hash = data.role === 'admin' ? '#/admin' : '#/member';
                  }
                } else {
                  // Default to member if no role found
                  sessionStorage.setItem('userRole', 'member');
                  if (!location.hash) location.hash = '#/member';
                }
              } catch (error) {
                console.error('Error fetching user role:', error);
                // Default to member on error
                sessionStorage.setItem('userRole', 'member');
                if (!location.hash) location.hash = '#/member';
              }
            }
          } else {
            // Clear stored role on logout
            sessionStorage.removeItem('userRole');
          }
        });
    </script>
    
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const memberTab = document.getElementById('memberTab');
        const adminTab = document.getElementById('adminTab');
        const roleInput = document.getElementById('currentRole');

        memberTab?.addEventListener('click', () => {
          if (roleInput) roleInput.value = 'member';
          memberTab.className = 'px-3 py-2 rounded bg-blue-600 text-white cursor-pointer';
          adminTab.className = 'px-3 py-2 rounded bg-gray-200 cursor-pointer';
        });

        adminTab?.addEventListener('click', () => {
          if (roleInput) roleInput.value = 'admin';
          adminTab.className = 'px-3 py-2 rounded bg-purple-600 text-white cursor-pointer';
          memberTab.className = 'px-3 py-2 rounded bg-gray-200 cursor-pointer';
        });
      });
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden;
        }
        
        .gradient-bg {
               class AppController {
            constructor() {
                this.currentUser = null;
                this.currentRole = 'member';
                this.accounts = [];
                this.transactions = [];
                this.isOnline = navigator.onLine;
                this.init();
            }
            
            async init() {
                this.setupNetworkListeners();
                this.setupAuthListener();
                this.setupEventListeners();
                this.showLoginView();
            }
            
            setupNetworkListeners() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.showToast('Back online! Syncing data...', 'success');
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.showToast('You are offline. Changes will be saved locally.', 'warning');
                });
            }
            
            setupAuthListener() {
                onAuthStateChanged(auth, (user) => {
                    this.currentUser = user;
                    if (user) {
                        this.handleSuccessfulLogin();
                    } else {
                        this.handleLogout();
                    }
                });
            }
            
            setupEventListeners() {
                // Login form
                document.getElementById('loginForm')?.addEventListener('submit', (e) => this.handleLogin(e));
                
                // Logout button
                document.getElementById('logoutBtn')?.addEventListener('click', () => this.logout());
                
                // Role switching
                document.getElementById('memberTab')?.addEventListener('click', () => this.switchRole('member'));
                document.getElementById('adminTab')?.addEventListener('click', () => this.switchRole('admin'));
            }
            
            switchRole(role) {
                const memberTab = document.getElementById('memberTab');
                const adminTab = document.getElementById('adminTab');
                const currentRoleInput = document.getElementById('currentRole');
                
                if (role === 'member') {
                    memberTab.className = 'px-3 py-2 rounded bg-blue-600 text-white';
                    adminTab.className = 'px-3 py-2 rounded bg-gray-200';
                } else {
                    memberTab.className = 'px-3 py-2 rounded bg-gray-200';
                    adminTab.className = 'px-3 py-2 rounded bg-purple-600 text-white';
                }
                
                this.currentRole = role;
                if (currentRoleInput) {
                    currentRoleInput.value = role;
                }
            }
            
            async handleLogin(e) {
                e.preventDefault();
                const form = e.target;
                const email = form.querySelector('input[type="email"]').value.trim();
                const password = form.querySelector('input[type="password"]').value;
                
                if (!email || !password) {
                    this.showToast('Please enter email and password', 'error');
                    return;
                }
                
                try {
                    this.showLoading(true);
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    this.showToast(error.message || 'Login failed', 'error');
                } finally {
                    this.showLoading(false);
                }
            }
            
            async handleSuccessfulLogin() {
                try {
                    this.showLoading(true);
                    await this.loadData();
                    this.showAppView();
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.showToast('Error loading data. Working in offline mode.', 'warning');
                    this.showAppView();
                } finally {
                    this.showLoading(false);
                }
            }
            
            handleLogout() {
                this.currentUser = null;
                this.accounts = [];
                this.transactions = [];
                this.showLoginView();
            }
            
            async logout() {
                try {
                    await signOut(auth);
                    this.showToast('Logged out successfully', 'success');
                } catch (error) {
                    console.error('Logout error:', error);
                }
            }
            
            showLoginView() {
                document.getElementById('loginView').classList.remove('hidden');
                document.getElementById('appView').classList.add('hidden');
            }
            
            showAppView() {
                document.getElementById('loginView').classList.add('hidden');
                document.getElementById('appView').classList.remove('hidden');
                wireTabs('#mainNav');
                this.updateDashboard();
            }
            
            async loadData() {
                if (this.isOnline) {
                    await this.loadFromFirebase();
                } else {
                    this.loadFromLocal();
                }
            }
            
            async loadFromFirebase() {
                try {
                    // Load accounts
                    const accountsQuery = query(collection(db, 'accounts'), orderBy('createdAt', 'desc'));
                    const accountsSnapshot = await getDocs(accountsQuery);
                    this.accounts = accountsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Load transactions
                    const transactionsQuery = query(collection(db, 'transactions'), orderBy('createdAt', 'desc'));
                    const transactionsSnapshot = await getDocs(transactionsQuery);
                    this.transactions = transactionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Save to local storage as backup
                    localStorage.setItem('accounts', JSON.stringify(this.accounts));
                    localStorage.setItem('transactions', JSON.stringify(this.transactions));
                    
                } catch (error) {
                    console.error('Firebase load error:', error);
                    throw error;
                }
            }
            
            loadFromLocal() {
                try {
                    this.accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                    this.transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
                } catch (error) {
                    console.error('Local storage load error:', error);
                    this.accounts = [];
                    this.transactions = [];
                }
            }
            
            updateDashboard() {
                const totalCredit = this.transactions.filter(t => t.type === 'credit').reduce((sum, t) => sum + t.amount, 0);
                const totalDebit = this.transactions.filter(t => t.type === 'debit').reduce((sum, t) => sum + t.amount, 0);
                const netBalance = totalCredit - totalDebit;
                
                document.getElementById('totalCredit').textContent = `₹${totalCredit.toFixed(2)}`;
                document.getElementById('totalDebit').textContent = `₹${totalDebit.toFixed(2)}`;
                document.getElementById('totalAccounts').textContent = this.accounts.length;
                
                const netBalanceEl = document.getElementById('netBalance');
                netBalanceEl.textContent = `₹${netBalance.toFixed(2)}`;
                netBalanceEl.className = `text-lg sm:text-2xl font-bold ${netBalance >= 0 ? 'text-green-600' : 'text-red-600'}`;
                
                this.updateRecentTransactions();
            }
            
            updateRecentTransactions() {
                const container = document.getElementById('recentTransactions');
                if (!container) return;
                
                const recentTx = this.transactions.slice(0, 5);
                
                if (recentTx.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">No transactions yet. Add your first transaction!</p>';
                    return;
                }
                
                container.innerHTML = recentTx.map(tx => {
                    const account = this.accounts.find(acc => acc.id === tx.accountId);
                    return `
                        <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg ${tx.type === 'credit' ? 'border-l-4 border-l-green-500' : 'border-l-4 border-l-red-500'}">
                            <div class="flex-1">
                                <p class="font-medium text-gray-900">${account ? account.name : 'Account'}</p>
                                <p class="text-sm text-gray-600">${tx.description || 'No description'}</p>
                                <p class="text-xs text-gray-500">${new Date(tx.date).toLocaleDateString()}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold ${tx.type === 'credit' ? 'text-green-600' : 'text-red-600'}">
                                    ${tx.type === 'credit' ? '+' : '-'}₹${tx.amount.toFixed(2)}
                                </p>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            showLoading(show) {
                const loader = document.getElementById('loadingIndicator');
                if (loader) {
                    loader.classList.toggle('hidden', !show);
                }
            }
            
            showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                const messageEl = document.getElementById('toastMessage');
                
                if (!toast || !messageEl) return;
                
                messageEl.textContent = message;
                
                // Set color based on type
                toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2 ${
                    type === 'success' ? 'bg-green-500 text-white' :
                    type === 'error' ? 'bg-red-500 text-white' :
                    type === 'warning' ? 'bg-yellow-500 text-white' :
                    'bg-blue-500 text-white'
                }`;
                
                toast.classList.remove('hidden');
                
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 3000);
            }
        }
        
        // Tab Navigation System
        function wireTabs(scopeSel) {
            const scope = document.querySelector(scopeSel);
            if (!scope) return;
            
            const links = scope.querySelectorAll('.tab-link');
            const sections = document.querySelectorAll('.tab-section');
            
            links.forEach(link => {
                link.addEventListener('click', (ev) => {
                    ev.preventDefault();
                    
                    // Update active state
                    links.forEach(l => {
                        l.classList.remove('active', 'border-blue-500', 'text-blue-600');
                        l.classList.add('border-transparent', 'text-gray-500');
                    });
                    link.classList.add('active', 'border-blue-500', 'text-blue-600');
                    link.classList.remove('border-transparent', 'text-gray-500');
                    
                    // Show/hide sections
                    const targetId = link.dataset.target;
                    sections.forEach(s => s.classList.add('hidden'));
                    const target = document.getElementById(targetId);
                    if (target) target.classList.remove('hidden');
                });
            });
            
            // Auto-click first tab
            const firstTab = links[0];
            if (firstTab) firstTab.click();
        }
        
        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new AppController();
        });
        
        // Make functions globally available
        window.wireTabs = wireTabs;
    </script>
    
    <script type="module">
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc }
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const auth = getAuth();
        const db = getFirestore();

        document.getElementById("loginBtn")?.addEventListener("click", async (e) => {
          e.preventDefault();
          const email = document.getElementById("loginEmail")?.value.trim();
          const password = document.getElementById("loginPassword")?.value.trim();

          if (!email || !password) {
            alert("Please enter both email and password");
            return;
          }

          try {
            // Show loading
            const loginBtn = document.getElementById("loginBtn");
            const originalText = loginBtn.textContent;
            loginBtn.textContent = "Logging in...";
            loginBtn.disabled = true;

            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const uid = userCredential.user.uid;

            // Fetch role from Firestore
            const docRef = doc(db, "users", uid);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
              const data = docSnap.data();
              if (data.role === "admin") {
                window.location.hash = "#/admin";
                // Store role for later use
                sessionStorage.setItem('userRole', 'admin');
              } else {
                window.location.hash = "#/member";
                // Store role for later use
                sessionStorage.setItem('userRole', 'member');
              }
            } else {
              alert("No role assigned. Contact admin.");
              await auth.signOut();
            }

            // Reset button
            loginBtn.textContent = originalText;
            loginBtn.disabled = false;

          } catch (error) {
            // Reset button
            const loginBtn = document.getElementById("loginBtn");
            loginBtn.textContent = "Login";
            loginBtn.disabled = false;
            
            alert("Login failed: " + error.message);
          }
        });

        onAuthStateChanged(auth, async (user) => {
          // user ଥିଲେ ଭ୍ୟୁ ଖୋଲନ୍ତୁ, ନହେଲେ login ଦେଖାନ୍ତୁ
          if (user) {
            // Check if we already have role in session
            const storedRole = sessionStorage.getItem('userRole');
            if (storedRole) {
              if (!location.hash) {
                location.hash = storedRole === 'admin' ? '#/admin' : '#/member';
              }
            } else {
              // Fetch role from Firestore if not in session
              try {
                const docRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                  const data = docSnap.data();
                  sessionStorage.setItem('userRole', data.role || 'member');
                  if (!location.hash) {
                    location.hash = data.role === 'admin' ? '#/admin' : '#/member';
                  }
                } else {
                  // Default to member if no role found
                  sessionStorage.setItem('userRole', 'member');
                  if (!location.hash) location.hash = '#/member';
                }
              } catch (error) {
                console.error('Error fetching user role:', error);
                // Default to member on error
                sessionStorage.setItem('userRole', 'member');
                if (!location.hash) location.hash = '#/member';
              }
            }
          } else {
            // Clear stored role on logout
            sessionStorage.removeItem('userRole');
          }
        });
    </script>
    
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const memberTab = document.getElementById('memberTab');
        const adminTab = document.getElementById('adminTab');
        const roleInput = document.getElementById('currentRole');

        memberTab?.addEventListener('click', () => {
          if (roleInput) roleInput.value = 'member';
          memberTab.className = 'px-3 py-2 rounded bg-blue-600 text-white cursor-pointer';
          adminTab.className = 'px-3 py-2 rounded bg-gray-200 cursor-pointer';
        });

        adminTab?.addEventListener('click', () => {
          if (roleInput) roleInput.value = 'admin';
          adminTab.className = 'px-3 py-2 rounded bg-purple-600 text-white cursor-pointer';
          memberTab.className = 'px-3 py-2 rounded bg-gray-200 cursor-pointer';
        });
      });
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden;
        }
        
        .gradient-bg {
               
        window.db = db;
        window.auth = auth;
        window.firestore = { collection, addDoc, getDocs, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, serverTimestamp, where, limit };
        
        // Simplified App Controller
        class AppController {
            constructor() {
                this.currentUser = null;
                this.currentRole = 'member';
                this.accounts = [];
                this.transactions = [];
                this.isOnline = navigator.onLine;
                this.init();
            }
            
            async init() {
                this.setupNetworkListeners();
                this.setupAuthListener();
                this.setupEventListeners();
                this.showLoginView();
            }
            
            setupNetworkListeners() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.showToast('Back online! Syncing data...', 'success');
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.showToast('You are offline. Changes will be saved locally.', 'warning');
                });
            }
            
            setupAuthListener() {
                onAuthStateChanged(auth, (user) => {
                    this.currentUser = user;
                    if (user) {
                        this.handleSuccessfulLogin();
                    } else {
                        this.handleLogout();
                    }
                });
            }
            
            setupEventListeners() {
                // Login form
                document.getElementById('loginForm')?.addEventListener('submit', (e) => this.handleLogin(e));
                
                // Logout button
                document.getElementById('logoutBtn')?.addEventListener('click', () => this.logout());
                
                // Role switching
                document.getElementById('memberTab')?.addEventListener('click', () => this.switchRole('member'));
                document.getElementById('adminTab')?.addEventListener('click', () => this.switchRole('admin'));
            }
            
            switchRole(role) {
                const memberTab = document.getElementById('memberTab');
                const adminTab = document.getElementById('adminTab');
                const currentRoleInput = document.getElementById('currentRole');
                
                if (role === 'member') {
                    memberTab.className = 'px-3 py-2 rounded bg-blue-600 text-white';
                    adminTab.className = 'px-3 py-2 rounded bg-gray-200';
                } else {
                    memberTab.className = 'px-3 py-2 rounded bg-gray-200';
                    adminTab.className = 'px-3 py-2 rounded bg-purple-600 text-white';
                }
                
                this.currentRole = role;
                if (currentRoleInput) {
                    currentRoleInput.value = role;
                }
            }
            
            async handleLogin(e) {
                e.preventDefault();
                const form = e.target;
                const email = form.querySelector('input[type="email"]').value.trim();
                const password = form.querySelector('input[type="password"]').value;
                
                if (!email || !password) {
                    this.showToast('Please enter email and password', 'error');
                    return;
                }
                
                try {
                    this.showLoading(true);
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    this.showToast(error.message || 'Login failed', 'error');
                } finally {
                    this.showLoading(false);
                }
            }
            
            async handleSuccessfulLogin() {
                try {
                    this.showLoading(true);
                    await this.loadData();
                    this.showAppView();
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.showToast('Error loading data. Working in offline mode.', 'warning');
                    this.showAppView();
                } finally {
                    this.showLoading(false);
                }
            }
            
            handleLogout() {
                this.currentUser = null;
                this.accounts = [];
                this.transactions = [];
                this.showLoginView();
            }
            
            async logout() {
                try {
                    await signOut(auth);
                    this.showToast('Logged out successfully', 'success');
                } catch (error) {
                    console.error('Logout error:', error);
                }
            }
            
            showLoginView() {
                document.getElementById('loginView').classList.remove('hidden');
                document.getElementById('appView').classList.add('hidden');
            }
            
            showAppView() {
                document.getElementById('loginView').classList.add('hidden');
                document.getElementById('appView').classList.remove('hidden');
                wireTabs('#mainNav');
                this.updateDashboard();
            }
            
            async loadData() {
                if (this.isOnline) {
                    await this.loadFromFirebase();
                } else {
                    this.loadFromLocal();
                }
            }
            
            async loadFromFirebase() {
                try {
                    // Load accounts
                    const accountsQuery = query(collection(db, 'accounts'), orderBy('createdAt', 'desc'));
                    const accountsSnapshot = await getDocs(accountsQuery);
                    this.accounts = accountsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Load transactions
                    const transactionsQuery = query(collection(db, 'transactions'), orderBy('createdAt', 'desc'));
                    const transactionsSnapshot = await getDocs(transactionsQuery);
                    this.transactions = transactionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Save to local storage as backup
                    localStorage.setItem('accounts', JSON.stringify(this.accounts));
                    localStorage.setItem('transactions', JSON.stringify(this.transactions));
                    
                } catch (error) {
                    console.error('Firebase load error:', error);
                    throw error;
                }
            }
            
            loadFromLocal() {
                try {
                    this.accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                    this.transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
                } catch (error) {
                    console.error('Local storage load error:', error);
                    this.accounts = [];
                    this.transactions = [];
                }
            }
            
            updateDashboard() {
                const totalCredit = this.transactions.filter(t => t.type === 'credit').reduce((sum, t) => sum + t.amount, 0);
                const totalDebit = this.transactions.filter(t => t.type === 'debit').reduce((sum, t) => sum + t.amount, 0);
                const netBalance = totalCredit - totalDebit;
                
                document.getElementById('totalCredit').textContent = `₹${totalCredit.toFixed(2)}`;
                document.getElementById('totalDebit').textContent = `₹${totalDebit.toFixed(2)}`;
                document.getElementById('totalAccounts').textContent = this.accounts.length;
                
                const netBalanceEl = document.getElementById('netBalance');
                netBalanceEl.textContent = `₹${netBalance.toFixed(2)}`;
                netBalanceEl.className = `text-lg sm:text-2xl font-bold ${netBalance >= 0 ? 'text-green-600' : 'text-red-600'}`;
                
                this.updateRecentTransactions();
            }
            
            updateRecentTransactions() {
                const container = document.getElementById('recentTransactions');
                if (!container) return;
                
                const recentTx = this.transactions.slice(0, 5);
                
                if (recentTx.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">No transactions yet. Add your first transaction!</p>';
                    return;
                }
                
                container.innerHTML = recentTx.map(tx => {
                    const account = this.accounts.find(acc => acc.id === tx.accountId);
                    return `
                        <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg ${tx.type === 'credit' ? 'border-l-4 border-l-green-500' : 'border-l-4 border-l-red-500'}">
                            <div class="flex-1">
                                <p class="font-medium text-gray-900">${account ? account.name : 'Account'}</p>
                                <p class="text-sm text-gray-600">${tx.description || 'No description'}</p>
                                <p class="text-xs text-gray-500">${new Date(tx.date).toLocaleDateString()}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold ${tx.type === 'credit' ? 'text-green-600' : 'text-red-600'}">
                                    ${tx.type === 'credit' ? '+' : '-'}₹${tx.amount.toFixed(2)}
                                </p>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            showLoading(show) {
                const loader = document.getElementById('loadingIndicator');
                if (loader) {
                    loader.classList.toggle('hidden', !show);
                }
            }
            
            showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                const messageEl = document.getElementById('toastMessage');
                
                if (!toast || !messageEl) return;
                
                messageEl.textContent = message;
                
                // Set color based on type
                toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2 ${
                    type === 'success' ? 'bg-green-500 text-white' :
                    type === 'error' ? 'bg-red-500 text-white' :
                    type === 'warning' ? 'bg-yellow-500 text-white' :
                    'bg-blue-500 text-white'
                }`;
                
                toast.classList.remove('hidden');
                
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 3000);
            }
        }
        
        // Tab Navigation System
        function wireTabs(scopeSel) {
            const scope = document.querySelector(scopeSel);
            if (!scope) return;
            
            const links = scope.querySelectorAll('.tab-link');
            const sections = document.querySelectorAll('.tab-section');
            
            links.forEach(link => {
                link.addEventListener('click', (ev) => {
                    ev.preventDefault();
                    
                    // Update active state
                    links.forEach(l => {
                        l.classList.remove('active', 'border-blue-500', 'text-blue-600');
                        l.classList.add('border-transparent', 'text-gray-500');
                    });
                    link.classList.add('active', 'border-blue-500', 'text-blue-600');
                    link.classList.remove('border-transparent', 'text-gray-500');
                    
                    // Show/hide sections
                    const targetId = link.dataset.target;
                    sections.forEach(s => s.classList.add('hidden'));
                    const target = document.getElementById(targetId);
                    if (target) target.classList.remove('hidden');
                });
            });
            
            // Auto-click first tab
            const firstTab = links[0];
            if (firstTab) firstTab.click();
        }
        
        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new AppController();
        });
        
        // Make functions globally available
        window.wireTabs = wireTabs;
    </script>
    
    <script type="module">
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc }
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const auth = getAuth();
        const db = getFirestore();

        document.getElementById("loginBtn")?.addEventListener("click", async (e) => {
          e.preventDefault();
          const email = document.getElementById("loginEmail")?.value.trim();
          const password = document.getElementById("loginPassword")?.value.trim();

          if (!email || !password) {
            alert("Please enter both email and password");
            return;
          }

          try {
            // Show loading
            const loginBtn = document.getElementById("loginBtn");
            const originalText = loginBtn.textContent;
            loginBtn.textContent = "Logging in...";
            loginBtn.disabled = true;

            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const uid = userCredential.user.uid;

            // Fetch role from Firestore
            const docRef = doc(db, "users", uid);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
              const data = docSnap.data();
              if (data.role === "admin") {
                window.location.hash = "#/admin";
                // Store role for later use
                sessionStorage.setItem('userRole', 'admin');
              } else {
                window.location.hash = "#/member";
                // Store role for later use
                sessionStorage.setItem('userRole', 'member');
              }
            } else {
              alert("No role assigned. Contact admin.");
              await auth.signOut();
            }

            // Reset button
            loginBtn.textContent = originalText;
            loginBtn.disabled = false;

          } catch (error) {
            // Reset button
            const loginBtn = document.getElementById("loginBtn");
            loginBtn.textContent = "Login";
            loginBtn.disabled = false;
            
            alert("Login failed: " + error.message);
          }
        });

        onAuthStateChanged(auth, async (user) => {
          // user ଥିଲେ ଭ୍ୟୁ ଖୋଲନ୍ତୁ, ନହେଲେ login ଦେଖାନ୍ତୁ
          if (user) {
            // Check if we already have role in session
            const storedRole = sessionStorage.getItem('userRole');
            if (storedRole) {
              if (!location.hash) {
                location.hash = storedRole === 'admin' ? '#/admin' : '#/member';
              }
            } else {
              // Fetch role from Firestore if not in session
              try {
                const docRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                  const data = docSnap.data();
                  sessionStorage.setItem('userRole', data.role || 'member');
                  if (!location.hash) {
                    location.hash = data.role === 'admin' ? '#/admin' : '#/member';
                  }
                } else {
                  // Default to member if no role found
                  sessionStorage.setItem('userRole', 'member');
                  if (!location.hash) location.hash = '#/member';
                }
              } catch (error) {
                console.error('Error fetching user role:', error);
                // Default to member on error
                sessionStorage.setItem('userRole', 'member');
                if (!location.hash) location.hash = '#/member';
              }
            }
          } else {
            // Clear stored role on logout
            sessionStorage.removeItem('userRole');
          }
        });
    </script>
    
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const memberTab = document.getElementById('memberTab');
        const adminTab = document.getElementById('adminTab');
        const roleInput = document.getElementById('currentRole');

        memberTab?.addEventListener('click', () => {
          if (roleInput) roleInput.value = 'member';
          memberTab.className = 'px-3 py-2 rounded bg-blue-600 text-white cursor-pointer';
          adminTab.className = 'px-3 py-2 rounded bg-gray-200 cursor-pointer';
        });

        adminTab?.addEventListener('click', () => {
          if (roleInput) roleInput.value = 'admin';
          adminTab.className = 'px-3 py-2 rounded bg-purple-600 text-white cursor-pointer';
          memberTab.className = 'px-3 py-2 rounded bg-gray-200 cursor-pointer';
        });
      });
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden;
        }
        
        .gradient-bg {
               class AppController {
            constructor() {
                this.currentUser = null;
                this.accounts = [];
                this.transactions = [];
                this.isOnline = navigator.onLine;
                this.init();
            }
            
            async init() {
                this.setupNetworkListeners();
                this.setupAuthListener();
                this.setupEventListeners();
                this.showLoginView();
            }
            
            setupNetworkListeners() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.showToast('Back online! Syncing data...', 'success');
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.showToast('You are offline. Changes will be saved locally.', 'warning');
                });
            }
            
            setupAuthListener() {
                onAuthStateChanged(auth, (user) => {
                    this.currentUser = user;
                    if (user) {
                        this.handleSuccessfulLogin();
                    } else {
                        this.handleLogout();
                    }
                });
            }
            
            setupEventListeners() {
                // Login form
                document.getElementById('loginForm')?.addEventListener('submit', (e) => this.handleLogin(e));
                
                // Logout button
                document.getElementById('logoutBtn')?.addEventListener('click', () => this.logout());
            }
            
            async handleLogin(e) {
                e.preventDefault();
                const form = e.target;
                const email = form.querySelector('input[type="email"]').value.trim();
                const password = form.querySelector('input[type="password"]').value;
                
                if (!email || !password) {
                    this.showToast('Please enter email and password', 'error');
                    return;
                }
                
                try {
                    this.showLoading(true);
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    this.showToast(error.message || 'Login failed', 'error');
                } finally {
                    this.showLoading(false);
                }
            }
            
            async handleSuccessfulLogin() {
                try {
                    this.showLoading(true);
                    await this.loadData();
                    this.showAppView();
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.showToast('Error loading data. Working in offline mode.', 'warning');
                    this.showAppView();
                } finally {
                    this.showLoading(false);
                }
            }
            
            handleLogout() {
                this.currentUser = null;
                this.accounts = [];
                this.transactions = [];
                this.showLoginView();
            }
            
            async logout() {
                try {
                    await signOut(auth);
                    this.showToast('Logged out successfully', 'success');
                } catch (error) {
                    console.error('Logout error:', error);
                }
            }
            
            showLoginView() {
                document.getElementById('loginView').classList.remove('hidden');
                document.getElementById('appView').classList.add('hidden');
            }
            
            showAppView() {
                document.getElementById('loginView').classList.add('hidden');
                document.getElementById('appView').classList.remove('hidden');
                wireTabs('#mainNav');
                this.updateDashboard();
            }
            
            async loadData() {
                if (this.isOnline) {
                    await this.loadFromFirebase();
                } else {
                    this.loadFromLocal();
                }
            }
            
            async loadFromFirebase() {
                try {
                    // Load accounts
                    const accountsQuery = query(collection(db, 'accounts'), orderBy('createdAt', 'desc'));
                    const accountsSnapshot = await getDocs(accountsQuery);
                    this.accounts = accountsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Load transactions
                    const transactionsQuery = query(collection(db, 'transactions'), orderBy('createdAt', 'desc'));
                    const transactionsSnapshot = await getDocs(transactionsQuery);
                    this.transactions = transactionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Save to local storage as backup
                    localStorage.setItem('accounts', JSON.stringify(this.accounts));
                    localStorage.setItem('transactions', JSON.stringify(this.transactions));
                    
                } catch (error) {
                    console.error('Firebase load error:', error);
                    throw error;
                }
            }
            
            loadFromLocal() {
                try {
                    this.accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                    this.transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
                } catch (error) {
                    console.error('Local storage load error:', error);
                    this.accounts = [];
                    this.transactions = [];
                }
            }
            
            updateDashboard() {
                const totalCredit = this.transactions.filter(t => t.type === 'credit').reduce((sum, t) => sum + t.amount, 0);
                const totalDebit = this.transactions.filter(t => t.type === 'debit').reduce((sum, t) => sum + t.amount, 0);
                const netBalance = totalCredit - totalDebit;
                
                document.getElementById('totalCredit').textContent = `₹${totalCredit.toFixed(2)}`;
                document.getElementById('totalDebit').textContent = `₹${totalDebit.toFixed(2)}`;
                document.getElementById('totalAccounts').textContent = this.accounts.length;
                
                const netBalanceEl = document.getElementById('netBalance');
                netBalanceEl.textContent = `₹${netBalance.toFixed(2)}`;
                netBalanceEl.className = `text-lg sm:text-2xl font-bold ${netBalance >= 0 ? 'text-green-600' : 'text-red-600'}`;
                
                this.updateRecentTransactions();
            }
            
            updateRecentTransactions() {
                const container = document.getElementById('recentTransactions');
                if (!container) return;
                
                const recentTx = this.transactions.slice(0, 5);
                
                if (recentTx.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">No transactions yet. Add your first transaction!</p>';
                    return;
                }
                
                container.innerHTML = recentTx.map(tx => {
                    const account = this.accounts.find(acc => acc.id === tx.accountId);
                    return `
                        <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg ${tx.type === 'credit' ? 'border-l-4 border-l-green-500' : 'border-l-4 border-l-red-500'}">
                            <div class="flex-1">
                                <p class="font-medium text-gray-900">${account ? account.name : 'Account'}</p>
                                <p class="text-sm text-gray-600">${tx.description || 'No description'}</p>
                                <p class="text-xs text-gray-500">${new Date(tx.date).toLocaleDateString()}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold ${tx.type === 'credit' ? 'text-green-600' : 'text-red-600'}">
                                    ${tx.type === 'credit' ? '+' : '-'}₹${tx.amount.toFixed(2)}
                                </p>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            showLoading(show) {
                const loader = document.getElementById('loadingIndicator');
                if (loader) {
                    loader.classList.toggle('hidden', !show);
                }
            }
            
            showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                const messageEl = document.getElementById('toastMessage');
                
                if (!toast || !messageEl) return;
                
                messageEl.textContent = message;
                
                // Set color based on type
                toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2 ${
                    type === 'success' ? 'bg-green-500 text-white' :
                    type === 'error' ? 'bg-red-500 text-white' :
                    type === 'warning' ? 'bg-yellow-500 text-white' :
                    'bg-blue-500 text-white'
                }`;
                
                toast.classList.remove('hidden');
                
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 3000);
            }
        }
        
        // Tab Navigation System
        function wireTabs(scopeSel) {
            const scope = document.querySelector(scopeSel);
            if (!scope) return;
            
            const links = scope.querySelectorAll('.tab-link');
            const sections = document.querySelectorAll('.tab-section');
            
            links.forEach(link => {
                link.addEventListener('click', (ev) => {
                    ev.preventDefault();
                    
                    // Update active state
                    links.forEach(l => {
                        l.classList.remove('active', 'border-blue-500', 'text-blue-600');
                        l.classList.add('border-transparent', 'text-gray-500');
                    });
                    link.classList.add('active', 'border-blue-500', 'text-blue-600');
                    link.classList.remove('border-transparent', 'text-gray-500');
                    
                    // Show/hide sections
                    const targetId = link.dataset.target;
                    sections.forEach(s => s.classList.add('hidden'));
                    const target = document.getElementById(targetId);
                    if (target) target.classList.remove('hidden');
                });
            });
            
            // Auto-click first tab
            const firstTab = links[0];
            if (firstTab) firstTab.click();
        }
        
        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new AppController();
        });
        
        // Make functions globally available
        window.wireTabs = wireTabs;
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .tab-link { 
            padding: 8px 10px; 
            display: inline-block; 
            text-decoration: none;
            transition: all 0.2s ease;
        }
        
        .tab-link.active { 
            border-bottom: 2px solid #2563eb; 
            font-weight: 600;
        }
        
        .hidden { display: none !important; }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse-loader {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @media (max-width: 640px) {
            .nav-btn {
                font-size: 10px !important;
                padding: 8px 2px !important;
                word-break: break-word;
                line-height: 1.2;
            }
            
            table { font-size: 10px !important; }
        }
        
        @media print {
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">

    <!-- LOGIN VIEW -->
    <section id="loginView">
        <div class="max-w-md mx-auto p-6 mt-20">
            <div class="glass-card rounded-xl p-8 shadow-2xl fade-in">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Deulasahi Bazar Committee</h1>
                    <p class="text-gray-600">Professional Accounting System</p>
                </div>
                
                <form id="loginForm" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                        <input type="email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter your email" autocomplete="username">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter your password" autocomplete="current-password">
                    </div>
                    
                    <button type="submit" class="w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors font-semibold">
                        Login
                    </button>
                </form>
            </div>
        </div>
    </section>

    <!-- APP VIEW -->
    <section id="appView" class="hidden">
        <!-- Header -->
        <header class="gradient-bg text-white shadow-lg no-print">
            <div class="max-w-7xl mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div class="text-center flex-1">
                        <h1 class="text-3xl font-bold">Deulasahi Bazar Committee</h1>
                        <p class="text-blue-100 mt-2">Professional Accounting System</p>
                    </div>
                    <button id="logoutBtn" class="px-4 py-2 bg-white bg-opacity-20 text-white rounded-lg hover:bg-opacity-30 transition-colors">
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav id="mainNav" class="bg-white shadow-sm border-b no-print">
            <div class="max-w-7xl mx-auto px-1">
                <div class="flex">
                    <a href="#" class="tab-link active nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-blue-500 text-blue-600 text-center" data-target="dashboard">Dashboard</a>
                    <a href="#" class="tab-link nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center" data-target="accounts">Accounts</a>
                    <a href="#" class="tab-link nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center" data-target="transactions">Transactions</a>
                    <a href="#" class="tab-link nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center" data-target="reports">Reports</a>
                </div>
            </div>
        </nav>

        <!-- Content -->
        <main class="max-w-7xl mx-auto px-2 sm:px-4 py-4 sm:py-6">
            <!-- Dashboard -->
            <section id="dashboard" class="tab-section">
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-6 mb-6 sm:mb-8">
                    <div class="glass-card rounded-lg sm:rounded-xl p-3 sm:p-6 shadow-lg">
                        <div class="flex flex-col sm:flex-row sm:items-center">
                            <div class="p-2 sm:p-3 rounded-full bg-green-1        })();
        
        // Make Firebase available globally
        window.db = db;
        window.auth = auth;
        window.firestore = { collection, addDoc, getDocs, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, serverTimestamp, where, limit };
        
        // helpers
        const views = {
            choose: document.getElementById('roleView'),
            memberLogin: document.getElementById('memberLoginView'),
            adminLogin: document.getElementById('adminLoginView'),
            memberApp: document.getElementById('memberAppView'),
            adminApp: document.getElementById('adminAppView'),
        };
        
        function showOnly(v){
            Object.values(views).forEach(el => el && (el.style.display='none'));
            v && (v.style.display='block');
        }
        
        function removeOverlays(){
            document.querySelectorAll('.overlay,.loader,.modal-backdrop,#loadingOverlay')
                .forEach(el => el.remove());
            document.body.style.pointerEvents = 'auto';
        }

        // choose role buttons
        document.getElementById('chooseMemberBtn')?.addEventListener('click', ()=>{
            localStorage.setItem('role','member');
            showOnly(views.memberLogin);
        });
        document.getElementById('chooseAdminBtn')?.addEventListener('click', ()=>{
            localStorage.setItem('role','admin');
            showOnly(views.adminLogin);
        });

        // login buttons
        document.getElementById('memberLoginBtn')?.addEventListener('click', async (e)=>{
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim();
            const pass  = document.getElementById('loginPassword').value;
            if(!email || !pass){ alert("Enter email & password"); return; }
            try{
                await signInWithEmailAndPassword(auth, email, pass);
                alert("Login successful!");
                // UI will switch in onAuthStateChanged below
            }catch(err){ alert(err.message || "Login failed"); }
        });

        document.getElementById('adminLoginBtn')?.addEventListener('click', async (e)=>{
            e.preventDefault();
            const email = document.getElementById('adminEmail').value.trim();
            const pass  = document.getElementById('adminPassword').value;
            if(!email || !pass){ alert("Enter email & password"); return; }
            try{
                await signInWithEmailAndPassword(auth, email, pass);
                alert("Login successful!");
            }catch(err){ alert(err.message || "Login failed"); }
        });

        // after-auth UI switch
        onAuthStateChanged(auth, (user)=>{
            removeOverlays();
            if(!user){
                showOnly(views.choose);
                return;
            }
            const role = localStorage.getItem('role') || 'member';
            if(role === 'admin'){
                showOnly(views.adminApp);
                window.initializeAppUI?.();
            }else{
                showOnly(views.memberApp);
                afterMemberUIShown?.();
                window.loadMemberData?.();
            }
        });

        // logout handlers
        async function doLogout(){
            await signOut(auth);
            localStorage.removeItem('role');
            alert('Logged out successfully');
        }
        
        document.getElementById('logoutBtn')?.addEventListener('click', doLogout);
        document.getElementById('logoutBtn2')?.addEventListener('click', doLogout);
        document.getElementById('logoutMember')?.addEventListener('click', doLogout);
        document.getElementById('logoutAdmin')?.addEventListener('click', doLogout);
        
        // Go back to role selection
        window.goBackToRoleSelect = () => {
            localStorage.removeItem('role');
            showOnly(views.choose);
        };
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden;
            max-width: 100vw;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .balance-positive { color: #059669; }
        .balance-negative { color: #dc2626; }
        .transaction-debit { border-left: 4px solid #dc2626; }
        .transaction-credit { border-left: 4px solid #059669; }
        
        /* Tab Navigation Styles */
        .hidden { display: none; }
        .tab-link { 
            padding: 8px 10px; 
            display: inline-block; 
            text-decoration: none;
        }
        .tab-link.active { 
            border-bottom: 2px solid #2563eb; 
            font-weight: 600;
        }
        
        /* Mobile specific styles */
        @media (max-width: 640px) {
            * {
                box-sizing: border-box;
            }
            
            .nav-btn {
                font-size: 10px !important;
                padding: 8px 2px !important;
                word-break: break-word;
                line-height: 1.2;
            }
            
            table {
                font-size: 10px !important;
            }
            
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
            }
        }
        
        @media print {
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">

    <!-- Role chooser view -->
    <div id="roleView" class="max-w-md mx-auto p-4" style="display:block">
        <h2 class="text-xl font-semibold mb-3">Choose Role</h2>
        <p class="text-gray-600 mb-4">ଦୟାକରି ଆପଣଙ୍କ ଭୂମିକା ବାଛନ୍ତୁ:</p>
        <div class="flex gap-3">
            <button id="chooseMemberBtn" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 transition-colors">Member / Staff</button>
            <button id="chooseAdminBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">Admin</button>
        </div>
    </div>

    <!-- Member Login view -->
    <div id="memberLoginView" class="max-w-md mx-auto p-4" style="display:none">
        <h2 class="text-xl font-semibold mb-3">Member Login</h2>

        <input id="loginEmail" type="email" placeholder="Email"
               class="w-full border p-2 rounded mb-2" autocomplete="username"/>

        <input id="loginPassword" type="password" placeholder="Password"
               class="w-full border p-2 rounded mb-3" autocomplete="current-password"/>

        <button id="memberLoginBtn" type="button"
                class="px-4 py-2 bg-blue-600 text-white rounded w-full hover:bg-blue-700 transition-colors">
            Login
        </button>

        <button onclick="goBackToRoleSelect()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded w-full mt-2 hover:bg-gray-400 transition-colors">Back</button>

        <div id="loginMsg" class="text-sm text-red-600 mt-2"></div>
    </div>

    <!-- Admin Login view -->
    <div id="adminLoginView" class="max-w-md mx-auto p-4" style="display:none">
        <h2 class="text-xl font-semibold mb-3">Admin Login</h2>

        <input id="adminEmail" type="email" placeholder="Email"
               class="w-full border p-2 rounded mb-2" autocomplete="username"/>

        <input id="adminPassword" type="password" placeholder="Password"
               class="w-full border p-2 rounded mb-3" autocomplete="current-password"/>

        <button id="adminLoginBtn" type="button"
                class="px-4 py-2 bg-blue-600 text-white rounded w-full hover:bg-blue-700 transition-colors">
            Login
        </button>

        <button onclick="goBackToRoleSelect()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded w-full mt-2 hover:bg-gray-400 transition-colors">Back</button>

        <div id="adminLoginMsg" class="text-sm text-red-600 mt-2"></div>
    </div>

    <!-- Member UI -->
    <section id="memberAppView" class="member-section hidden" style="display:none">
        <!-- Member Header -->
        <header class="gradient-bg text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div class="text-center flex-1">
                        <h1 class="text-3xl font-bold">Deulasahi Bazar Committee</h1>
                        <p class="text-blue-100 mt-2">Member Dashboard</p>
                    </div>
                    <button id="logoutBtn" type="button" class="px-3 py-1 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition-colors">Logout</button>
                </div>
            </div>
        </header>

        <!-- Member Navigation -->
        <nav id="memberNav" class="bg-white shadow-sm border-b no-print">
            <div class="max-w-7xl mx-auto px-1">
                <div class="flex">
                    <a href="#" class="tab-link active nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-blue-500 text-blue-600 text-center" data-target="secDashboard">Dashboard</a>
                    <a href="#" class="tab-link nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center" data-target="secMyAccount">My Account</a>
                    <a href="#" class="tab-link nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center" data-target="secTransactions">Transactions</a>
                    <a href="#" class="tab-link nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center" data-target="secStatements">Statements</a>
                </div>
            </div>
        </nav>

        <!-- Member Content -->
        <main class="max-w-7xl mx-auto px-2 sm:px-4 py-4 sm:py-6">
            <!-- Member Sections -->
            <section id="secDashboard" class="tab-section">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="glass-card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Account Status</p>
                                <p class="text-2xl font-bold text-blue-600 status">Active</p>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Current Balance</p>
                                <p class="text-2xl font-bold balance">₹0.00</p>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-100">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Transactions</p>
                                <p class="text-2xl font-bold text-purple-600 txCount">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="glass-card rounded-xl shadow-lg recent">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Recent Activity</h3>
                    </div>
                    <div class="p-6">
                        <div id="memberRecentActivity" class="space-y-4">
                            <p class="text-gray-500 text-center py-8">No recent activity</p>
                        </div>
                    </div>
                </div>
                
                <!-- Member Content Container -->
                <div id="memberContent"></div>
            </section>

            <!-- Member Account Info -->
            <section id="secMyAccount" class="tab-section hidden">
                <div class="glass-card rounded-xl shadow-lg">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Account Information</h3>
                    </div>
                    <div class="p-6">
                        <div id="memberAccountInfo" class="space-y-4">
                            <p class="text-gray-500 text-center py-8">Loading account information...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Member Transactions -->
            <section id="secTransactions" class="tab-section hidden">
                <div class="glass-card rounded-xl shadow-lg">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">My Transactions</h3>
                            <select id="memberTransactionFilter" class="mt-4 sm:mt-0 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="all">All Transactions</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                            </select>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="memberTransactionList" class="space-y-3">
                            <p class="text-gray-500 text-center py-8">No transactions found</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Member Statements -->
            <section id="secStatements" class="tab-section hidden">
                <div class="glass-card rounded-xl shadow-lg">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">Account Statement</h3>
                            <div class="mt-4 sm:mt-0 flex gap-2">
                                <select id="memberStatementPeriod" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="month">This Month</option>
                                    <option value="quarter">This Quarter</option>
                                    <option value="6months">Last 6 Months</option>
                                    <option value="year">This Year</option>
                                    <option value="all">All Time</option>
                                </select>
                                <button onclick="generateMemberStatement()" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                                    Generate
                                </button>
                                <button onclick="downloadMemberPDF()" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                                    PDF
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="memberStatementContent">
                            <p class="text-gray-500 text-center py-8">Click Generate to view your statement</p>
                        </div>
                    </div>
            })();
        
        // Make Firebase available globally
        window.db = db;
        window.auth = auth;
        window.firestore = { collection, addDoc, getDocs, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, serverTimestamp, where, limit };
        
        // helpers
        const views = {
            choose: document.getElementById('roleView'),
            memberLogin: document.getElementById('memberLoginView'),
            adminLogin: document.getElementById('adminLoginView'),
            memberApp: document.getElementById('memberAppView'),
            adminApp: document.getElementById('adminAppView'),
        };
        
        function showOnly(v){
            Object.values(views).forEach(el => el && (el.style.display='none'));
            v && (v.style.display='block');
        }
        
        function removeOverlays(){
            document.querySelectorAll('.overlay,.loader,.modal-backdrop,#loadingOverlay')
                .forEach(el => el.remove());
            document.body.style.pointerEvents = 'auto';
        }

        // choose role buttons
        document.getElementById('chooseMemberBtn')?.addEventListener('click', ()=>{
            localStorage.setItem('role','member');
            showOnly(views.memberLogin);
        });
        document.getElementById('chooseAdminBtn')?.addEventListener('click', ()=>{
            localStorage.setItem('role','admin');
            showOnly(views.adminLogin);
        });

        // login buttons
        document.getElementById('memberLoginBtn')?.addEventListener('click', async (e)=>{
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim();
            const pass  = document.getElementById('loginPassword').value;
            if(!email || !pass){ alert("Enter email & password"); return; }
            try{
                await signInWithEmailAndPassword(auth, email, pass);
                alert("Login successful!");
                // UI will switch in onAuthStateChanged below
            }catch(err){ alert(err.message || "Login failed"); }
        });

        document.getElementById('adminLoginBtn')?.addEventListener('click', async (e)=>{
            e.preventDefault();
            const email = document.getElementById('adminEmail').value.trim();
            const pass  = document.getElementById('adminPassword').value;
            if(!email || !pass){ alert("Enter email & password"); return; }
            try{
                await signInWithEmailAndPassword(auth, email, pass);
                alert("Login successful!");
            }catch(err){ alert(err.message || "Login failed"); }
        });

        // after-auth UI switch
        onAuthStateChanged(auth, (user)=>{
            removeOverlays();
            if(!user){
                showOnly(views.choose);
                return;
            }
            const role = localStorage.getItem('role') || 'member';
            if(role === 'admin'){
                showOnly(views.adminApp);
                window.initializeAppUI?.();
            }else{
                showOnly(views.memberApp);
                afterMemberUIShown?.();
                window.loadMemberData?.();
            }
        });

        // logout handlers
        async function doLogout(){
            await signOut(auth);
            localStorage.removeItem('role');
            alert('Logged out successfully');
        }
        
        document.getElementById('logoutBtn')?.addEventListener('click', doLogout);
        document.getElementById('logoutBtn2')?.addEventListener('click', doLogout);
        document.getElementById('logoutMember')?.addEventListener('click', doLogout);
        document.getElementById('logoutAdmin')?.addEventListener('click', doLogout);
        
        // Go back to role selection
        window.goBackToRoleSelect = () => {
            localStorage.removeItem('role');
            showOnly(views.choose);
        };
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden;
            max-width: 100vw;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .balance-positive { color: #059669; }
        .balance-negative { color: #dc2626; }
        .transaction-debit { border-left: 4px solid #dc2626; }
        .transaction-credit { border-left: 4px solid #059669; }
        
        /* Mobile specific styles */
        @media (max-width: 640px) {
            * {
                box-sizing: border-box;
            }
            
            .nav-btn {
                font-size: 10px !important;
                padding: 8px 2px !important;
                word-break: break-word;
                line-height: 1.2;
            }
            
            table {
                font-size: 10px !important;
            }
            
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
            }
        }
        
        @media print {
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">

    <!-- Role chooser view -->
    <div id="roleView" class="max-w-md mx-auto p-4" style="display:block">
        <h2 class="text-xl font-semibold mb-3">Choose Role</h2>
        <p class="text-gray-600 mb-4">ଦୟାକରି ଆପଣଙ୍କ ଭୂମିକା ବାଛନ୍ତୁ:</p>
        <div class="flex gap-3">
            <button id="chooseMemberBtn" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 transition-colors">Member / Staff</button>
            <button id="chooseAdminBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">Admin</button>
        </div>
    </div>

    <!-- Member Login view -->
    <div id="memberLoginView" class="max-w-md mx-auto p-4" style="display:none">
        <h2 class="text-xl font-semibold mb-3">Member Login</h2>

        <input id="loginEmail" type="email" placeholder="Email"
               class="w-full border p-2 rounded mb-2" autocomplete="username"/>

        <input id="loginPassword" type="password" placeholder="Password"
               class="w-full border p-2 rounded mb-3" autocomplete="current-password"/>

        <button id="memberLoginBtn" type="button"
                class="px-4 py-2 bg-blue-600 text-white rounded w-full hover:bg-blue-700 transition-colors">
            Login
        </button>

        <button onclick="goBackToRoleSelect()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded w-full mt-2 hover:bg-gray-400 transition-colors">Back</button>

        <div id="loginMsg" class="text-sm text-red-600 mt-2"></div>
    </div>

    <!-- Admin Login view -->
    <div id="adminLoginView" class="max-w-md mx-auto p-4" style="display:none">
        <h2 class="text-xl font-semibold mb-3">Admin Login</h2>

        <input id="adminEmail" type="email" placeholder="Email"
               class="w-full border p-2 rounded mb-2" autocomplete="username"/>

        <input id="adminPassword" type="password" placeholder="Password"
               class="w-full border p-2 rounded mb-3" autocomplete="current-password"/>

        <button id="adminLoginBtn" type="button"
                class="px-4 py-2 bg-blue-600 text-white rounded w-full hover:bg-blue-700 transition-colors">
            Login
        </button>

        <button onclick="goBackToRoleSelect()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded w-full mt-2 hover:bg-gray-400 transition-colors">Back</button>

        <div id="adminLoginMsg" class="text-sm text-red-600 mt-2"></div>
    </div>

    <!-- Member UI -->
    <section id="memberAppView" class="member-section" style="display:none">
        <!-- Member Header -->
        <header class="gradient-bg text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div class="text-center flex-1">
                        <h1 class="text-3xl font-bold">Deulasahi Bazar Committee</h1>
                        <p class="text-blue-100 mt-2">Member Dashboard</p>
                    </div>
                    <button id="logoutBtn" type="button" class="px-3 py-1 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition-colors">Logout</button>
                </div>
            </div>
        </header>

        <!-- Member Navigation -->
        <nav id="memberTabs" class="bg-white shadow-sm border-b no-print">
            <div class="max-w-7xl mx-auto px-1">
                <div class="flex">
                    <a href="#" data-section="dashboard" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-blue-500 text-blue-600 text-center">Dashboard</a>
                    <a href="#" data-section="account" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center">My Account</a>
                    <a href="#" data-section="transactions" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center">Transactions</a>
                    <a href="#" data-section="statements" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center">Statements</a>
                </div>
            </div>
        </nav>

        <!-- Member Content -->
        <main class="max-w-7xl mx-auto px-2 sm:px-4 py-4 sm:py-6">
            <!-- Member Dashboard -->
            <section id="section-dashboard" class="member-section">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="glass-card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Account Status</p>
                                <p class="text-2xl font-bold text-blue-600 status">Active</p>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Current Balance</p>
                                <p class="text-2xl font-bold balance">₹0.00</p>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-100">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Transactions</p>
                                <p class="text-2xl font-bold text-purple-600 txCount">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="glass-card rounded-xl shadow-lg recent">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Recent Activity</h3>
                    </div>
                    <div class="p-6">
                        <div id="memberRecentActivity" class="space-y-4">
                            <p class="text-gray-500 text-center py-8">No recent activity</p>
                        </div>
                    </div>
                </div>
                
                <!-- Member Content Container -->
                <div id="memberContent"></div>
            </section>

            <!-- Member Account Info -->
            <section id="section-account" class="member-section" style="display:none">
                <div class="glass-card rounded-xl shadow-lg">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Account Information</h3>
                    </div>
                    <div class="p-6">
                        <div id="memberAccountInfo" class="space-y-4">
                            <p class="text-gray-500 text-center py-8">Loading account information...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Member Transactions -->
            <section id="section-transactions" class="member-section" style="display:none">
                <div class="glass-card rounded-xl shadow-lg">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">My Transactions</h3>
                            <select id="memberTransactionFilter" class="mt-4 sm:mt-0 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="all">All Transactions</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                            </select>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="memberTransactionList" class="space-y-3">
                            <p class="text-gray-500 text-center py-8">No transactions found</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Member Statements -->
            <section id="section-statements" class="member-section" style="display:none">
                <div class="glass-card rounded-xl shadow-lg">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">Account Statement</h3>
                            <div class="mt-4 sm:mt-0 flex gap-2">
                                <select id="memberStatementPeriod" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="month">This Month</option>
                                    <option value="quarter">This Quarter</option>
                                    <option value="6months">Last 6 Months</option>
                                    <option value="year">This Year</option>
                                    <option value="all">All Time</option>
                                </select>
                                <button onclick="generateMemberStatement()" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                                    Generate
                                </button>
                                <button onclick="downloadMemberPDF()" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                                    PDF
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="memberStatementContent">
                            <p class="text-gray-500 text-center py-8">Click Generate to view your statement</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </section>

    <!-- Admin UI -->
    <section id="adminAppView" style="display:none">
        <!-- App Area (ପୁରା ଆପ୍ କନ୍ଟେନ୍ଟ)—ଏଠି ଆପଣଙ୍କ ବର୍ତ୍ତମାନ main/app div କୁ ରାପ୍ କରନ୍ତୁ -->
        <div id="appArea">
        <!-- Header -->
        <header clas        
        // Make Firebase available globally
        window.db = db;
        window.auth = auth;
        window.firestore = { collection, addDoc, getDocs, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, serverTimestamp, where, limit };
        
        // helpers
        const views = {
            choose: document.getElementById('roleView'),
            memberLogin: document.getElementById('memberLoginView'),
            adminLogin: document.getElementById('adminLoginView'),
            memberApp: document.getElementById('memberAppView'),
            adminApp: document.getElementById('adminAppView'),
        };
        
        function showOnly(v){
            Object.values(views).forEach(el => el && (el.style.display='none'));
            v && (v.style.display='block');
        }
        
        function removeOverlays(){
            document.querySelectorAll('.overlay,.loader,.modal-backdrop,#loadingOverlay')
                .forEach(el => el.remove());
            document.body.style.pointerEvents = 'auto';
        }

        // choose role buttons
        document.getElementById('chooseMemberBtn')?.addEventListener('click', ()=>{
            localStorage.setItem('role','member');
            showOnly(views.memberLogin);
        });
        document.getElementById('chooseAdminBtn')?.addEventListener('click', ()=>{
            localStorage.setItem('role','admin');
            showOnly(views.adminLogin);
        });

        // login buttons
        document.getElementById('memberLoginBtn')?.addEventListener('click', async (e)=>{
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim();
            const pass  = document.getElementById('loginPassword').value;
            if(!email || !pass){ alert("Enter email & password"); return; }
            try{
                await signInWithEmailAndPassword(auth, email, pass);
                alert("Login successful!");
                // UI will switch in onAuthStateChanged below
            }catch(err){ alert(err.message || "Login failed"); }
        });

        document.getElementById('adminLoginBtn')?.addEventListener('click', async (e)=>{
            e.preventDefault();
            const email = document.getElementById('adminEmail').value.trim();
            const pass  = document.getElementById('adminPassword').value;
            if(!email || !pass){ alert("Enter email & password"); return; }
            try{
                await signInWithEmailAndPassword(auth, email, pass);
                alert("Login successful!");
            }catch(err){ alert(err.message || "Login failed"); }
        });

        // after-auth UI switch
        onAuthStateChanged(auth, (user)=>{
            removeOverlays();
            if(!user){
                showOnly(views.choose);
                return;
            }
            const role = localStorage.getItem('role') || 'member';
            if(role === 'admin'){
                showOnly(views.adminApp);
                window.initializeAppUI?.();
            }else{
                showOnly(views.memberApp);
                afterMemberUIShown?.();
                window.loadMemberData?.();
            }
        });

        // logout
        document.getElementById('logoutBtn')?.addEventListener('click', async ()=>{
            await signOut(auth);
            localStorage.removeItem('role');
        });
        document.getElementById('logoutBtn2')?.addEventListener('click', async ()=>{
            await signOut(auth);
            localStorage.removeItem('role');
        });
        
        // Go back to role selection
        window.goBackToRoleSelect = () => {
            localStorage.removeItem('role');
            showOnly(views.choose);
        };
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden;
            max-width: 100vw;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .balance-positive { color: #059669; }
        .balance-negative { color: #dc2626; }
        .transaction-debit { border-left: 4px solid #dc2626; }
        .transaction-credit { border-left: 4px solid #059669; }
        
        /* Mobile specific styles */
        @media (max-width: 640px) {
            * {
                box-sizing: border-box;
            }
            
            .nav-btn {
                font-size: 10px !important;
                padding: 8px 2px !important;
                word-break: break-word;
                line-height: 1.2;
            }
            
            table {
                font-size: 10px !important;
            }
            
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
            }
        }
        
        @media print {
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">

    <!-- Role chooser view -->
    <div id="roleView" class="max-w-md mx-auto p-4" style="display:block">
        <h2 class="text-xl font-semibold mb-3">Choose Role</h2>
        <p class="text-gray-600 mb-4">ଦୟାକରି ଆପଣଙ୍କ ଭୂମିକା ବାଛନ୍ତୁ:</p>
        <div class="flex gap-3">
            <button id="chooseMemberBtn" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 transition-colors">Member / Staff</button>
            <button id="chooseAdminBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">Admin</button>
        </div>
    </div>

    <!-- Member Login view -->
    <div id="memberLoginView" class="max-w-md mx-auto p-4" style="display:none">
        <h2 class="text-xl font-semibold mb-3">Member Login</h2>

        <input id="loginEmail" type="email" placeholder="Email"
               class="w-full border p-2 rounded mb-2" autocomplete="username"/>

        <input id="loginPassword" type="password" placeholder="Password"
               class="w-full border p-2 rounded mb-3" autocomplete="current-password"/>

        <button id="memberLoginBtn" type="button"
                class="px-4 py-2 bg-blue-600 text-white rounded w-full hover:bg-blue-700 transition-colors">
            Login
        </button>

        <button onclick="goBackToRoleSelect()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded w-full mt-2 hover:bg-gray-400 transition-colors">Back</button>

        <div id="loginMsg" class="text-sm text-red-600 mt-2"></div>
    </div>

    <!-- Admin Login view -->
    <div id="adminLoginView" class="max-w-md mx-auto p-4" style="display:none">
        <h2 class="text-xl font-semibold mb-3">Admin Login</h2>

        <input id="adminEmail" type="email" placeholder="Email"
               class="w-full border p-2 rounded mb-2" autocomplete="username"/>

        <input id="adminPassword" type="password" placeholder="Password"
               class="w-full border p-2 rounded mb-3" autocomplete="current-password"/>

        <button id="adminLoginBtn" type="button"
                class="px-4 py-2 bg-blue-600 text-white rounded w-full hover:bg-blue-700 transition-colors">
            Login
        </button>

        <button onclick="goBackToRoleSelect()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded w-full mt-2 hover:bg-gray-400 transition-colors">Back</button>

        <div id="adminLoginMsg" class="text-sm text-red-600 mt-2"></div>
    </div>

    <!-- Member UI -->
    <section id="memberAppView" class="member-section" style="display:none">
        <!-- Member Header -->
        <header class="gradient-bg text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div class="text-center flex-1">
                        <h1 class="text-3xl font-bold">Deulasahi Bazar Committee</h1>
                        <p class="text-blue-100 mt-2">Member Dashboard</p>
                    </div>
                    <button id="logoutBtn" type="button" class="hidden sm:inline px-3 py-1 bg-gray-200 text-gray-800 rounded">Logout</button>
                </div>
            </div>
        </header>

        <!-- Member Navigation -->
        <nav id="memberTabs" class="bg-white shadow-sm border-b no-print">
            <div class="max-w-7xl mx-auto px-1">
                <div class="flex">
                    <a href="#" data-section="dashboard" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-blue-500 text-blue-600 text-center">Dashboard</a>
                    <a href="#" data-section="account" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center">My Account</a>
                    <a href="#" data-section="transactions" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center">Transactions</a>
                    <a href="#" data-section="statements" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center">Statements</a>
                </div>
            </div>
        </nav>

        <!-- Member Content -->
        <main class="max-w-7xl mx-auto px-2 sm:px-4 py-4 sm:py-6">
            <!-- Member Dashboard -->
            <section id="section-dashboard" class="member-section">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="glass-card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Account Status</p>
                                <p class="text-2xl font-bold text-blue-600 status">Active</p>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Current Balance</p>
                                <p class="text-2xl font-bold balance">₹0.00</p>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-100">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Transactions</p>
                                <p class="text-2xl font-bold text-purple-600 txCount">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="glass-card rounded-xl shadow-lg recent">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Recent Activity</h3>
                    </div>
                    <div class="p-6">
                        <div id="memberRecentActivity" class="space-y-4">
                            <p class="text-gray-500 text-center py-8">No recent activity</p>
                        </div>
                    </div>
                </div>
                
                <!-- Member Content Container -->
                <div id="memberContent"></div>
            </section>

            <!-- Member Account Info -->
            <section id="section-account" class="member-section" style="display:none">
                <div class="glass-card rounded-xl shadow-lg">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Account Information</h3>
                    </div>
                    <div class="p-6">
                        <div id="memberAccountInfo" class="space-y-4">
                            <p class="text-gray-500 text-center py-8">Loading account information...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Member Transactions -->
            <section id="section-transactions" class="member-section" style="display:none">
                <div class="glass-card rounded-xl shadow-lg">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">My Transactions</h3>
                            <select id="memberTransactionFilter" class="mt-4 sm:mt-0 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="all">All Transactions</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                            </select>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="memberTransactionList" class="space-y-3">
                            <p class="text-gray-500 text-center py-8">No transactions found</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Member Statements -->
            <section id="section-statements" class="member-section" style="display:none">
                <div class="glass-card rounded-xl shadow-lg">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">Account Statement</h3>
                            <div class="mt-4 sm:mt-0 flex gap-2">
                                <select id="memberStatementPeriod" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="month">This Month</option>
                                    <option value="quarter">This Quarter</option>
                                    <option value="6months">Last 6 Months</option>
                                    <option value="year">This Year</option>
                                    <option value="all">All Time</option>
                                </select>
                                <button onclick="generateMemberStatement()" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                                    Generate
                                </button>
                                <button onclick="downloadMemberPDF()" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                                    PDF
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="memberStatementContent">
                            <p class="text-gray-500 text-center py-8">Click Generate to view your statement</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </section>

    <!-- Admin UI -->
    <section id="adminAppView" style="display:none">
        <!-- App Area (ପୁରା ଆପ୍ କନ୍ଟେନ୍ଟ)—ଏଠି ଆପଣଙ୍କ ବର୍ତ୍ତମାନ main/app div କୁ ରାପ୍ କରନ୍ତୁ -->
        <div id="appArea">
        <!-- Header -->
        <header class="gradient-bg text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="flex justify-between items-center">
                <div class="text-center flex-1">
                    <h1 class="text-3xl font-bold">Deulasahi Bazar Committee</h1>
                    <p class="text-blue-100 mt-2">Deulasahi Road, Tulsipur, Cuttack</p>
         
        // Make Firebase available globally
        window.db = db;
        window.auth = auth;
        window.firestore = { collection, addDoc, getDocs, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, serverTimestamp, where, limit };
        
        // Global variable to track selected role
        window.chosenRole = null;
        
        // UI show/hide by login state
        onAuthStateChanged(auth, async (user) => {
            const roleSel = document.getElementById('roleSelect');
            const login   = document.getElementById('loginArea');
            const adminUI = document.getElementById('adminUI');
            const memberUI= document.getElementById('memberUI');

            // ସବୁ UI ପ୍ରଥମେ ଲୁଚାଅ
            adminUI.style.display  = 'none';
            memberUI.style.display = 'none';

            if (!user) {
                // 🔒 Login ନାହିଁ → ମାତ୍ର Role + Login
                roleSel.style.display = 'block';
                login.style.display   = 'block';
                return; // ⚠️ ଏଠାରେ କେବେ data load କରିବେ ନାହିଁ
            }

            // Clear any stuck overlays when user logs in
            removeOverlays();

            // Logged in → role ଚୟନ ନହେଲେ Role screen ଦେଖାଅ
            roleSel.style.display = 'none';
            login.style.display   = 'none';

            if (window.chosenRole === 'admin') {
                adminUI.style.display = 'block';
                window.initializeAppUI?.();   // admin data listeners
            } else if (window.chosenRole === 'member') {
                memberUI.style.display = 'block';
                afterMemberUIShown?.();       // member UI setup
                window.loadMemberData?.();    // member ଡାଟା
            } else {
                roleSel.style.display = 'block';
            }
        });
        
        // ---------------- Login Handler (clean module approach) ----------------
        document.getElementById('loginBtn')?.addEventListener('click', async () => {
            const emailEl = document.getElementById('loginEmail');
            const passEl = document.getElementById('loginPassword');
            const btnEl = document.getElementById('loginBtn');
            const msgEl = document.getElementById('loginMsg');
            
            if (!emailEl || !passEl || !btnEl || !msgEl) return;
            
            msgEl.textContent = '';
            const email = (emailEl.value || '').trim();
            const pass = passEl.value || '';

            if (!email || !pass) {
                msgEl.textContent = 'Please enter email & password.';
                return;
            }
            
            try {
                btnEl.disabled = true;
                btnEl.textContent = 'Logging in...';
                
                await signInWithEmailAndPassword(auth, email, pass);
                alert('Login successful!');
                // onAuthStateChanged will handle the rest
            } catch (error) {
                console.error('Login error:', error);
                msgEl.textContent = error.message || 'Login failed';
            } finally {
                btnEl.disabled = false;
                btnEl.textContent = 'Login';
            }
        });
        // -----------------------------------------------------
        
        // Logout handler
        window.handleLogout = () => {
            window.chosenRole = null;
            signOut(auth).then(() => {
                alert('Logged out successfully!');
            }).catch((e) => {
                console.error('Logout error:', e);
                alert('Logout failed: ' + (e.message || 'Unknown error'));
            });
        };

        // Add logout button event listeners after DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            // Member logout button
            const memberLogoutBtn = document.getElementById('memberLogoutBtn');
            if (memberLogoutBtn) {
                memberLogoutBtn.addEventListener('click', () => {
                    window.chosenRole = null;
                    signOut(auth);
                });
            }
            
            // Admin logout button
            const adminLogoutBtn = document.getElementById('adminLogoutBtn');
            if (adminLogoutBtn) {
                adminLogoutBtn.addEventListener('click', () => {
                    window.chosenRole = null;
                    signOut(auth);
                });
            }
        });
        
        // Role selection utilities
        window.chosenRole = null;

        function show(el){ el.style.display = 'block'; }
        function hide(el){ el.style.display = 'none'; }

        function bindRoleButtons(){
          const roleSel = document.getElementById('roleSelect');
          const login   = document.getElementById('loginArea');
          const title   = document.getElementById('loginTitle');

          const memberBtn = document.getElementById('btnMember');
          const adminBtn  = document.getElementById('btnAdmin');

          memberBtn?.addEventListener('click', () => {
            window.chosenRole = 'member';
            title.textContent = 'Member Login';
            hide(roleSel); show(login);
          });

          adminBtn?.addEventListener('click', () => {
            window.chosenRole = 'admin';
            title.textContent = 'Admin Login';
            hide(roleSel); show(login);
          });
        }

        // DOM ଲୋଡ୍ ହେଲେ ମାତ୍ର bind କରାଯିବ
        document.addEventListener('DOMContentLoaded', bindRoleButtons);
        
        // Go back to role selection
        window.goBackToRoleSelect = () => {
            window.chosenRole = null;
            const roleSel = document.getElementById('roleSelect');
            const login = document.getElementById('loginArea');
            hide(login); show(roleSel);
        };
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden;
            max-width: 100vw;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .balance-positive { color: #059669; }
        .balance-negative { color: #dc2626; }
        .transaction-debit { border-left: 4px solid #dc2626; }
        .transaction-credit { border-left: 4px solid #059669; }
        
        /* Mobile specific styles */
        @media (max-width: 640px) {
            * {
                box-sizing: border-box;
            }
            
            .nav-btn {
                font-size: 10px !important;
                padding: 8px 2px !important;
                word-break: break-word;
                line-height: 1.2;
            }
            
            table {
                font-size: 10px !important;
            }
            
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
            }
        }
        
        @media print {
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">

    <!-- Role Select (ପ୍ରଥମେ ଏହିଟା ଦେଖିବ) -->
    <div id="roleSelect" class="max-w-md mx-auto p-4">
        <h2 class="text-xl font-semibold mb-3">Choose Role</h2>
        <p class="text-gray-600 mb-4">ଦୟାକରି ଆପଣଙ୍କ ଭୂମିକା ବାଛନ୍ତୁ:</p>
        <div class="flex gap-3">
            <button id="btnMember" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 transition-colors">Member / Staff</button>
            <button id="btnAdmin" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">Admin</button>
        </div>
    </div>

    <!-- Login Area -->
    <div id="loginArea" class="max-w-md mx-auto p-4" style="display:none">
        <h2 id="loginTitle" class="text-xl font-semibold mb-3">Member Login</h2>

        <input id="loginEmail" type="email" placeholder="Email"
               class="w-full border p-2 rounded mb-2" autocomplete="username"/>

        <input id="loginPassword" type="password" placeholder="Password"
               class="w-full border p-2 rounded mb-3" autocomplete="current-password"/>

        <!-- IMPORTANT: type='button' so page doesn't submit/reload -->
        <button id="loginBtn" type="button"
                class="px-4 py-2 bg-blue-600 text-white rounded w-full hover:bg-blue-700 transition-colors">
            Login
        </button>

        <button onclick="goBackToRoleSelect()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded w-full mt-2 hover:bg-gray-400 transition-colors">Back</button>

        <div id="loginMsg" class="text-sm text-red-600 mt-2"></div>
    </div>

    <!-- Member UI -->
    <section id="memberUI" style="display:none">
        <!-- Member Header -->
        <header class="gradient-bg text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div class="text-center flex-1">
                        <h1 class="text-3xl font-bold">Deulasahi Bazar Committee</h1>
                        <p class="text-blue-100 mt-2">Member Dashboard</p>
                    </div>
                    <button id="memberLogoutBtn" type="button" class="hidden sm:inline px-3 py-1 bg-gray-200 text-gray-800 rounded">Logout</button>
                </div>
            </div>
        </header>

        <!-- Member Navigation -->
        <nav id="memberTabs" class="bg-white shadow-sm border-b no-print">
            <div class="max-w-7xl mx-auto px-1">
                <div class="flex">
                    <a href="#" data-section="dashboard" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-blue-500 text-blue-600 text-center">Dashboard</a>
                    <a href="#" data-section="account" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center">My Account</a>
                    <a href="#" data-section="transactions" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center">Transactions</a>
                    <a href="#" data-section="statements" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center">Statements</a>
                </div>
            </div>
        </nav>

        <!-- Member Content -->
        <main class="max-w-7xl mx-auto px-2 sm:px-4 py-4 sm:py-6">
            <!-- Member Dashboard -->
            <section id="section-dashboard" class="member-section">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="glass-card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Account Status</p>
                                <p class="text-2xl font-bold text-blue-600 status">Active</p>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Current Balance</p>
                                <p class="text-2xl font-bold balance">₹0.00</p>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-100">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Transactions</p>
                                <p class="text-2xl font-bold text-purple-600 txCount">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="glass-card rounded-xl shadow-lg recent">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Recent Activity</h3>
                    </div>
                    <div class="p-6">
                        <div id="memberRecentActivity" class="space-y-4">
                            <p class="text-gray-500 text-center py-8">No recent activity</p>
                        </div>
                    </div>
                </div>
                
                <!-- Member Content Container -->
                <div id="memberContent"></div>
            </section>

            <!-- Member Account Info -->
            <section id="section-account" class="member-section" style="display:none">
                <div class="glass-card rounded-xl shadow-lg">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Account Information</h3>
                    </div>
                    <div class="p-6">
                        <div id="memberAccountInfo" class="space-y-4">
                            <p class="text-gray-500 text-center py-8">Loading account information...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Member Transactions -->
            <section id="section-transactions" class="member-section" style="display:none">
                <div class="glass-card rounded-xl shadow-lg">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">My Transactions</h3>
                            <select id="memberTransactionFilter" class="mt-4 sm:mt-0 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="all">All Transactions</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                            </select>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="memberTransactionList" class="space-y-3">
                            <p class="text-gray-500 text-center py-8">No transactions found</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Member Statements -->
            <section id="section-statements" class="member-section" style="display:none">
                <div class="glass-card rounded-xl shadow-lg">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">Account Statement</h3>
                            <div class="mt-4 sm:mt-0 flex gap-2">
                                <select id="memberStatementPeriod" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="month">This Month</option>
                                    <option value="quarter">This Quarter</option>
                                    <option value="6months">Last 6 Months</option>
                                    <option value="year">This Year</option>
                                    <option value="all">All Time</option>
                                </select>
                                <button onclick="generateMemberStatement()" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                                    Generate
                                </button>
                                <button onclick="downloadMemberP        
        // Make Firebase available globally
        window.db = db;
        window.auth = auth;
        window.firestore = { collection, addDoc, getDocs, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, serverTimestamp, where, limit };
        
        // Global variable to track selected role
        window.chosenRole = null;
        
        // UI show/hide by login state
        onAuthStateChanged(auth, async (user) => {
            const roleSel = document.getElementById('roleSelect');
            const login   = document.getElementById('loginArea');
            const adminUI = document.getElementById('adminUI');
            const memberUI= document.getElementById('memberUI');

            // ସବୁ UI ପ୍ରଥମେ ଲୁଚାଅ
            adminUI.style.display  = 'none';
            memberUI.style.display = 'none';

            if (!user) {
                // 🔒 Login ନାହିଁ → ମାତ୍ର Role + Login
                roleSel.style.display = 'block';
                login.style.display   = 'block';
                return; // ⚠️ ଏଠାରେ କେବେ data load କରିବେ ନାହିଁ
            }

            // Clear any stuck overlays when user logs in
            removeOverlays();

            // Logged in → role ଚୟନ ନହେଲେ Role screen ଦେଖାଅ
            roleSel.style.display = 'none';
            login.style.display   = 'none';

            if (window.chosenRole === 'admin') {
                adminUI.style.display = 'block';
                window.initializeAppUI?.();   // admin data listeners
            } else if (window.chosenRole === 'member') {
                memberUI.style.display = 'block';
                afterMemberUIShown?.();       // member UI setup
                window.loadMemberData?.();    // member ଡାଟା
            } else {
                roleSel.style.display = 'block';
            }
        });
        
        // ---------------- Login Handler (safe) ----------------
        const getLoginElements = () => ({
            emailEl: document.getElementById('loginEmail'),
            passEl: document.getElementById('loginPassword'),
            btnEl: document.getElementById('loginBtn'),
            msgEl: document.getElementById('loginMsg')
        });

        function setLoginBusy(busy) {
            const { btnEl } = getLoginElements();
            if (btnEl) {
                btnEl.disabled = busy;
                btnEl.textContent = busy ? 'Logging in...' : 'Login';
            }
        }

        async function handleLogin() {
            const { emailEl, passEl, btnEl, msgEl } = getLoginElements();
            
            if (!emailEl || !passEl || !btnEl || !msgEl) return;
            
            msgEl.textContent = '';
            const email = (emailEl.value || '').trim();
            const pass = passEl.value || '';

            if (!email || !pass) {
                msgEl.textContent = 'Please enter email & password.';
                return;
            }
            
            try {
                setLoginBusy(true);
                await signInWithEmailAndPassword(auth, email, pass);
                alert('Login successful!');
                // onAuthStateChanged will take over after this
            } catch (err) {
                console.error('Login error:', err);
                msgEl.textContent = err.message || 'Login failed';
            } finally {
                setLoginBusy(false);
            }
        }

        // Add event listener for login button after DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            const { btnEl } = getLoginElements();
            if (btnEl) {
                btnEl.addEventListener('click', handleLogin);
            }
        });

        // Make available globally for HTML onclick if needed
        window.handleLogin = handleLogin;
        // -----------------------------------------------------
        
        // Logout handler
        window.handleLogout = () => {
            window.chosenRole = null;
            signOut(auth).then(() => {
                alert('Logged out successfully!');
            }).catch((e) => {
                console.error('Logout error:', e);
                alert('Logout failed: ' + (e.message || 'Unknown error'));
            });
        };

        // Add logout button event listeners after DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            // Member logout button
            const memberLogoutBtn = document.getElementById('memberLogoutBtn');
            if (memberLogoutBtn) {
                memberLogoutBtn.addEventListener('click', () => {
                    window.chosenRole = null;
                    signOut(auth);
                });
            }
            
            // Admin logout button
            const adminLogoutBtn = document.getElementById('adminLogoutBtn');
            if (adminLogoutBtn) {
                adminLogoutBtn.addEventListener('click', () => {
                    window.chosenRole = null;
                    signOut(auth);
                });
            }
        });
        
        // Role selection utilities
        window.chosenRole = null;

        function show(el){ el.style.display = 'block'; }
        function hide(el){ el.style.display = 'none'; }

        function bindRoleButtons(){
          const roleSel = document.getElementById('roleSelect');
          const login   = document.getElementById('loginArea');
          const title   = document.getElementById('loginTitle');

          const memberBtn = document.getElementById('btnMember');
          const adminBtn  = document.getElementById('btnAdmin');

          memberBtn?.addEventListener('click', () => {
            window.chosenRole = 'member';
            title.textContent = 'Member Login';
            hide(roleSel); show(login);
          });

          adminBtn?.addEventListener('click', () => {
            window.chosenRole = 'admin';
            title.textContent = 'Admin Login';
            hide(roleSel); show(login);
          });
        }

        // DOM ଲୋଡ୍ ହେଲେ ମାତ୍ର bind କରାଯିବ
        document.addEventListener('DOMContentLoaded', bindRoleButtons);
        
        // Go back to role selection
        window.goBackToRoleSelect = () => {
            window.chosenRole = null;
            const roleSel = document.getElementById('roleSelect');
            const login = document.getElementById('loginArea');
            hide(login); show(roleSel);
        };
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden;
            max-width: 100vw;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .balance-positive { color: #059669; }
        .balance-negative { color: #dc2626; }
        .transaction-debit { border-left: 4px solid #dc2626; }
        .transaction-credit { border-left: 4px solid #059669; }
        
        /* Mobile specific styles */
        @media (max-width: 640px) {
            * {
                box-sizing: border-box;
            }
            
            .nav-btn {
                font-size: 10px !important;
                padding: 8px 2px !important;
                word-break: break-word;
                line-height: 1.2;
            }
            
            table {
                font-size: 10px !important;
            }
            
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
            }
        }
        
        @media print {
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">

    <!-- Role Select (ପ୍ରଥମେ ଏହିଟା ଦେଖିବ) -->
    <div id="roleSelect" class="max-w-md mx-auto p-4">
        <h2 class="text-xl font-semibold mb-3">Choose Role</h2>
        <p class="text-gray-600 mb-4">ଦୟାକରି ଆପଣଙ୍କ ଭୂମିକା ବାଛନ୍ତୁ:</p>
        <div class="flex gap-3">
            <button id="btnMember" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 transition-colors">Member / Staff</button>
            <button id="btnAdmin" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">Admin</button>
        </div>
    </div>

    <!-- Login Area -->
    <div id="loginArea" class="max-w-md mx-auto p-4" style="display:none">
        <h2 id="loginTitle" class="text-xl font-semibold mb-3">Member Login</h2>

        <input id="loginEmail" type="email" placeholder="Email"
               class="w-full border p-2 rounded mb-2" autocomplete="username"/>

        <input id="loginPassword" type="password" placeholder="Password"
               class="w-full border p-2 rounded mb-3" autocomplete="current-password"/>

        <!-- IMPORTANT: type='button' so page doesn't submit/reload -->
        <button id="loginBtn" type="button"
                class="px-4 py-2 bg-blue-600 text-white rounded w-full hover:bg-blue-700 transition-colors">
            Login
        </button>

        <button onclick="goBackToRoleSelect()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded w-full mt-2 hover:bg-gray-400 transition-colors">Back</button>

        <div id="loginMsg" class="text-sm text-red-600 mt-2"></div>
    </div>

    <!-- Member UI -->
    <section id="memberUI" style="display:none">
        <!-- Member Header -->
        <header class="gradient-bg text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div class="text-center flex-1">
                        <h1 class="text-3xl font-bold">Deulasahi Bazar Committee</h1>
                        <p class="text-blue-100 mt-2">Member Dashboard</p>
                    </div>
                    <button id="memberLogoutBtn" type="button" class="hidden sm:inline px-3 py-1 bg-gray-200 text-gray-800 rounded">Logout</button>
                </div>
            </div>
        </header>

        <!-- Member Navigation -->
        <nav id="memberTabs" class="bg-white shadow-sm border-b no-print">
            <div class="max-w-7xl mx-auto px-1">
                <div class="flex">
                    <a href="#" data-section="dashboard" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-blue-500 text-blue-600 text-center">Dashboard</a>
                    <a href="#" data-section="account" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center">My Account</a>
                    <a href="#" data-section="transactions" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center">Transactions</a>
                    <a href="#" data-section="statements" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center">Statements</a>
                </div>
            </div>
        </nav>

        <!-- Member Content -->
        <main class="max-w-7xl mx-auto px-2 sm:px-4 py-4 sm:py-6">
            <!-- Member Dashboard -->
            <section id="section-dashboard" class="member-section">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="glass-card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Account Status</p>
                                <p class="text-2xl font-bold text-blue-600 status">Active</p>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Current Balance</p>
                                <p class="text-2xl font-bold balance">₹0.00</p>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-100">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Transactions</p>
                                <p class="text-2xl font-bold text-purple-600 txCount">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="glass-card rounded-xl shadow-lg recent">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Recent Activity</h3>
                    </div>
                    <div class="p-6">
                        <div id="memberRecentActivity" class="space-y-4">
                            <p class="text-gray-500 text-center py-8">No recent activity</p>
                        </div>
                    </div>
                </div>
                
                <!-- Member Content Container -->
                <div id="memberContent"></div>
            </section>

            <!-- Member Account Info -->
            <section id="section-account" class="member-section" style="display:none">
                <div class="glass-card rounded-xl shadow-lg">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Account Information</h3>
                    </div>
                    <div class="p-6">
                        <div id="memberAccountInfo" class="space-y-4">
                            <p class="text-gray-500 text-center py-8">Loading account information...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Member Transactions -->
            <section id="section-transactions" class="member-section" style="display:none">
                <div class="glass-card rounded-xl shadow-lg">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">My Transactions</h3>
                            <select id="memberTransactionFilter" class="mt-4 sm:mt-0 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="all">All Transactions</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                            </select>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="memberTransactionList" class="space-y-3">
                            <p class="text-gray-500 text-center py-8">No transactions found</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Member Statements -->
            <section id="section-statements" class="member-section" style="display:none">
                <div class="glass-card rounded-xl shadow-lg">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">Account Statement</h3>
                            <div class="mt-4 sm:mt-0 flex gap-2">
                                <select id="memberStatementPeriod" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="month">This Month</option>
                                    <option value="quarter">This Quarter</option>
                              
        // Make Firebase available globally
        window.db = db;
        window.auth = auth;
        window.firestore = { collection, addDoc, getDocs, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, serverTimestamp, where, limit };
        
        // Global variable to track selected role
        window.chosenRole = null;
        
        // UI show/hide by login state
        onAuthStateChanged(auth, async (user) => {
            const roleSel = document.getElementById('roleSelect');
            const login   = document.getElementById('loginArea');
            const adminUI = document.getElementById('adminUI');
            const memberUI= document.getElementById('memberUI');

            // ସବୁ UI ପ୍ରଥମେ ଲୁଚାଅ
            adminUI.style.display  = 'none';
            memberUI.style.display = 'none';

            if (!user) {
                // 🔒 Login ନାହିଁ → ମାତ୍ର Role + Login
                roleSel.style.display = 'block';
                login.style.display   = 'block';
                return; // ⚠️ ଏଠାରେ କେବେ data load କରିବେ ନାହିଁ
            }

            // Clear any stuck overlays when user logs in
            removeOverlays();

            // Logged in → role ଚୟନ ନହେଲେ Role screen ଦେଖାଅ
            roleSel.style.display = 'none';
            login.style.display   = 'none';

            if (window.chosenRole === 'admin') {
                adminUI.style.display = 'block';
                window.initializeAppUI?.();   // admin data listeners
            } else if (window.chosenRole === 'member') {
                memberUI.style.display = 'block';
                afterMemberUIShown?.();       // member UI setup
                window.loadMemberData?.();    // member ଡାଟା
            } else {
                roleSel.style.display = 'block';
            }
        });
        
        // ---------------- Login Handler (safe) ----------------
        const getLoginElements = () => ({
            emailEl: document.getElementById('loginEmail'),
            passEl: document.getElementById('loginPassword'),
            btnEl: document.getElementById('loginBtn'),
            msgEl: document.getElementById('loginMsg')
        });

        function setLoginBusy(busy) {
            const { btnEl } = getLoginElements();
            if (btnEl) {
                btnEl.disabled = busy;
                btnEl.textContent = busy ? 'Logging in...' : 'Login';
            }
        }

        async function handleLogin() {
            const { emailEl, passEl, btnEl, msgEl } = getLoginElements();
            
            if (!emailEl || !passEl || !btnEl || !msgEl) return;
            
            msgEl.textContent = '';
            const email = (emailEl.value || '').trim();
            const pass = passEl.value || '';

            if (!email || !pass) {
                msgEl.textContent = 'Please enter email & password.';
                return;
            }
            
            try {
                setLoginBusy(true);
                await signInWithEmailAndPassword(auth, email, pass);
                showToast('Login successful!');
                // onAuthStateChanged will take over after this
            } catch (err) {
                console.error('Login error:', err);
                msgEl.textContent = err.message || 'Login failed';
            } finally {
                setLoginBusy(false);
            }
        }

        // Add event listener for login button after DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            const { btnEl } = getLoginElements();
            if (btnEl) {
                btnEl.addEventListener('click', handleLogin);
            }
        });

        // Make available globally for HTML onclick if needed
        window.handleLogin = handleLogin;
        // -----------------------------------------------------
        
        // Logout handler
        window.handleLogout = () => {
            window.chosenRole = null;
            signOut(auth).then(() => {
                showToast('Logged out successfully!');
            }).catch((e) => {
                console.error('Logout error:', e);
                showToast('Logout failed: ' + e.message, true);
            });
        };

        // Add logout button event listeners after DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            // Member logout button
            const memberLogoutBtn = document.getElementById('memberLogoutBtn');
            if (memberLogoutBtn) {
                memberLogoutBtn.addEventListener('click', () => {
                    window.chosenRole = null;
                    signOut(auth);
                });
            }
            
            // Admin logout button
            const adminLogoutBtn = document.getElementById('adminLogoutBtn');
            if (adminLogoutBtn) {
                adminLogoutBtn.addEventListener('click', () => {
                    window.chosenRole = null;
                    signOut(auth);
                });
            }
        });
        
        // Role selection utilities
        window.chosenRole = null;

        function show(el){ el.style.display = 'block'; }
        function hide(el){ el.style.display = 'none'; }

        function bindRoleButtons(){
          const roleSel = document.getElementById('roleSelect');
          const login   = document.getElementById('loginArea');
          const title   = document.getElementById('loginTitle');

          const memberBtn = document.getElementById('btnMember');
          const adminBtn  = document.getElementById('btnAdmin');

          memberBtn?.addEventListener('click', () => {
            window.chosenRole = 'member';
            title.textContent = 'Member Login';
            hide(roleSel); show(login);
          });

          adminBtn?.addEventListener('click', () => {
            window.chosenRole = 'admin';
            title.textContent = 'Admin Login';
            hide(roleSel); show(login);
          });
        }

        // DOM ଲୋଡ୍ ହେଲେ ମାତ୍ର bind କରାଯିବ
        document.addEventListener('DOMContentLoaded', bindRoleButtons);
        
        // Go back to role selection
        window.goBackToRoleSelect = () => {
            window.chosenRole = null;
            const roleSel = document.getElementById('roleSelect');
            const login = document.getElementById('loginArea');
            hide(login); show(roleSel);
        };
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden;
            max-width: 100vw;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .balance-positive { color: #059669; }
        .balance-negative { color: #dc2626; }
        .transaction-debit { border-left: 4px solid #dc2626; }
        .transaction-credit { border-left: 4px solid #059669; }
        
        /* Mobile specific styles */
        @media (max-width: 640px) {
            * {
                box-sizing: border-box;
            }
            
            .nav-btn {
                font-size: 10px !important;
                padding: 8px 2px !important;
                word-break: break-word;
                line-height: 1.2;
            }
            
            table {
                font-size: 10px !important;
            }
            
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
            }
        }
        
        @media print {
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">

    <!-- Role Select (ପ୍ରଥମେ ଏହିଟା ଦେଖିବ) -->
    <div id="roleSelect" class="max-w-md mx-auto p-4">
        <h2 class="text-xl font-semibold mb-3">Choose Role</h2>
        <p class="text-gray-600 mb-4">ଦୟାକରି ଆପଣଙ୍କ ଭୂମିକା ବାଛନ୍ତୁ:</p>
        <div class="flex gap-3">
            <button id="btnMember" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 transition-colors">Member / Staff</button>
            <button id="btnAdmin" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">Admin</button>
        </div>
    </div>

    <!-- Login Area -->
    <div id="loginArea" class="max-w-md mx-auto p-4" style="display:none">
        <h2 id="loginTitle" class="text-xl font-semibold mb-3">Member Login</h2>

        <input id="loginEmail" type="email" placeholder="Email"
               class="w-full border p-2 rounded mb-2" autocomplete="username"/>

        <input id="loginPassword" type="password" placeholder="Password"
               class="w-full border p-2 rounded mb-3" autocomplete="current-password"/>

        <!-- IMPORTANT: type='button' so page doesn't submit/reload -->
        <button id="loginBtn" type="button"
                class="px-4 py-2 bg-blue-600 text-white rounded w-full hover:bg-blue-700 transition-colors">
            Login
        </button>

        <button onclick="goBackToRoleSelect()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded w-full mt-2 hover:bg-gray-400 transition-colors">Back</button>

        <div id="loginMsg" class="text-sm text-red-600 mt-2"></div>
    </div>

    <!-- Member UI -->
    <section id="memberUI" style="display:none">
        <!-- Member Header -->
        <header class="gradient-bg text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div class="text-center flex-1">
                        <h1 class="text-3xl font-bold">Deulasahi Bazar Committee</h1>
                        <p class="text-blue-100 mt-2">Member Dashboard</p>
                    </div>
                    <button id="memberLogoutBtn" type="button" class="hidden sm:inline px-3 py-1 bg-gray-200 text-gray-800 rounded">Logout</button>
                </div>
            </div>
        </header>

        <!-- Member Navigation -->
        <nav id="memberTabs" class="bg-white shadow-sm border-b no-print">
            <div class="max-w-7xl mx-auto px-1">
                <div class="flex">
                    <a href="#" data-section="dashboard" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-blue-500 text-blue-600 text-center">Dashboard</a>
                    <a href="#" data-section="account" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center">My Account</a>
                    <a href="#" data-section="transactions" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center">Transactions</a>
                    <a href="#" data-section="statements" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center">Statements</a>
                </div>
            </div>
        </nav>

        <!-- Member Content -->
        <main class="max-w-7xl mx-auto px-2 sm:px-4 py-4 sm:py-6">
            <!-- Member Dashboard -->
            <section id="section-dashboard" class="member-section">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="glass-card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Account Status</p>
                                <p class="text-2xl font-bold text-blue-600 status">Active</p>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Current Balance</p>
                                <p class="text-2xl font-bold balance">₹0.00</p>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-100">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Transactions</p>
                                <p class="text-2xl font-bold text-purple-600 txCount">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="glass-card rounded-xl shadow-lg recent">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Recent Activity</h3>
                    </div>
                    <div class="p-6">
                        <div id="memberRecentActivity" class="space-y-4">
                            <p class="text-gray-500 text-center py-8">No recent activity</p>
                        </div>
                    </div>
                </div>
                
                <!-- Member Content Container -->
                <div id="memberContent"></div>
            </section>

            <!-- Member Account Info -->
            <section id="section-account" class="member-section" style="display:none">
                <div class="glass-card rounded-xl shadow-lg">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Account Information</h3>
                    </div>
                    <div class="p-6">
                        <div id="memberAccountInfo" class="space-y-4">
                            <p class="text-gray-500 text-center py-8">Loading account information...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Member Transactions -->
            <section id="section-transactions" class="member-section" style="display:none">
                <div class="glass-card rounded-xl shadow-lg">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">My Transactions</h3>
                            <select id="memberTransactionFilter" class="mt-4 sm:mt-0 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="all">All Transactions</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                            </select>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="memberTransactionList" class="space-y-3">
                            <p class="text-gray-500 text-center py-8">No transactions found</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Member Statements -->
            <section id="section-statements" class="member-section" style="display:none">
                <div class="glass-card rounded-xl shadow-lg">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">Account Statement</h3>
                            <div class="mt-4 sm:mt-0 flex gap-2">
                                <select id="memberStatementPeriod" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="month">This Month</option>
                                    <option value="quarter">This Quarter</option>
                                 
        // Make Firebase available globally
        window.db = db;
        window.auth = auth;
        window.firestore = { collection, addDoc, getDocs, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, serverTimestamp, where, limit };
        
        // Global variable to track selected role
        window.chosenRole = null;
        
        // UI show/hide by login state
        onAuthStateChanged(auth, async (user) => {
            const roleSel = document.getElementById('roleSelect');
            const login   = document.getElementById('loginArea');
            const adminUI = document.getElementById('adminUI');
            const memberUI= document.getElementById('memberUI');

            // ସବୁ UI ପ୍ରଥମେ ଲୁଚାଅ
            adminUI.style.display  = 'none';
            memberUI.style.display = 'none';

            if (!user) {
                // 🔒 Login ନାହିଁ → ମାତ୍ର Role + Login
                roleSel.style.display = 'block';
                login.style.display   = 'block';
                return; // ⚠️ ଏଠାରେ କେବେ data load କରିବେ ନାହିଁ
            }

            // Logged in → role ଚୟନ ନହେଲେ Role screen ଦେଖାଅ
            roleSel.style.display = 'none';
            login.style.display   = 'none';

            if (window.chosenRole === 'admin') {
                adminUI.style.display = 'block';
                window.initializeAppUI?.();   // admin data listeners
            } else if (window.chosenRole === 'member') {
                memberUI.style.display = 'block';
                window.loadMemberData?.();    // member ଡାଟା
            } else {
                roleSel.style.display = 'block';
            }
        });
        
        // ---------------- Login Handler (safe) ----------------
        const getLoginElements = () => ({
            emailEl: document.getElementById('loginEmail'),
            passEl: document.getElementById('loginPassword'),
            btnEl: document.getElementById('loginBtn'),
            msgEl: document.getElementById('loginMsg')
        });

        function setLoginBusy(busy) {
            const { btnEl } = getLoginElements();
            if (btnEl) {
                btnEl.disabled = busy;
                btnEl.textContent = busy ? 'Logging in...' : 'Login';
            }
        }

        async function handleLogin() {
            const { emailEl, passEl, btnEl, msgEl } = getLoginElements();
            
            if (!emailEl || !passEl || !btnEl || !msgEl) return;
            
            msgEl.textContent = '';
            const email = (emailEl.value || '').trim();
            const pass = passEl.value || '';

            if (!email || !pass) {
                msgEl.textContent = 'Please enter email & password.';
                return;
            }
            
            try {
                setLoginBusy(true);
                await signInWithEmailAndPassword(auth, email, pass);
                showToast('Login successful!');
                // onAuthStateChanged will take over after this
            } catch (err) {
                console.error('Login error:', err);
                msgEl.textContent = err.message || 'Login failed';
            } finally {
                setLoginBusy(false);
            }
        }

        // Add event listener for login button after DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            const { btnEl } = getLoginElements();
            if (btnEl) {
                btnEl.addEventListener('click', handleLogin);
            }
        });

        // Make available globally for HTML onclick if needed
        window.handleLogin = handleLogin;
        // -----------------------------------------------------
        
        // Logout handler
        window.handleLogout = () => {
            window.chosenRole = null;
            signOut(auth).then(() => {
                showToast('Logged out successfully!');
            }).catch((e) => {
                console.error('Logout error:', e);
                showToast('Logout failed: ' + e.message, true);
            });
        };

        // Add logout button event listeners after DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            // Member logout button
            const memberLogoutBtn = document.getElementById('memberLogoutBtn');
            if (memberLogoutBtn) {
                memberLogoutBtn.addEventListener('click', () => {
                    window.chosenRole = null;
                    signOut(auth);
                });
            }
            
            // Admin logout button
            const adminLogoutBtn = document.getElementById('adminLogoutBtn');
            if (adminLogoutBtn) {
                adminLogoutBtn.addEventListener('click', () => {
                    window.chosenRole = null;
                    signOut(auth);
                });
            }
        });
        
        // Role selection utilities
        window.chosenRole = null;

        function show(el){ el.style.display = 'block'; }
        function hide(el){ el.style.display = 'none'; }

        function bindRoleButtons(){
          const roleSel = document.getElementById('roleSelect');
          const login   = document.getElementById('loginArea');
          const title   = document.getElementById('loginTitle');

          const memberBtn = document.getElementById('btnMember');
          const adminBtn  = document.getElementById('btnAdmin');

          memberBtn?.addEventListener('click', () => {
            window.chosenRole = 'member';
            title.textContent = 'Member Login';
            hide(roleSel); show(login);
          });

          adminBtn?.addEventListener('click', () => {
            window.chosenRole = 'admin';
            title.textContent = 'Admin Login';
            hide(roleSel); show(login);
          });
        }

        // DOM ଲୋଡ୍ ହେଲେ ମାତ୍ର bind କରାଯିବ
        document.addEventListener('DOMContentLoaded', bindRoleButtons);
        
        // Go back to role selection
        window.goBackToRoleSelect = () => {
            window.chosenRole = null;
            const roleSel = document.getElementById('roleSelect');
            const login = document.getElementById('loginArea');
            hide(login); show(roleSel);
        };
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden;
            max-width: 100vw;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .balance-positive { color: #059669; }
        .balance-negative { color: #dc2626; }
        .transaction-debit { border-left: 4px solid #dc2626; }
        .transaction-credit { border-left: 4px solid #059669; }
        
        /* Mobile specific styles */
        @media (max-width: 640px) {
            * {
                box-sizing: border-box;
            }
            
            .nav-btn {
                font-size: 10px !important;
                padding: 8px 2px !important;
                word-break: break-word;
                line-height: 1.2;
            }
            
            table {
                font-size: 10px !important;
            }
            
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
            }
        }
        
        @media print {
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">

    <!-- Role Select (ପ୍ରଥମେ ଏହିଟା ଦେଖିବ) -->
    <div id="roleSelect" class="max-w-md mx-auto p-4">
        <h2 class="text-xl font-semibold mb-3">Choose Role</h2>
        <p class="text-gray-600 mb-4">ଦୟାକରି ଆପଣଙ୍କ ଭୂମିକା ବାଛନ୍ତୁ:</p>
        <div class="flex gap-3">
            <button id="btnMember" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 transition-colors">Member / Staff</button>
            <button id="btnAdmin" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">Admin</button>
        </div>
    </div>

    <!-- Login Area -->
    <div id="loginArea" class="max-w-md mx-auto p-4" style="display:none">
        <h2 id="loginTitle" class="text-xl font-semibold mb-3">Member Login</h2>

        <input id="loginEmail" type="email" placeholder="Email"
               class="w-full border p-2 rounded mb-2" autocomplete="username"/>

        <input id="loginPassword" type="password" placeholder="Password"
               class="w-full border p-2 rounded mb-3" autocomplete="current-password"/>

        <!-- IMPORTANT: type='button' so page doesn't submit/reload -->
        <button id="loginBtn" type="button"
                class="px-4 py-2 bg-blue-600 text-white rounded w-full hover:bg-blue-700 transition-colors">
            Login
        </button>

        <button onclick="goBackToRoleSelect()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded w-full mt-2 hover:bg-gray-400 transition-colors">Back</button>

        <div id="loginMsg" class="text-sm text-red-600 mt-2"></div>
    </div>

    <!-- Member UI -->
    <section id="memberUI" style="display:none">
        <!-- Member Header -->
        <header class="gradient-bg text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div class="text-center flex-1">
                        <h1 class="text-3xl font-bold">Deulasahi Bazar Committee</h1>
                        <p class="text-blue-100 mt-2">Member Dashboard</p>
                    </div>
                    <button id="memberLogoutBtn" type="button" class="hidden sm:inline px-3 py-1 bg-gray-200 text-gray-800 rounded">Logout</button>
                </div>
            </div>
        </header>

        <!-- Member Navigation -->
        <nav class="bg-white shadow-sm border-b no-print">
            <div class="max-w-7xl mx-auto px-1">
                <div class="flex">
                    <button onclick="showMemberSection('memberDashboard')" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-blue-500 text-blue-600 text-center">Dashboard</button>
                    <button onclick="showMemberSection('memberAccount')" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center">My Account</button>
                    <button onclick="showMemberSection('memberTransactions')" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center">Transactions</button>
                    <button onclick="showMemberSection('memberStatements')" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center">Statements</button>
                </div>
            </div>
        </nav>

        <!-- Member Content -->
        <main class="max-w-7xl mx-auto px-2 sm:px-4 py-4 sm:py-6">
            <!-- Member Dashboard -->
            <div id="memberDashboard" class="member-section">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="glass-card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Account Status</p>
                                <p class="text-2xl font-bold text-blue-600 status">Active</p>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Current Balance</p>
                                <p class="text-2xl font-bold balance">₹0.00</p>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-100">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Transactions</p>
                                <p class="text-2xl font-bold text-purple-600 txCount">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="glass-card rounded-xl shadow-lg recent">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Recent Activity</h3>
                    </div>
                    <div class="p-6">
                        <div id="memberRecentActivity" class="space-y-4">
                            <p class="text-gray-500 text-center py-8">No recent activity</p>
                        </div>
                    </div>
                </div>
                
                <!-- Member Content Container -->
                <div id="memberContent"></div>
            </div>

            <!-- Member Account Info -->
            <div id="memberAccount" class="member-section hidden">
                <div class="glass-card rounded-xl shadow-lg">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Account Information</h3>
                    </div>
                    <div class="p-6">
                        <div id="memberAccountInfo" class="space-y-4">
                            <p class="text-gray-500 text-center py-8">Loading account information...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Member Transactions -->
            <div id="memberTransactions" class="member-section hidden">
                <div class="glass-card rounded-xl shadow-lg">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">My Transactions</h3>
                            <select id="memberTransactionFilter" class="mt-4 sm:mt-0 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="all">All Transactions</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                            </select>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="memberTransactionList" class="space-y-3">
                            <p class="text-gray-500 text-center py-8">No transactions found</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Member Statements -->
            <div id="memberStatements" class="member-section hidden">
                <div class="glass-card rounded-xl shadow-lg">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">Account Statement</h3>
                            <div class="mt-4 sm:mt-0 flex gap-2">
                                <select id="memberStatementPeriod" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="month">This Month</option>
                                    <option value="quarter">This Quarter</option>
                                    <option value="6months">Last 6 Months</option>
                                    <option value="year">This Year</option>
                              
        // Make Firebase available globally
        window.db = db;
        window.auth = auth;
        window.firestore = { collection, addDoc, getDocs, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, serverTimestamp, where, limit };
        
        // Global variable to track selected role
        window.chosenRole = null;
        
        // UI show/hide by login state
        onAuthStateChanged(auth, async (user) => {
            const roleSel = document.getElementById('roleSelect');
            const login   = document.getElementById('loginArea');
            const adminUI = document.getElementById('adminUI');
            const memberUI= document.getElementById('memberUI');

            // ସବୁ UI ପ୍ରଥମେ ଲୁଚାଅ
            adminUI.style.display  = 'none';
            memberUI.style.display = 'none';

            if (!user) {
                // 🔒 Login ନାହିଁ → ମାତ୍ର Role + Login
                roleSel.style.display = 'block';
                login.style.display   = 'block';
                return; // ⚠️ ଏଠାରେ କେବେ data load କରିବେ ନାହିଁ
            }

            // Logged in → role ଚୟନ ନହେଲେ Role screen ଦେଖାଅ
            roleSel.style.display = 'none';
            login.style.display   = 'none';

            if (window.chosenRole === 'admin') {
                adminUI.style.display = 'block';
                window.initializeAppUI?.();   // admin data listeners
            } else if (window.chosenRole === 'member') {
                memberUI.style.display = 'block';
                window.loadMemberData?.();    // member ଡାଟା
            } else {
                roleSel.style.display = 'block';
            }
        });
        
        // ---------------- Login Handler (safe) ----------------
        const getLoginElements = () => ({
            emailEl: document.getElementById('loginEmail'),
            passEl: document.getElementById('loginPassword'),
            btnEl: document.getElementById('loginBtn'),
            msgEl: document.getElementById('loginMsg')
        });

        function setLoginBusy(busy) {
            const { btnEl } = getLoginElements();
            if (btnEl) {
                btnEl.disabled = busy;
                btnEl.textContent = busy ? 'Logging in...' : 'Login';
            }
        }

        async function handleLogin() {
            const { emailEl, passEl, btnEl, msgEl } = getLoginElements();
            
            if (!emailEl || !passEl || !btnEl || !msgEl) return;
            
            msgEl.textContent = '';
            const email = (emailEl.value || '').trim();
            const pass = passEl.value || '';

            if (!email || !pass) {
                msgEl.textContent = 'Please enter email & password.';
                return;
            }
            
            try {
                setLoginBusy(true);
                await signInWithEmailAndPassword(auth, email, pass);
                showToast('Login successful!');
                // onAuthStateChanged will take over after this
            } catch (err) {
                console.error('Login error:', err);
                msgEl.textContent = err.message || 'Login failed';
            } finally {
                setLoginBusy(false);
            }
        }

        // Add event listener for login button after DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            const { btnEl } = getLoginElements();
            if (btnEl) {
                btnEl.addEventListener('click', handleLogin);
            }
        });

        // Make available globally for HTML onclick if needed
        window.handleLogin = handleLogin;
        // -----------------------------------------------------
        
        // Logout handler
        window.handleLogout = () => {
            window.chosenRole = null;
            signOut(auth).then(() => {
                showToast('Logged out successfully!');
            }).catch((e) => {
                console.error('Logout error:', e);
                showToast('Logout failed: ' + e.message, 'error');
            });
        };

        // Add logout button event listeners after DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            // Member logout button
            const memberLogoutBtn = document.getElementById('memberLogoutBtn');
            if (memberLogoutBtn) {
                memberLogoutBtn.addEventListener('click', () => {
                    window.chosenRole = null;
                    signOut(auth);
                });
            }
            
            // Admin logout button
            const adminLogoutBtn = document.getElementById('adminLogoutBtn');
            if (adminLogoutBtn) {
                adminLogoutBtn.addEventListener('click', () => {
                    window.chosenRole = null;
                    signOut(auth);
                });
            }
        });
        
        // Role selection utilities
        window.chosenRole = null;

        function show(el){ el.style.display = 'block'; }
        function hide(el){ el.style.display = 'none'; }

        function bindRoleButtons(){
          const roleSel = document.getElementById('roleSelect');
          const login   = document.getElementById('loginArea');
          const title   = document.getElementById('loginTitle');

          const memberBtn = document.getElementById('btnMember');
          const adminBtn  = document.getElementById('btnAdmin');

          memberBtn?.addEventListener('click', () => {
            window.chosenRole = 'member';
            title.textContent = 'Member Login';
            hide(roleSel); show(login);
          });

          adminBtn?.addEventListener('click', () => {
            window.chosenRole = 'admin';
            title.textContent = 'Admin Login';
            hide(roleSel); show(login);
          });
        }

        // DOM ଲୋଡ୍ ହେଲେ ମାତ୍ର bind କରାଯିବ
        document.addEventListener('DOMContentLoaded', bindRoleButtons);
        
        // Go back to role selection
        window.goBackToRoleSelect = () => {
            window.chosenRole = null;
            const roleSel = document.getElementById('roleSelect');
            const login = document.getElementById('loginArea');
            hide(login); show(roleSel);
        };
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden;
            max-width: 100vw;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .balance-positive { color: #059669; }
        .balance-negative { color: #dc2626; }
        .transaction-debit { border-left: 4px solid #dc2626; }
        .transaction-credit { border-left: 4px solid #059669; }
        
        /* Mobile specific styles */
        @media (max-width: 640px) {
            * {
                box-sizing: border-box;
            }
            
            .nav-btn {
                font-size: 10px !important;
                padding: 8px 2px !important;
                word-break: break-word;
                line-height: 1.2;
            }
            
            table {
                font-size: 10px !important;
            }
            
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
            }
        }
        
        @media print {
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">

    <!-- Role Select (ପ୍ରଥମେ ଏହିଟା ଦେଖିବ) -->
    <div id="roleSelect" class="max-w-md mx-auto p-4">
        <h2 class="text-xl font-semibold mb-3">Choose Role</h2>
        <p class="text-gray-600 mb-4">ଦୟାକରି ଆପଣଙ୍କ ଭୂମିକା ବାଛନ୍ତୁ:</p>
        <div class="flex gap-3">
            <button id="btnMember" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 transition-colors">Member / Staff</button>
            <button id="btnAdmin" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">Admin</button>
        </div>
    </div>

    <!-- Login Area -->
    <div id="loginArea" class="max-w-md mx-auto p-4" style="display:none">
        <h2 id="loginTitle" class="text-xl font-semibold mb-3">Member Login</h2>

        <input id="loginEmail" type="email" placeholder="Email"
               class="w-full border p-2 rounded mb-2" autocomplete="username"/>

        <input id="loginPassword" type="password" placeholder="Password"
               class="w-full border p-2 rounded mb-3" autocomplete="current-password"/>

        <!-- IMPORTANT: type='button' so page doesn't submit/reload -->
        <button id="loginBtn" type="button"
                class="px-4 py-2 bg-blue-600 text-white rounded w-full hover:bg-blue-700 transition-colors">
            Login
        </button>

        <button onclick="goBackToRoleSelect()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded w-full mt-2 hover:bg-gray-400 transition-colors">Back</button>

        <div id="loginMsg" class="text-sm text-red-600 mt-2"></div>
    </div>

    <!-- Member UI -->
    <section id="memberUI" style="display:none">
        <!-- Member Header -->
        <header class="gradient-bg text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div class="text-center flex-1">
                        <h1 class="text-3xl font-bold">Deulasahi Bazar Committee</h1>
                        <p class="text-blue-100 mt-2">Member Dashboard</p>
                    </div>
                    <button id="memberLogoutBtn" type="button" class="hidden sm:inline px-3 py-1 bg-gray-200 text-gray-800 rounded">Logout</button>
                </div>
            </div>
        </header>

        <!-- Member Navigation -->
        <nav class="bg-white shadow-sm border-b no-print">
            <div class="max-w-7xl mx-auto px-1">
                <div class="flex">
                    <button onclick="showMemberSection('memberDashboard')" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-blue-500 text-blue-600 text-center">Dashboard</button>
                    <button onclick="showMemberSection('memberAccount')" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center">My Account</button>
                    <button onclick="showMemberSection('memberTransactions')" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center">Transactions</button>
                    <button onclick="showMemberSection('memberStatements')" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center">Statements</button>
                </div>
            </div>
        </nav>

        <!-- Member Content -->
        <main class="max-w-7xl mx-auto px-2 sm:px-4 py-4 sm:py-6">
            <!-- Member Dashboard -->
            <div id="memberDashboard" class="member-section">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="glass-card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Account Status</p>
                                <p class="text-2xl font-bold text-blue-600 status">Active</p>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Current Balance</p>
                                <p class="text-2xl font-bold balance">₹0.00</p>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-100">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Transactions</p>
                                <p class="text-2xl font-bold text-purple-600 txCount">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="glass-card rounded-xl shadow-lg recent">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Recent Activity</h3>
                    </div>
                    <div class="p-6">
                        <div id="memberRecentActivity" class="space-y-4">
                            <p class="text-gray-500 text-center py-8">No recent activity</p>
                        </div>
                    </div>
                </div>
                
                <!-- Member Content Container -->
                <div id="memberContent"></div>
            </div>

            <!-- Member Account Info -->
            <div id="memberAccount" class="member-section hidden">
                <div class="glass-card rounded-xl shadow-lg">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Account Information</h3>
                    </div>
                    <div class="p-6">
                        <div id="memberAccountInfo" class="space-y-4">
                            <p class="text-gray-500 text-center py-8">Loading account information...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Member Transactions -->
            <div id="memberTransactions" class="member-section hidden">
                <div class="glass-card rounded-xl shadow-lg">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">My Transactions</h3>
                            <select id="memberTransactionFilter" class="mt-4 sm:mt-0 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="all">All Transactions</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                            </select>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="memberTransactionList" class="space-y-3">
                            <p class="text-gray-500 text-center py-8">No transactions found</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Member Statements -->
            <div id="memberStatements" class="member-section hidden">
                <div class="glass-card rounded-xl shadow-lg">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">Account Statement</h3>
                            <div class="mt-4 sm:mt-0 flex gap-2">
                                <select id="memberStatementPeriod" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="month">This Month</option>
                                    <option value="quarter">This Quarter</option>
                                    <option value="6months">Last 6 Months</option>
                                    <option value="year">This Year</option>
                           
        // Make Firebase available globally
        window.db = db;
        window.auth = auth;
        window.firestore = { collection, addDoc, getDocs, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, serverTimestamp, where, limit };
        
        // Global variable to track selected role
        window.chosenRole = null;
        
        // UI show/hide by login state
        onAuthStateChanged(auth, async (user) => {
            const roleSel = document.getElementById('roleSelect');
            const login   = document.getElementById('loginArea');
            const adminUI = document.getElementById('adminUI');
            const memberUI= document.getElementById('memberUI');

            // ସବୁ UI ପ୍ରଥମେ ଲୁଚାଅ
            adminUI.style.display  = 'none';
            memberUI.style.display = 'none';

            if (!user) {
                // 🔒 Login ନାହିଁ → ମାତ୍ର Role + Login
                roleSel.style.display = 'block';
                login.style.display   = 'block';
                return; // ⚠️ ଏଠାରେ କେବେ data load କରିବେ ନାହିଁ
            }

            // Logged in → role ଚୟନ ନହେଲେ Role screen ଦେଖାଅ
            roleSel.style.display = 'none';
            login.style.display   = 'none';

            if (window.chosenRole === 'admin') {
                adminUI.style.display = 'block';
                window.initializeAppUI?.();   // admin data listeners
            } else if (window.chosenRole === 'member') {
                memberUI.style.display = 'block';
                window.loadMemberData?.();    // member ଡାଟା
            } else {
                roleSel.style.display = 'block';
            }
        });
        
        // ---------------- Login Handler (safe) ----------------
        const getLoginElements = () => ({
            emailEl: document.getElementById('loginEmail'),
            passEl: document.getElementById('loginPassword'),
            btnEl: document.getElementById('loginBtn'),
            msgEl: document.getElementById('loginMsg')
        });

        function setLoginBusy(busy) {
            const { btnEl } = getLoginElements();
            if (btnEl) {
                btnEl.disabled = busy;
                btnEl.textContent = busy ? 'Logging in...' : 'Login';
            }
        }

        async function handleLogin() {
            const { emailEl, passEl, btnEl, msgEl } = getLoginElements();
            
            if (!emailEl || !passEl || !btnEl || !msgEl) return;
            
            msgEl.textContent = '';
            const email = (emailEl.value || '').trim();
            const pass = passEl.value || '';

            if (!email || !pass) {
                msgEl.textContent = 'Please enter email & password.';
                return;
            }
            
            try {
                setLoginBusy(true);
                await signInWithEmailAndPassword(auth, email, pass);
                showToast('Login successful!');
                // onAuthStateChanged will take over after this
            } catch (err) {
                console.error('Login error:', err);
                msgEl.textContent = err.message || 'Login failed';
            } finally {
                setLoginBusy(false);
            }
        }

        // Add event listener for login button after DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            const { btnEl } = getLoginElements();
            if (btnEl) {
                btnEl.addEventListener('click', handleLogin);
            }
        });

        // Make available globally for HTML onclick if needed
        window.handleLogin = handleLogin;
        // -----------------------------------------------------
        
        // Logout handler
        window.handleLogout = () => {
            window.chosenRole = null;
            signOut(auth).then(() => {
                showToast('Logged out successfully!');
            }).catch((e) => {
                console.error('Logout error:', e);
                showToast('Logout failed: ' + e.message, 'error');
            });
        };

        // Add logout button event listeners after DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            // Member logout button
            const memberLogoutBtn = document.getElementById('memberLogoutBtn');
            if (memberLogoutBtn) {
                memberLogoutBtn.addEventListener('click', () => {
                    window.chosenRole = null;
                    signOut(auth);
                });
            }
            
            // Admin logout button
            const adminLogoutBtn = document.getElementById('adminLogoutBtn');
            if (adminLogoutBtn) {
                adminLogoutBtn.addEventListener('click', () => {
                    window.chosenRole = null;
                    signOut(auth);
                });
            }
        });
        
        // Role selection handler
        window.selectRole = (role) => {
            window.chosenRole = role;
            
            // Update login title based on role
            const loginTitle = document.getElementById('loginTitle');
            if (role === 'member') {
                loginTitle.textContent = 'Member Login';
            } else {
                loginTitle.textContent = 'Admin Login';
            }
            
            // Show login area
            document.getElementById('roleSelect').style.display = 'none';
            document.getElementById('loginArea').style.display = 'block';
        };
        
        // Go back to role selection
        window.goBackToRoleSelect = () => {
            window.chosenRole = null;
            document.getElementById('loginArea').style.display = 'none';
            document.getElementById('roleSelect').style.display = 'block';
        };
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden;
            max-width: 100vw;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .balance-positive { color: #059669; }
        .balance-negative { color: #dc2626; }
        .transaction-debit { border-left: 4px solid #dc2626; }
        .transaction-credit { border-left: 4px solid #059669; }
        
        /* Mobile specific styles */
        @media (max-width: 640px) {
            * {
                box-sizing: border-box;
            }
            
            .nav-btn {
                font-size: 10px !important;
                padding: 8px 2px !important;
                word-break: break-word;
                line-height: 1.2;
            }
            
            table {
                font-size: 10px !important;
            }
            
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
            }
        }
        
        @media print {
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">

    <!-- Role Select (ପ୍ରଥମେ ଏହିଟା ଦେଖିବ) -->
    <div id="roleSelect" class="max-w-md mx-auto p-4">
        <h2 class="text-xl font-semibold mb-3">Choose Role</h2>
        <p class="text-gray-600 mb-4">ଦୟାକରି ଆପଣଙ୍କ ଭୂମିକା ବାଛନ୍ତୁ:</p>
        <div class="flex gap-3">
            <button id="btnMember" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 transition-colors">Member / Staff</button>
            <button id="btnAdmin" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">Admin</button>
        </div>
    </div>

    <!-- Login Area -->
    <div id="loginArea" class="max-w-md mx-auto p-4" style="display:none">
        <h2 id="loginTitle" class="text-xl font-semibold mb-3">Member Login</h2>

        <input id="loginEmail" type="email" placeholder="Email"
               class="w-full border p-2 rounded mb-2" autocomplete="username"/>

        <input id="loginPassword" type="password" placeholder="Password"
               class="w-full border p-2 rounded mb-3" autocomplete="current-password"/>

        <!-- IMPORTANT: type='button' so page doesn't submit/reload -->
        <button id="loginBtn" type="button"
                class="px-4 py-2 bg-blue-600 text-white rounded w-full hover:bg-blue-700 transition-colors">
            Login
        </button>

        <button onclick="goBackToRoleSelect()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded w-full mt-2 hover:bg-gray-400 transition-colors">Back</button>

        <div id="loginMsg" class="text-sm text-red-600 mt-2"></div>
    </div>

    <!-- Member UI -->
    <section id="memberUI" style="display:none">
        <!-- Member Header -->
        <header class="gradient-bg text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div class="text-center flex-1">
                        <h1 class="text-3xl font-bold">Deulasahi Bazar Committee</h1>
                        <p class="text-blue-100 mt-2">Member Dashboard</p>
                    </div>
                    <button id="memberLogoutBtn" type="button" class="hidden sm:inline px-3 py-1 bg-gray-200 text-gray-800 rounded">Logout</button>
                </div>
            </div>
        </header>

        <!-- Member Navigation -->
        <nav class="bg-white shadow-sm border-b no-print">
            <div class="max-w-7xl mx-auto px-1">
                <div class="flex">
                    <button onclick="showMemberSection('memberDashboard')" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-blue-500 text-blue-600 text-center">Dashboard</button>
                    <button onclick="showMemberSection('memberAccount')" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center">My Account</button>
                    <button onclick="showMemberSection('memberTransactions')" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center">Transactions</button>
                    <button onclick="showMemberSection('memberStatements')" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center">Statements</button>
                </div>
            </div>
        </nav>

        <!-- Member Content -->
        <main class="max-w-7xl mx-auto px-2 sm:px-4 py-4 sm:py-6">
            <!-- Member Dashboard -->
            <div id="memberDashboard" class="member-section">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="glass-card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Account Status</p>
                                <p class="text-2xl font-bold text-blue-600 status">Active</p>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Current Balance</p>
                                <p class="text-2xl font-bold balance">₹0.00</p>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-xl p-6 shadow-lg">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-100">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Transactions</p>
                                <p class="text-2xl font-bold text-purple-600 txCount">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="glass-card rounded-xl shadow-lg recent">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Recent Activity</h3>
                    </div>
                    <div class="p-6">
                        <div id="memberRecentActivity" class="space-y-4">
                            <p class="text-gray-500 text-center py-8">No recent activity</p>
                        </div>
                    </div>
                </div>
                
                <!-- Member Content Container -->
                <div id="memberContent"></div>
            </div>

            <!-- Member Account Info -->
            <div id="memberAccount" class="member-section hidden">
                <div class="glass-card rounded-xl shadow-lg">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Account Information</h3>
                    </div>
                    <div class="p-6">
                        <div id="memberAccountInfo" class="space-y-4">
                            <p class="text-gray-500 text-center py-8">Loading account information...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Member Transactions -->
            <div id="memberTransactions" class="member-section hidden">
                <div class="glass-card rounded-xl shadow-lg">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">My Transactions</h3>
                            <select id="memberTransactionFilter" class="mt-4 sm:mt-0 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="all">All Transactions</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                            </select>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="memberTransactionList" class="space-y-3">
                            <p class="text-gray-500 text-center py-8">No transactions found</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Member Statements -->
            <div id="memberStatements" class="member-section hidden">
                <div class="glass-card rounded-xl shadow-lg">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">Account Statement</h3>
                            <div class="mt-4 sm:mt-0 flex gap-2">
                                <select id="memberStatementPeriod" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="month">This Month</option>
                                    <option value="quarter">This Quarter</option>
                                    <option value="6months">Last 6 Months</option>
                                    <option value="year">This Year</option>
                                    <option value="all">All Time</option>
                                </select>
                                <button onclick="generateMemberStatement()" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                                    Generate
                                </button>
                                <button onclick="downloadMemberPDF()" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                                    PDF
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="memberStatementContent">
                            <p class="text-gray-500 text-center py-8">Click Generate to view your statement</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </section>

    <!-- Admin UI -->
    <section id="adminUI" style="display:none">
        <!-- App Area (ପୁରା ଆପ୍ କନ୍ଟେନ୍ଟ)—ଏଠି ଆପଣଙ୍କ ବର୍ତ୍ତମାନ main/app div କୁ ରାପ୍ କରନ୍ତୁ -->
        <div id="appArea">
        <!-- Header -->
        <header class="gradient-bg text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="flex justify-between items-center">
                <div class="text-center flex-1">
                    <h1 class="text-3xl font-bold">Deulasahi Bazar Committee</h1>
                    <p class="text-blue-100 mt-2">Deulasahi Road, Tulsipur, Cuttack</p>
                    <p class="text-blue-100">Professional Accounting System</p>
                </div>
                <!-- ଚାହିଲେ topbar ରେ Logout ବଟନ୍ ଯୋଡନ୍ତୁ -->
                <button id="adminLogoutBtn" type="button" class="hidden sm:inline px-3 py-1 bg-gray-200 text-gray-800 rounded">Logout</button>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b no-print">
        <div class="max-w-7xl mx-auto px-1">
            <div class="flex">
                <button onclick="showSection('dashboard', event)" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-blue-500 text-blue-600 text-center">Dashboard</button>
                <button onclick="showSection('transactions', event)" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center">Transactions</button>
                <button onclick="showSection('accounts', event)" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center">Accounts</button>
                <button onclick="showSection('statements', event)" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center">Statements</button>
                <button onclick="showSection('reports', event)" class="nav-btn flex-1 px-1 py-3 text-xs font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-center">Reports</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-2 sm:px-4 py-4 sm:py-6">
        <!-- Dashboard Section -->
        <div id="dashboard" class="section">
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-6 mb-6 sm:mb-8">
                <div class="glass-card rounded-lg sm:rounded-xl p-3 sm:p-6 shadow-lg">
                    <div class="flex flex-col sm:flex-row sm:items-center">
                        <div class="p-2 sm:p-3 rounded-full bg-green-100 self-center sm:self-auto">
                            <svg class="w-4 h-4 sm:w-6 sm:h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                        </div>
                        <div class="mt-2 sm:mt-0 sm:ml-4 text-center sm:text-left">
                            <p class="text-xs sm:text-sm font-medium text-gray-600">Total Credit</p>
                            <p class="text-lg sm:text-2xl font-bold text-green-600" id="totalCredit">₹0</p>
                        </div>
                    </div>
                </div>

                <div class="glass-card rounded-lg sm:rounded-xl p-3 sm:p-6 shadow-lg">
                    <div class="flex flex-col sm:flex-row sm:items-center">
                        <div class="p-2 sm:p-3 rounded-full bg-red-100 self-center sm:self-auto">
                            <svg class="w-4 h-4 sm:w-6 sm:h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                        </div>
                        <div class="mt-2 sm:mt-0 sm:ml-4 text-center sm:text-left">
                            <p class="text-xs sm:text-sm font-medium text-gray-600">Total Debit</p>
                            <p class="text-lg sm:text-2xl font-bold text-red-600" id="totalDebit">₹0</p>
                        </div>
                    </div>
                </div>

                <div class="glass-card rounded-lg sm:rounded-xl p-3 sm:p-6 shadow-lg">
                    <div class="flex flex-col sm:flex-row sm:items-center">
                        <div class="p-2 sm:p-3 rounded-full bg-blue-100 self-center sm:self-auto">
                            <svg class="w-4 h-4 sm:w-6 sm:h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <div class="mt-2 sm:mt-0 sm:ml-4 text-center sm:text-left">
                            <p class="text-xs sm:text-sm font-medium text-gray-600">Net Balance</p>
                            <p class="text-lg sm:text-2xl font-bold" id="netBalance">₹0</p>
                        </div>
                    </div>
                </div>

                <div class="glass-card rounded-lg sm:rounded-xl p-3 sm:p-6 shadow-lg">
                    <div class="flex flex-col sm:flex-row sm:items-center">
                        <div class="p-2 sm:p-3 rounded-full bg-purple-100 self-center sm:self-auto">
                            <svg class="w-4 h-4 sm:w-6 sm:h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                        </div>
                        <div class="mt-2 sm:mt-0 sm:ml-4 text-center sm:text-left">
                            <p class="text-xs sm:text-sm font-medium text-gray-600">Total Accounts</p>
                            <p class="text-lg sm:text-2xl font-bold text-purple-600" id="totalAccounts">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Transactions -->
            <div class="glass-card rounded-xl shadow-lg">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">Recent Transactions</h3>
                </div>
                <div class="p-6">
                    <div id="recentTransactions" class="space-y-4">
                        <p class="text-gray-500 text-center py-8">No transactions yet. Add your first transaction!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transactions Section -->
        <div id="transactions" class="section hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Add Transaction Form -->
                <div class="lg:col-span-1">
                    <div class="glass-card rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-6">Add New Transaction</h3>
                        <form id="transactionForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                                <input type="date" id="transactionDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Account</label>
                                <select id="transactionAccount" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Select Account</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                                <select id="transactionType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Select Type</option>
                                    <option value="credit">Credit (+)</option>
                                    <option value="debit">Debit (-)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Amount (₹)</label>
                                <input type="number" id="transactionAmount" step="0.01" min="0" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                <textarea id="transactionDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Transaction details..."></textarea>
                            </div>
                            
                            <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                                Add Transaction
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Transaction History -->
                <div class="lg:col-span-2">
                    <div class="glass-card rounded-xl shadow-lg">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                                <h3 class="text-lg font-semibold text-gray-900">Transaction History</h3>
                                <div class="mt-4 sm:mt-0 flex space-x-2">
                                    <select id="historyFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                        <option value="all">All Transactions</option>
                                        <option value="today">Today</option>
                                        <option value="week">This Week</option>
                                        <option value="month">This Month</option>
                                        <option value="quarter">This Quarter</option>
                                        <option value="6months">Last 6 Months</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="p-6">
                            <div id="transactionHistory" class="space-y-3">
                                <p class="text-gray-500 text-center py-8">No transactions found</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Accounts Section -->
        <div id="accounts" class="section hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Add Account Form -->
                <div class="lg:col-span-1">
                    <div class="glass-card rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-6">Add New Account</h3>
                        <form id="accountForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Shopkeeper Name</label>
                                <input type="text" id="accountName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter shopkeeper name">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Shop/Business Name</label>
                                <input type="text" id="businessName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter business name">
                            </div>
                            

                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Contact Number</label>
                                <input type="tel" id="contactNumber" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter contact number">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Member User ID (UID)</label>
                                <input type="text" id="memberUid" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter member's Firebase UID">
                                <p class="text-xs text-gray-500 mt-1">Optional: Link this account to a specific member for login access</p>
                            </div>
                            
                            <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors">
                                Add Account
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Accounts List -->
                <div class="lg:col-span-2">
                    <div class="glass-card rounded-xl shadow-lg">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900">All Accounts</h3>
                        </div>
                        <div class="p-6">
                            <div id="accountsList" class="space-y-4">
                                <p class="text-gray-500 text-center py-8">No accounts yet. Add your first account!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statements Section -->
        <div id="statements" class="section hidden">
            <div class="glass-card rounded-xl shadow-lg">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                        <h3 class="text-lg font-semibold text-gray-900">Account Statements</h3>
                        <div class="mt-4 sm:mt-0 space-y-2 sm:space-y-0 sm:flex sm:flex-wrap sm:gap-2">
                            <select id="statementAccount" class="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="">Select Account</option>
                            </select>
                            <select id="statementPeriod" class="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                                <option value="6months">Last 6 Months</option>
                                <option value="year">This Year</option>
                                <option value="all">All Time</option>
                            </select>
                            <div class="flex gap-2">
                                <button onclick="generateStatement()" class="flex-1 sm:flex-none px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                                    Generate
                                </button>
                                <button onclick="downloadPDF()" class="flex-1 sm:flex-none px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                                    PDF
                                </button>
                                <button onclick="shareStatement()" class="flex-1 sm:flex-none px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm">
                                    Share
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <div id="statementContent">
                        <p class="text-gray-500 text-center py-8">Select an account and period to generate statement</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reports" class="section hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass-card rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-6">Monthly Summary</h3>
                    <div id="monthlySummary" class="space-y-4">
                        <p class="text-gray-500 text-center py-8">No data available</p>
                    </div>
                </div>
                
                <div class="glass-card rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-6">Account Balances</h3>
                    <div id="accountBalances" class="space-y-4">
                        <p class="text-gray-500 text-center py-8">No accounts available</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
            <span class="text-gray-700">Loading data from server...</span>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 right-4 z-50 hidden">
        <div class="bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span id="toastMessage">Success!</span>
        </div>
    </div>

    <!-- Edit Account Popup -->
    <div id="editAccountPopup" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4">
            <div class="p-6">
                <div class="text-center mb-6">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                        <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900">Edit Account</h3>
                    <p class="text-sm text-gray-600 mt-2">Update account information</p>
                </div>
                
                <form id="editAccountForm" class="space-y-4">
                    <input type="hidden" id="editAccountId">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Shopkeeper Name</label>
                        <input type="text" id="editAccountName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Shop/Business Name</label>
                        <input type="text" id="editBusinessName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Contact Number</label>
                        <input type="tel" id="editContactNumber" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Opening Balance (₹)</label>
                        <input type="number" id="editOpeningBalance" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter opening balance">
                        <p class="text-xs text-gray-500 mt-1">Note: Changing this will recalculate the current balance</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Member User ID (UID)</label>
                        <input type="text" id="editMemberUid" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter member's Firebase UID">
                        <p class="text-xs text-gray-500 mt-1">Optional: Link this account to a specific member for login access</p>
                    </div>
                    
                    <div class="flex space-x-3 mt-6">
                        <button type="button" onclick="closeEditAccountPopup()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                            Cancel
                        </button>
                        <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Update Account
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Popup -->
    <div id="deleteConfirmPopup" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4">
            <div class="p-6">
                <div class="text-center mb-6">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                        <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900">Delete Account</h3>
                    <p class="text-sm text-gray-600 mt-2">Are you sure you want to delete this account? This action cannot be undone.</p>
                </div>
                
                <div id="deleteAccountInfo" class="bg-gray-50 rounded-lg p-4 mb-6">
                    <!-- Account info will be populated here -->
                </div>
                
                <div class="flex space-x-3">
                    <button onclick="closeDeleteConfirmPopup()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button onclick="confirmDeleteAccount()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                        Delete Account
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily Closing Popup -->
    <div id="closingPopup" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4">
            <div class="p-6">
                <div class="text-center mb-6">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                        <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900">Day Closing Summary</h3>
                    <p class="text-sm text-gray-600 mt-2">Today's balances will carry forward as tomorrow's opening balance</p>
                </div>
                
                <div id="closingSummary" class="space-y-3 mb-6">
                    <!-- Summary content will be populated here -->
                </div>
                
                <div class="flex space-x-3">
                    <button onclick="closeClosingPopup()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Close
                    </button>
                    <button onclick="generateClosingReport()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Download Report
                    </button>
                </div>
            </div>
        </div>
    </div>
    </div> <!-- End of mainApp container -->

    <script>
        // Data Storage
        let accounts = [];
        let transactions = [];

        // Initialize app - now called from Firebase auth state change
        // document.addEventListener('DOMContentLoaded', function() {
        //     // Wait for Firebase to be available
        //     setTimeout(() => {
        //         initializeApp();
        //     }, 1000);
        // });

        // Initialize application data
        async function initializeAppUI() {
            showLoading();
            
            try {
                // Set today's date as default
                document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
                
                // Try to load data from Firebase first
                try {
                    await loadAccountsFromFirebase();
                    await loadTransactionsFromFirebase();
                    
                    // Set up real-time listeners if Firebase works
                    setupRealtimeListeners();
                    
                    showToast('Data loaded from cloud!');
                } catch (firebaseError) {
                    console.warn('Firebase unavailable, loading from local storage:', firebaseError);
                    
                    // Fallback to local storage
                    loadAccountsFromLocal();
                    loadTransactionsFromLocal();
                    
                    showToast('Data loaded locally (offline mode)', 'error');
                }
                
                updateDashboard();
                updateReports();
                
                // Check if we should show daily closing popup
                checkDailyClosing();
                
            } catch (error) {
                console.error('Error initializing app:', error);
                showToast('Error loading data', 'error');
            } finally {
                hideLoading();
            }
        }

        // Loading functions
        function showLoading() {
            document.getElementById('loadingIndicator').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingIndicator').classList.add('hidden');
        }

        // Firebase Data Functions
        async function loadAccountsFromFirebase() {
            try {
                const querySnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'accounts'));
                accounts = [];
                querySnapshot.forEach((doc) => {
                    accounts.push({ id: doc.id, ...doc.data() });
                });
                loadAccounts();
            } catch (error) {
                console.error('Error loading accounts:', error);
                throw error; // Re-throw to trigger fallback
            }
        }

        // Local Storage Functions
        function loadAccountsFromLocal() {
            try {
                const localAccounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                accounts = localAccounts;
                loadAccounts();
            } catch (error) {
                console.error('Error loading accounts from local storage:', error);
                accounts = [];
                loadAccounts();
            }
        }

        async function loadTransactionsFromFirebase() {
            try {
                const q = window.firestore.query(
                    window.firestore.collection(window.db, 'transactions'),
                    window.firestore.orderBy('createdAt', 'desc')
                );
                const querySnapshot = await window.firestore.getDocs(q);
                transactions = [];
                querySnapshot.forEach((doc) => {
                    transactions.push({ id: doc.id, ...doc.data() });
                });
                loadTransactions();
            } catch (error) {
                console.error('Error loading transactions:', error);
                throw error; // Re-throw to trigger fallback
            }
        }

        function loadTransactionsFromLocal() {
            try {
                const localTransactions = JSON.parse(localStorage.getItem('transactions') || '[]');
                transactions = localTransactions;
                loadTransactions();
            } catch (error) {
                console.error('Error loading transactions from local storage:', error);
                transactions = [];
                loadTransactions();
            }
        }

        function startAccountsListener() {
            const q = query(collection(db, 'accounts'), orderBy('createdAt', 'desc'));
            onSnapshot(q,
                (snap) => {
                    const rows = [];
                    snap.forEach(d => rows.push({ id: d.id, ...d.data() }));
                    renderAccounts(rows);
                },
                (err) => {
                    console.error('Firestore onSnapshot error:', err);
                    alert(err.message || 'Failed to load data');
                }
            );
        }

        function renderAccounts(accountsData) {
            accounts = accountsData;
            loadAccounts();
            updateDashboard();
            updateReports();
        }

        function setupRealtimeListeners() {
            // Start accounts listener
            startAccountsListener();

            // Listen for transaction changes
            const q = window.firestore.query(
                window.firestore.collection(window.db, 'transactions'),
                window.firestore.orderBy('createdAt', 'desc')
            );
            window.firestore.onSnapshot(q, (snapshot) => {
                transactions = [];
                snapshot.forEach((doc) => {
                    transactions.push({ id: doc.id, ...doc.data() });
                });
                loadTransactions();
                updateDashboard();
                updateReports();
            });
        }

        // Navigation
        function showSection(sectionName, ev) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show selected section
            document.getElementById(sectionName).classList.remove('hidden');
            
            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            (ev && ev.target) && ev.target.classList.remove('border-transparent', 'text-gray-500');
            (ev && ev.target) && ev.target.classList.add('border-blue-500', 'text-blue-600');
        }

        // Account Management
        document.getElementById('accountForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const accountName = document.getElementById('accountName').value.trim();
            const businessName = document.getElementById('businessName').value.trim();
            const contactNumber = document.getElementById('contactNumber').value.trim();
            const memberUid = document.getElementById('memberUid').value.trim();
            
            if (!accountName) {
                showToast('Please enter shopkeeper name', 'error');
                return;
            }
            
            const account = {
                name: accountName,
                businessName: businessName || '',
                openingBalance: 0,
                contactNumber: contactNumber || '',
                currentBalance: 0,
                status: 'Active',
                createdAt: serverTimestamp(),
                // Link to member user if UID provided
                ownerUid: memberUid || null
            };
            
            try {
                showLoading();
                
                // Check if Firebase is available
                if (!window.db || !window.firestore) {
                    throw new Error('Firebase not initialized');
                }
                
                await window.firestore.addDoc(window.firestore.collection(window.db, 'accounts'), account);
                
                // Reset form
                this.reset();
                
                showToast('Account added successfully!');
            } catch (error) {
                console.error('Error adding account:', error);
                
                // Fallback to local storage if Firebase fails
                try {
                    const localAccounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                    const newAccount = {
                        ...account,
                        id: Date.now().toString() // Simple ID for local storage
                    };
                    localAccounts.push(newAccount);
                    localStorage.setItem('accounts', JSON.stringify(localAccounts));
                    
                    // Update local accounts array
                    accounts.push(newAccount);
                    loadAccounts();
                    updateDashboard();
                    
                    // Reset form
                    this.reset();
                    
                    showToast('Account added successfully (saved locally)!');
                } catch (localError) {
                    console.error('Local storage error:', localError);
                    showToast('Error adding account. Please try again.', 'error');
                }
            } finally {
                hideLoading();
            }
        });

        function loadAccounts() {
            const accountsList = document.getElementById('accountsList');
            const transactionAccount = document.getElementById('transactionAccount');
            const statementAccount = document.getElementById('statementAccount');
            
            if (accounts.length === 0) {
                accountsList.innerHTML = '<p class="text-gray-500 text-center py-8">No accounts yet. Add your first account!</p>';
                transactionAccount.innerHTML = '<option value="">Select Account</option>';
                statementAccount.innerHTML = '<option value="">Select Account</option>';
                return;
            }
            
            // Update accounts list
            accountsList.innerHTML = accounts.map(account => `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900">${account.name}</h4>
                            ${account.businessName ? `<p class="text-sm text-gray-600">${account.businessName}</p>` : ''}
                            ${account.contactNumber ? `<p class="text-sm text-gray-500">${account.contactNumber}</p>` : ''}
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-500">Current Balance</p>
                            <p class="text-lg font-bold ${account.currentBalance >= 0 ? 'balance-positive' : 'balance-negative'}">
                                ₹${Number(account.currentBalance ?? 0).toFixed(2)}
                            </p>
                        </div>
                    </div>
                    <div class="mt-4 pt-3 border-t border-gray-100">
                        <div class="text-sm text-gray-500 mb-3">
                            <div>Opening: ₹${Number(account.openingBalance ?? 0).toFixed(2)}</div>
                            <div>Created: ${
                              account.createdAt && account.createdAt.toDate
                                ? account.createdAt.toDate().toLocaleDateString()
                                : (account.createdAt
                                    ? new Date(account.createdAt).toLocaleDateString()
                                    : '')
                            }</div>
                            ${account.ownerUid ? `<div class="text-xs text-blue-600">Linked to Member: ${account.ownerUid.substring(0, 8)}...</div>` : '<div class="text-xs text-gray-400">No member linked</div>'}
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editAccount('${account.id}')" class="flex-1 px-4 py-2 bg-blue-500 text-white text-sm font-medium rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center space-x-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                                <span>Edit</span>
                            </button>
                            <button onclick="deleteAccount('${account.id}')" class="flex-1 px-4 py-2 bg-red-500 text-white text-sm font-medium rounded-lg hover:bg-red-600 transition-colors flex items-center justify-center space-x-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                <span>Delete</span>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Update dropdowns
            const accountOptions = accounts.map(account => 
                `<option value="${account.id}">${account.name}${account.businessName ? ` (${account.businessName})` : ''}</option>`
            ).join('');
            
            transactionAccount.innerHTML = '<option value="">Select Account</option>' + accountOptions;
            statementAccount.innerHTML = '<option value="">Select Account</option>' + accountOptions;
        }

        // Transaction Management
        document.getElementById('transactionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const accountId = document.getElementById('transactionAccount').value;
            const type = document.getElementById('transactionType').value;
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            
            if (!accountId || !type || !amount || amount <= 0) {
                showToast('Please fill all required fields correctly', 'error');
                return;
            }
            
            const transaction = {
                accountId: accountId,
                date: document.getElementById('transactionDate').value,
                type: type,
                amount: amount,
                description: document.getElementById('transactionDescription').value || '',
                createdAt: serverTimestamp()
            };
            
            try {
                showLoading();
                
                // Try Firebase first
                if (window.db && window.firestore) {
                    // Add transaction to Firebase
                    await window.firestore.addDoc(window.firestore.collection(window.db, 'transactions'), transaction);
                    
                    // Update account balance in Firebase
                    const account = accounts.find(acc => acc.id === accountId);
                    if (account) {
                        if (type === 'credit') {
                            account.currentBalance += amount;
                        } else {
                            account.currentBalance -= amount;
                        }
                        
                        await window.firestore.updateDoc(window.firestore.doc(window.db, 'accounts', accountId), {
                            currentBalance: account.currentBalance
                        });
                    }
                    
                    showToast('Transaction added successfully!');
                } else {
                    throw new Error('Firebase not available');
                }
                
            } catch (error) {
                console.error('Error adding transaction:', error);
                
                // Fallback to local storage
                try {
                    const newTransaction = {
                        ...transaction,
                        id: Date.now().toString()
                    };
                    
                    // Add to local transactions
                    const localTransactions = JSON.parse(localStorage.getItem('transactions') || '[]');
                    localTransactions.push(newTransaction);
                    localStorage.setItem('transactions', JSON.stringify(localTransactions));
                    
                    // Update account balance locally
                    const account = accounts.find(acc => acc.id === accountId);
                    if (account) {
                        if (type === 'credit') {
                            account.currentBalance += amount;
                        } else {
                            account.currentBalance -= amount;
                        }
                        
                        // Update local accounts
                        const localAccounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                        const accountIndex = localAccounts.findIndex(acc => acc.id === accountId);
                        if (accountIndex !== -1) {
                            localAccounts[accountIndex] = account;
                            localStorage.setItem('accounts', JSON.stringify(localAccounts));
                        }
                    }
                    
                    // Update local arrays
                    transactions.push(newTransaction);
                    loadTransactions();
                    loadAccounts();
                    updateDashboard();
                    
                    showToast('Transaction added successfully (saved locally)!');
                } catch (localError) {
                    console.error('Local storage error:', localError);
                    showToast('Error adding transaction. Please try again.', 'error');
                }
            } finally {
                hideLoading();
                
                // Reset form
                this.reset();
                document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            }
        });

        function loadTransactions() {
            const recentTransactions = document.getElementById('recentTransactions');
            const transactionHistory = document.getElementById('transactionHistory');
            
            if (transactions.length === 0) {
                recentTransactions.innerHTML = '<p class="text-gray-500 text-center py-8">No transactions yet. Add your first transaction!</p>';
                transactionHistory.innerHTML = '<p class="text-gray-500 text-center py-8">No transactions found</p>';
                return;
            }
            
            // Sort transactions by date (newest first)
            const sortedTransactions = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Recent transactions (last 5)
            const recent = sortedTransactions.slice(0, 5);
            recentTransactions.innerHTML = recent.map(transaction => {
                const account = accounts.find(acc => acc.id === transaction.accountId);
                return `
                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg ${transaction.type === 'credit' ? 'transaction-credit' : 'transaction-debit'}">
                        <div class="flex-1">
                            <p class="font-medium text-gray-900">${account ? account.name : 'Unknown Account'}</p>
                            <p class="text-sm text-gray-600">${transaction.description || 'No description'}</p>
                            <p class="text-xs text-gray-500">${new Date(transaction.date).toLocaleDateString()}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold ${transaction.type === 'credit' ? 'text-green-600' : 'text-red-600'}">
                                ${transaction.type === 'credit' ? '+' : '-'}₹${transaction.amount.toFixed(2)}
                            </p>
                        </div>
                    </div>
                `;
            }).join('');
            
            // All transactions
            filterTransactions();
        }

        // Filter transactions
        document.getElementById('historyFilter').addEventListener('change', filterTransactions);

        function filterTransactions() {
            const filter = document.getElementById('historyFilter').value;
            const transactionHistory = document.getElementById('transactionHistory');
            
            let filteredTransactions = [...transactions];
            const now = new Date();
            
            switch (filter) {
                case 'today':
                    const today = now.toISOString().split('T')[0];
                    filteredTransactions = transactions.filter(t => t.date === today);
                    break;
                case 'week':
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    filteredTransactions = transactions.filter(t => new Date(t.date) >= weekAgo);
                    break;
                case 'month':
                    const monthAgo = new Date(now.getFullYear(), now.getMonth(), 1);
                    filteredTransactions = transactions.filter(t => new Date(t.date) >= monthAgo);
                    break;
                case 'quarter':
                    const quarterAgo = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
                    filteredTransactions = transactions.filter(t => new Date(t.date) >= quarterAgo);
                    break;
                case '6months':
                    const sixMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 6, 1);
                    filteredTransactions = transactions.filter(t => new Date(t.date) >= sixMonthsAgo);
                    break;
            }
            
            if (filteredTransactions.length === 0) {
                transactionHistory.innerHTML = '<p class="text-gray-500 text-center py-8">No transactions found for selected period</p>';
                return;
            }
            
            // Sort by date (newest first)
            filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            transactionHistory.innerHTML = filteredTransactions.map(transaction => {
                const account = accounts.find(acc => acc.id === transaction.accountId);
                return `
                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg ${transaction.type === 'credit' ? 'transaction-credit' : 'transaction-debit'}">
                        <div class="flex-1">
                            <p class="font-medium text-gray-900">${account ? account.name : 'Unknown Account'}</p>
                            <p class="text-sm text-gray-600">${transaction.description || 'No description'}</p>
                            <p class="text-xs text-gray-500">${new Date(transaction.date).toLocaleDateString()}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold ${transaction.type === 'credit' ? 'text-green-600' : 'text-red-600'}">
                                ${transaction.type === 'credit' ? '+' : '-'}₹${transaction.amount.toFixed(2)}
                            </p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Dashboard Updates
        function updateDashboard() {
            const totalCredit = transactions
                .filter(t => t.type === 'credit')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const totalDebit = transactions
                .filter(t => t.type === 'debit')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const netBalance = totalCredit - totalDebit;
            
            document.getElementById('totalCredit').textContent = `₹${totalCredit.toFixed(2)}`;
            document.getElementById('totalDebit').textContent = `₹${totalDebit.toFixed(2)}`;
            document.getElementById('totalAccounts').textContent = accounts.length;
            
            const netBalanceElement = document.getElementById('netBalance');
            netBalanceElement.textContent = `₹${netBalance.toFixed(2)}`;
            netBalanceElement.className = `text-lg sm:text-2xl font-bold ${netBalance >= 0 ? 'balance-positive' : 'balance-negative'}`;
        }

        // Statement Generation
        function generateStatement() {
            const accountId = document.getElementById('statementAccount').value;
            const period = document.getElementById('statementPeriod').value;
            
            if (!accountId) {
                showToast('Please select an account', 'error');
                return;
            }
            
            const account = accounts.find(acc => acc.id === accountId);
            if (!account) {
                showToast('Account not found', 'error');
                return;
            }
            
            // Filter transactions by account and period
            let accountTransactions = transactions.filter(t => t.accountId === accountId);
            
            const now = new Date();
            switch (period) {
                case 'month':
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    accountTransactions = accountTransactions.filter(t => new Date(t.date) >= monthStart);
                    break;
                case 'quarter':
                    const quarterStart = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
                    accountTransactions = accountTransactions.filter(t => new Date(t.date) >= quarterStart);
                    break;
                case '6months':
                    const sixMonthsStart = new Date(now.getFullYear(), now.getMonth() - 6, 1);
                    accountTransactions = accountTransactions.filter(t => new Date(t.date) >= sixMonthsStart);
                    break;
                case 'year':
                    const yearStart = new Date(now.getFullYear(), 0, 1);
                    accountTransactions = accountTransactions.filter(t => new Date(t.date) >= yearStart);
                    break;
            }
            
            // Sort by date
            accountTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Generate statement HTML
            const statementContent = document.getElementById('statementContent');
            
            if (accountTransactions.length === 0) {
                statementContent.innerHTML = '<p class="text-gray-500 text-center py-8">No transactions found for selected period</p>';
                return;
            }
            
            let runningBalance = account.openingBalance;
            const totalCredit = accountTransactions.filter(t => t.type === 'credit').reduce((sum, t) => sum + t.amount, 0);
            const totalDebit = accountTransactions.filter(t => t.type === 'debit').reduce((sum, t) => sum + t.amount, 0);
            
            statementContent.innerHTML = `
                <div class="statement-header mb-6 p-6 bg-gray-50 rounded-lg">
                    <div class="text-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-900">Deulasahi Bazar Committee</h2>
                        <p class="text-gray-600">Deulasahi Road, Tulsipur, Cuttack</p>
                        <p class="text-lg font-semibold mt-2">Account Statement</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p><strong>Account Holder:</strong> ${account.name}</p>
                            ${account.businessName ? `<p><strong>Business:</strong> ${account.businessName}</p>` : ''}
                            ${account.contactNumber ? `<p><strong>Contact:</strong> ${account.contactNumber}</p>` : ''}
                        </div>
                        <div>
                            <p><strong>Statement Period:</strong> ${getPeriodText(period)}</p>
                            <p><strong>Generated On:</strong> ${new Date().toLocaleDateString()}</p>
                            <p><strong>Opening Balance:</strong> ₹${account.openingBalance.toFixed(2)}</p>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300 min-w-full">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border border-gray-300 px-2 py-2 text-left text-xs sm:text-sm">Date</th>
                                <th class="border border-gray-300 px-2 py-2 text-left text-xs sm:text-sm">Description</th>
                                <th class="border border-gray-300 px-2 py-2 text-right text-xs sm:text-sm">Debit</th>
                                <th class="border border-gray-300 px-2 py-2 text-right text-xs sm:text-sm">Credit</th>
                                <th class="border border-gray-300 px-2 py-2 text-right text-xs sm:text-sm">Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${accountTransactions.map(transaction => {
                                if (transaction.type === 'credit') {
                                    runningBalance += transaction.amount;
                                } else {
                                    runningBalance -= transaction.amount;
                                }
                                
                                return `
                                    <tr>
                                        <td class="border border-gray-300 px-2 py-2 text-xs sm:text-sm">${new Date(transaction.date).toLocaleDateString()}</td>
                                        <td class="border border-gray-300 px-2 py-2 text-xs sm:text-sm">${transaction.description || 'No description'}</td>
                                        <td class="border border-gray-300 px-2 py-2 text-right text-xs sm:text-sm">${transaction.type === 'debit' ? '₹' + transaction.amount.toFixed(2) : '-'}</td>
                                        <td class="border border-gray-300 px-2 py-2 text-right text-xs sm:text-sm">${transaction.type === 'credit' ? '₹' + transaction.amount.toFixed(2) : '-'}</td>
                                        <td class="border border-gray-300 px-2 py-2 text-right font-semibold text-xs sm:text-sm ${runningBalance >= 0 ? 'text-green-600' : 'text-red-600'}">₹${runningBalance.toFixed(2)}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                        <tfoot>
                            <tr class="bg-gray-100 font-semibold">
                                <td class="border border-gray-300 px-2 py-2 text-xs sm:text-sm" colspan="2">Total</td>
                                <td class="border border-gray-300 px-2 py-2 text-right text-xs sm:text-sm">₹${totalDebit.toFixed(2)}</td>
                                <td class="border border-gray-300 px-2 py-2 text-right text-xs sm:text-sm">₹${totalCredit.toFixed(2)}</td>
                                <td class="border border-gray-300 px-2 py-2 text-right text-xs sm:text-sm ${account.currentBalance >= 0 ? 'text-green-600' : 'text-red-600'}">₹${account.currentBalance.toFixed(2)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div>
                            <p class="text-sm text-gray-600">Total Credit</p>
                            <p class="text-lg font-bold text-green-600">₹${totalCredit.toFixed(2)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Total Debit</p>
                            <p class="text-lg font-bold text-red-600">₹${totalDebit.toFixed(2)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Closing Balance</p>
                            <p class="text-lg font-bold ${account.currentBalance >= 0 ? 'text-green-600' : 'text-red-600'}">₹${account.currentBalance.toFixed(2)}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function getPeriodText(period) {
            const now = new Date();
            switch (period) {
                case 'month':
                    return now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                case 'quarter':
                    const quarter = Math.floor(now.getMonth() / 3) + 1;
                    return `Q${quarter} ${now.getFullYear()}`;
                case '6months':
                    return 'Last 6 Months';
                case 'year':
                    return now.getFullYear().toString();
                case 'all':
                    return 'All Time';
                default:
                    return 'Selected Period';
            }
        }

        // PDF Generation
        function downloadPDF() {
            const accountId = document.getElementById('statementAccount').value;
            if (!accountId) {
                showToast('Please generate a statement first', 'error');
                return;
            }
            
            const account = accounts.find(acc => acc.id === accountId);
            const period = document.getElementById('statementPeriod').value;
            
            // Create PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Deulasahi Bazar Committee', 105, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text('Deulasahi Road, Tulsipur, Cuttack', 105, 30, { align: 'center' });
            doc.setFont(undefined, 'bold');
            doc.text('Account Statement', 105, 40, { align: 'center' });
            
            // Account details
            doc.setFont(undefined, 'normal');
            doc.text(`Account Holder: ${account.name}`, 20, 60);
            if (account.businessName) {
                doc.text(`Business: ${account.businessName}`, 20, 70);
            }
            doc.text(`Period: ${getPeriodText(period)}`, 20, 80);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 90);
            
            // Filter transactions
            let accountTransactions = transactions.filter(t => t.accountId === accountId);
            const now = new Date();
            
            switch (period) {
                case 'month':
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    accountTransactions = accountTransactions.filter(t => new Date(t.date) >= monthStart);
                    break;
                case 'quarter':
                    const quarterStart = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
                    accountTransactions = accountTransactions.filter(t => new Date(t.date) >= quarterStart);
                    break;
                case '6months':
                    const sixMonthsStart = new Date(now.getFullYear(), now.getMonth() - 6, 1);
                    accountTransactions = accountTransactions.filter(t => new Date(t.date) >= sixMonthsStart);
                    break;
                case 'year':
                    const yearStart = new Date(now.getFullYear(), 0, 1);
                    accountTransactions = accountTransactions.filter(t => new Date(t.date) >= yearStart);
                    break;
            }
            
            accountTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Create table data
            const tableData = [];
            let runningBalance = account.openingBalance;
            
            accountTransactions.forEach(transaction => {
                if (transaction.type === 'credit') {
                    runningBalance += transaction.amount;
                } else {
                    runningBalance -= transaction.amount;
                }
                
                tableData.push([
                    new Date(transaction.date).toLocaleDateString(),
                    transaction.description || 'No description',
                    transaction.type === 'debit' ? `₹${transaction.amount.toFixed(2)}` : '-',
                    transaction.type === 'credit' ? `₹${transaction.amount.toFixed(2)}` : '-',
                    `₹${runningBalance.toFixed(2)}`
                ]);
            });
            
            // Add table
            doc.autoTable({
                head: [['Date', 'Description', 'Debit', 'Credit', 'Balance']],
                body: tableData,
                startY: 100,
                styles: { fontSize: 10 },
                headStyles: { fillColor: [59, 130, 246] }
            });
            
            // Summary
            const totalCredit = accountTransactions.filter(t => t.type === 'credit').reduce((sum, t) => sum + t.amount, 0);
            const totalDebit = accountTransactions.filter(t => t.type === 'debit').reduce((sum, t) => sum + t.amount, 0);
            
            const finalY = doc.lastAutoTable.finalY + 20;
            doc.text(`Total Credit: ₹${totalCredit.toFixed(2)}`, 20, finalY);
            doc.text(`Total Debit: ₹${totalDebit.toFixed(2)}`, 20, finalY + 10);
            doc.text(`Closing Balance: ₹${account.currentBalance.toFixed(2)}`, 20, finalY + 20);
            
            // Save PDF
            doc.save(`${account.name}_Statement_${getPeriodText(period)}.pdf`);
            
            showToast('PDF downloaded successfully!');
        }

        // Share Statement
        async function shareStatement() {
            const accountId = document.getElementById('statementAccount').value;
            if (!accountId) {
                showToast('Please generate a statement first', 'error');
                return;
            }
            
            const account = accounts.find(acc => acc.id === accountId);
            const period = document.getElementById('statementPeriod').value;
            
            try {
                showLoading();
                
                // Generate PDF blob for sharing
                const pdfBlob = await generatePDFBlob(accountId, period);
                const fileName = `${account.name}_Statement_${getPeriodText(period)}.pdf`;
                
                if (navigator.share && navigator.canShare) {
                    // Create a File object from the blob
                    const file = new File([pdfBlob], fileName, { type: 'application/pdf' });
                    
                    // Check if files can be shared
                    if (navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            title: `Account Statement - ${account.name}`,
                            text: `Account statement for ${account.name} - ${getPeriodText(period)}`,
                            files: [file]
                        });
                        showToast('PDF statement shared successfully!');
                    } else {
                        // Fallback to download if file sharing not supported
                        downloadPDFFromBlob(pdfBlob, fileName);
                        showToast('File sharing not supported. PDF downloaded instead.');
                    }
                } else {
                    // Fallback for browsers without Web Share API
                    downloadPDFFromBlob(pdfBlob, fileName);
                    showToast('PDF downloaded - you can now share it manually!');
                }
                
            } catch (error) {
                console.error('Error sharing PDF:', error);
                showToast('Error generating PDF for sharing', 'error');
            } finally {
                hideLoading();
            }
        }

        // Generate PDF as blob for sharing
        async function generatePDFBlob(accountId, period) {
            const account = accounts.find(acc => acc.id === accountId);
            
            // Create PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Deulasahi Bazar Committee', 105, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text('Deulasahi Road, Tulsipur, Cuttack', 105, 30, { align: 'center' });
            doc.setFont(undefined, 'bold');
            doc.text('Account Statement', 105, 40, { align: 'center' });
            
            // Account details
            doc.setFont(undefined, 'normal');
            doc.text(`Account Holder: ${account.name}`, 20, 60);
            if (account.businessName) {
                doc.text(`Business: ${account.businessName}`, 20, 70);
            }
            doc.text(`Period: ${getPeriodText(period)}`, 20, 80);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 90);
            
            // Filter transactions
            let accountTransactions = transactions.filter(t => t.accountId === accountId);
            const now = new Date();
            
            switch (period) {
                case 'month':
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    accountTransactions = accountTransactions.filter(t => new Date(t.date) >= monthStart);
                    break;
                case 'quarter':
                    const quarterStart = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
                    accountTransactions = accountTransactions.filter(t => new Date(t.date) >= quarterStart);
                    break;
                case '6months':
                    const sixMonthsStart = new Date(now.getFullYear(), now.getMonth() - 6, 1);
                    accountTransactions = accountTransactions.filter(t => new Date(t.date) >= sixMonthsStart);
                    break;
                case 'year':
                    const yearStart = new Date(now.getFullYear(), 0, 1);
                    accountTransactions = accountTransactions.filter(t => new Date(t.date) >= yearStart);
                    break;
            }
            
            accountTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Create table data
            const tableData = [];
            let runningBalance = account.openingBalance;
            
            accountTransactions.forEach(transaction => {
                if (transaction.type === 'credit') {
                    runningBalance += transaction.amount;
                } else {
                    runningBalance -= transaction.amount;
                }
                
                tableData.push([
                    new Date(transaction.date).toLocaleDateString(),
                    transaction.description || 'No description',
                    transaction.type === 'debit' ? `₹${transaction.amount.toFixed(2)}` : '-',
                    transaction.type === 'credit' ? `₹${transaction.amount.toFixed(2)}` : '-',
                    `₹${runningBalance.toFixed(2)}`
                ]);
            });
            
            // Add table
            doc.autoTable({
                head: [['Date', 'Description', 'Debit', 'Credit', 'Balance']],
                body: tableData,
                startY: 100,
                styles: { fontSize: 10 },
                headStyles: { fillColor: [59, 130, 246] }
            });
            
            // Summary
            const totalCredit = accountTransactions.filter(t => t.type === 'credit').reduce((sum, t) => sum + t.amount, 0);
            const totalDebit = accountTransactions.filter(t => t.type === 'debit').reduce((sum, t) => sum + t.amount, 0);
            
            const finalY = doc.lastAutoTable.finalY + 20;
            doc.text(`Total Credit: ₹${totalCredit.toFixed(2)}`, 20, finalY);
            doc.text(`Total Debit: ₹${totalDebit.toFixed(2)}`, 20, finalY + 10);
            doc.text(`Closing Balance: ₹${account.currentBalance.toFixed(2)}`, 20, finalY + 20);
            
            // Return as blob
            return doc.output('blob');
        }

        // Download PDF from blob
        function downloadPDFFromBlob(blob, fileName) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Reports
        function updateReports() {
            updateMonthlySummary();
            updateAccountBalances();
        }

        function updateMonthlySummary() {
            const monthlySummary = document.getElementById('monthlySummary');
            
            if (transactions.length === 0) {
                monthlySummary.innerHTML = '<p class="text-gray-500 text-center py-8">No data available</p>';
                return;
            }
            
            // Group transactions by month
            const monthlyData = {};
            transactions.forEach(transaction => {
                const date = new Date(transaction.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { credit: 0, debit: 0 };
                }
                
                if (transaction.type === 'credit') {
                    monthlyData[monthKey].credit += transaction.amount;
                } else {
                    monthlyData[monthKey].debit += transaction.amount;
                }
            });
            
            // Sort by month (newest first)
            const sortedMonths = Object.keys(monthlyData).sort().reverse();
            
            monthlySummary.innerHTML = sortedMonths.map(month => {
                const data = monthlyData[month];
                const net = data.credit - data.debit;
                const [year, monthNum] = month.split('-');
                const monthName = new Date(year, monthNum - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                
                return `
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-900 mb-2">${monthName}</h4>
                        <div class="grid grid-cols-3 gap-4 text-sm">
                            <div>
                                <p class="text-gray-600">Credit</p>
                                <p class="font-semibold text-green-600">₹${data.credit.toFixed(2)}</p>
                            </div>
                            <div>
                                <p class="text-gray-600">Debit</p>
                                <p class="font-semibold text-red-600">₹${data.debit.toFixed(2)}</p>
                            </div>
                            <div>
                                <p class="text-gray-600">Net</p>
                                <p class="font-semibold ${net >= 0 ? 'text-green-600' : 'text-red-600'}">₹${net.toFixed(2)}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateAccountBalances() {
            const accountBalances = document.getElementById('accountBalances');
            
            if (accounts.length === 0) {
                accountBalances.innerHTML = '<p class="text-gray-500 text-center py-8">No accounts available</p>';
                return;
            }
            
            // Sort accounts by balance (highest first)
            const sortedAccounts = [...accounts].sort((a, b) => b.currentBalance - a.currentBalance);
            
            accountBalances.innerHTML = sortedAccounts.map(account => `
                <div class="flex justify-between items-center p-4 border border-gray-200 rounded-lg">
                    <div>
                        <p class="font-semibold text-gray-900">${account.name}</p>
                        ${account.businessName ? `<p class="text-sm text-gray-600">${account.businessName}</p>` : ''}
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-bold ${account.currentBalance >= 0 ? 'balance-positive' : 'balance-negative'}">
                            ₹${account.currentBalance.toFixed(2)}
                        </p>
                    </div>
                </div>
            `).join('');
        }

        // Daily Closing Functions
        function checkDailyClosing() {
            const lastClosing = localStorage.getItem('lastClosingDate');
            const today = new Date().toISOString().split('T')[0];
            
            // Show popup if it's a new day and there are transactions
            if (lastClosing !== today && transactions.length > 0) {
                setTimeout(() => {
                    showDailyClosingPopup();
                }, 2000); // Show after 2 seconds
            }
        }

        function showDailyClosingPopup() {
            const popup = document.getElementById('closingPopup');
            const summary = document.getElementById('closingSummary');
            
            // Calculate today's summary
            const today = new Date().toISOString().split('T')[0];
            const todayTransactions = transactions.filter(t => t.date === today);
            
            if (todayTransactions.length === 0) {
                return; // Don't show if no transactions today
            }
            
            const todayCredit = todayTransactions.filter(t => t.type === 'credit').reduce((sum, t) => sum + t.amount, 0);
            const todayDebit = todayTransactions.filter(t => t.type === 'debit').reduce((sum, t) => sum + t.amount, 0);
            
            summary.innerHTML = `
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="font-semibold text-gray-900 mb-3">Today's Summary (${new Date().toLocaleDateString()})</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <p class="text-gray-600">Total Credit</p>
                            <p class="font-semibold text-green-600">₹${todayCredit.toFixed(2)}</p>
                        </div>
                        <div>
                            <p class="text-gray-600">Total Debit</p>
                            <p class="font-semibold text-red-600">₹${todayDebit.toFixed(2)}</p>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-200">
                        <p class="text-gray-600 text-sm">Net: <span class="font-semibold ${(todayCredit - todayDebit) >= 0 ? 'text-green-600' : 'text-red-600'}">₹${(todayCredit - todayDebit).toFixed(2)}</span></p>
                    </div>
                </div>
                
                <div class="text-sm text-gray-600">
                    <p><strong>Account Balances:</strong></p>
                    <div class="mt-2 space-y-1 max-h-32 overflow-y-auto">
                        ${accounts.map(account => `
                            <div class="flex justify-between">
                                <span>${account.name}</span>
                                <span class="font-medium ${account.currentBalance >= 0 ? 'text-green-600' : 'text-red-600'}">₹${account.currentBalance.toFixed(2)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            popup.classList.remove('hidden');
        }

        function closeClosingPopup() {
            const popup = document.getElementById('closingPopup');
            popup.classList.add('hidden');
            
            // Mark today as closed
            const today = new Date().toISOString().split('T')[0];
            localStorage.setItem('lastClosingDate', today);
        }

        function generateClosingReport() {
            const today = new Date().toISOString().split('T')[0];
            const todayTransactions = transactions.filter(t => t.date === today);
            
            if (todayTransactions.length === 0) {
                showToast('No transactions found for today', 'error');
                return;
            }
            
            // Create PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Deulasahi Bazar Committee', 105, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text('Daily Closing Report', 105, 30, { align: 'center' });
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 105, 40, { align: 'center' });
            
            // Summary
            const todayCredit = todayTransactions.filter(t => t.type === 'credit').reduce((sum, t) => sum + t.amount, 0);
            const todayDebit = todayTransactions.filter(t => t.type === 'debit').reduce((sum, t) => sum + t.amount, 0);
            
            doc.text(`Total Credit: ₹${todayCredit.toFixed(2)}`, 20, 60);
            doc.text(`Total Debit: ₹${todayDebit.toFixed(2)}`, 20, 70);
            doc.text(`Net Amount: ₹${(todayCredit - todayDebit).toFixed(2)}`, 20, 80);
            
            // Account balances
            doc.text('Account Balances:', 20, 100);
            let yPos = 110;
            accounts.forEach(account => {
                doc.text(`${account.name}: ₹${account.currentBalance.toFixed(2)}`, 20, yPos);
                yPos += 10;
            });
            
            // Save PDF
            doc.save(`Daily_Closing_Report_${today}.pdf`);
            
            closeClosingPopup();
            showToast('Daily closing report downloaded!');
        }

        // Account Edit Functions
        let accountToDelete = null;

        function editAccount(accountId) {
            const account = accounts.find(acc => acc.id === accountId);
            if (!account) {
                showToast('Account not found', 'error');
                return;
            }

            // Populate edit form
            document.getElementById('editAccountId').value = accountId;
            document.getElementById('editAccountName').value = account.name;
            document.getElementById('editBusinessName').value = account.businessName || '';
            document.getElementById('editContactNumber').value = account.contactNumber || '';
            document.getElementById('editOpeningBalance').value = account.openingBalance || 0;
            document.getElementById('editMemberUid').value = account.ownerUid || '';

            // Show popup
            document.getElementById('editAccountPopup').classList.remove('hidden');
        }

        function closeEditAccountPopup() {
            document.getElementById('editAccountPopup').classList.add('hidden');
            document.getElementById('editAccountForm').reset();
        }

        // Edit Account Form Handler
        document.getElementById('editAccountForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const accountId = document.getElementById('editAccountId').value;
            const accountName = document.getElementById('editAccountName').value.trim();
            const businessName = document.getElementById('editBusinessName').value.trim();
            const contactNumber = document.getElementById('editContactNumber').value.trim();
            const newOpeningBalance = parseFloat(document.getElementById('editOpeningBalance').value) || 0;
            const memberUid = document.getElementById('editMemberUid').value.trim();
            
            if (!accountName) {
                showToast('Please enter shopkeeper name', 'error');
                return;
            }
            
            try {
                showLoading();
                
                // Find the account to get current opening balance
                const currentAccount = accounts.find(acc => acc.id === accountId);
                const oldOpeningBalance = currentAccount ? currentAccount.openingBalance : 0;
                
                // Calculate new current balance if opening balance changed
                let newCurrentBalance = currentAccount ? currentAccount.currentBalance : 0;
                if (newOpeningBalance !== oldOpeningBalance) {
                    // Recalculate current balance: new opening + all transactions
                    const accountTransactions = transactions.filter(t => t.accountId === accountId);
                    const totalCredit = accountTransactions.filter(t => t.type === 'credit').reduce((sum, t) => sum + t.amount, 0);
                    const totalDebit = accountTransactions.filter(t => t.type === 'debit').reduce((sum, t) => sum + t.amount, 0);
                    newCurrentBalance = newOpeningBalance + totalCredit - totalDebit;
                }
                
                const updatedData = {
                    name: accountName,
                    businessName: businessName || '',
                    contactNumber: contactNumber || '',
                    openingBalance: newOpeningBalance,
                    currentBalance: newCurrentBalance,
                    ownerUid: memberUid || null
                };
                
                // Try Firebase first
                if (window.db && window.firestore) {
                    await window.firestore.updateDoc(window.firestore.doc(window.db, 'accounts', accountId), updatedData);
                    showToast('Account updated successfully!');
                } else {
                    throw new Error('Firebase not available');
                }
                
            } catch (error) {
                console.error('Error updating account:', error);
                
                // Fallback to local storage
                try {
                    // Update local accounts array
                    const accountIndex = accounts.findIndex(acc => acc.id === accountId);
                    if (accountIndex !== -1) {
                        accounts[accountIndex] = { ...accounts[accountIndex], ...updatedData };
                        
                        // Update local storage
                        const localAccounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                        const localIndex = localAccounts.findIndex(acc => acc.id === accountId);
                        if (localIndex !== -1) {
                            localAccounts[localIndex] = accounts[accountIndex];
                            localStorage.setItem('accounts', JSON.stringify(localAccounts));
                        }
                        
                        loadAccounts();
                        updateDashboard();
                        showToast('Account updated successfully (saved locally)!');
                    }
                } catch (localError) {
                    console.error('Local storage error:', localError);
                    showToast('Error updating account. Please try again.', 'error');
                }
            } finally {
                hideLoading();
                closeEditAccountPopup();
            }
        });

        function deleteAccount(accountId) {
            const account = accounts.find(acc => acc.id === accountId);
            if (!account) {
                showToast('Account not found', 'error');
                return;
            }

            // Check if account has transactions
            const accountTransactions = transactions.filter(t => t.accountId === accountId);
            
            accountToDelete = accountId;
            
            // Show account info in delete confirmation
            document.getElementById('deleteAccountInfo').innerHTML = `
                <div class="text-sm">
                    <p><strong>Account:</strong> ${account.name}</p>
                    ${account.businessName ? `<p><strong>Business:</strong> ${account.businessName}</p>` : ''}
                    <p><strong>Current Balance:</strong> <span class="${account.currentBalance >= 0 ? 'text-green-600' : 'text-red-600'}">₹${account.currentBalance.toFixed(2)}</span></p>
                    <p><strong>Total Transactions:</strong> ${accountTransactions.length}</p>
                    ${accountTransactions.length > 0 ? '<p class="text-red-600 mt-2"><strong>Warning:</strong> All transactions for this account will also be deleted!</p>' : ''}
                </div>
            `;

            // Show popup
            document.getElementById('deleteConfirmPopup').classList.remove('hidden');
        }

        function closeDeleteConfirmPopup() {
            document.getElementById('deleteConfirmPopup').classList.add('hidden');
            accountToDelete = null;
        }

        async function confirmDeleteAccount() {
            if (!accountToDelete) return;
            
            try {
                showLoading();
                
                // Try Firebase first
                if (window.db && window.firestore) {
                    // Delete account
                    await window.firestore.deleteDoc(window.firestore.doc(window.db, 'accounts', accountToDelete));
                    
                    // Delete all transactions for this account
                    const accountTransactions = transactions.filter(t => t.accountId === accountToDelete);
                    for (const transaction of accountTransactions) {
                        await window.firestore.deleteDoc(window.firestore.doc(window.db, 'transactions', transaction.id));
                    }
                    
                    showToast('Account and all related transactions deleted successfully!');
                } else {
                    throw new Error('Firebase not available');
                }
                
            } catch (error) {
                console.error('Error deleting account:', error);
                
                // Fallback to local storage
                try {
                    // Remove from local accounts array
                    accounts = accounts.filter(acc => acc.id !== accountToDelete);
                    
                    // Remove from local storage
                    const localAccounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                    const filteredAccounts = localAccounts.filter(acc => acc.id !== accountToDelete);
                    localStorage.setItem('accounts', JSON.stringify(filteredAccounts));
                    
                    // Remove all transactions for this account
                    transactions = transactions.filter(t => t.accountId !== accountToDelete);
                    const localTransactions = JSON.parse(localStorage.getItem('transactions') || '[]');
                    const filteredTransactions = localTransactions.filter(t => t.accountId !== accountToDelete);
                    localStorage.setItem('transactions', JSON.stringify(filteredTransactions));
                    
                    // Update UI
                    loadAccounts();
                    loadTransactions();
                    updateDashboard();
                    updateReports();
                    
                    showToast('Account and all related transactions deleted successfully (saved locally)!');
                } catch (localError) {
                    console.error('Local storage error:', localError);
                    showToast('Error deleting account. Please try again.', 'error');
                }
            } finally {
                hideLoading();
                closeDeleteConfirmPopup();
            }
        }

        // Member UI Functions
        function showMemberSection(sectionName) {
            // Hide all member sections
            document.querySelectorAll('.member-section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show selected section
            document.getElementById(sectionName).classList.remove('hidden');
            
            // Update navigation
            document.querySelectorAll('#memberUI .nav-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            event.target.classList.remove('border-transparent', 'text-gray-500');
            event.target.classList.add('border-blue-500', 'text-blue-600');
        }

        async function loadMemberData(){
            const user = window.auth.currentUser;
            if (!user) return; // ସୁରକ୍ଷା: login ନଥିଲେ ଫେରିଯାଅ

            // ownerUid == current user ଆଧାରରେ accounts ନିଅ
            const q = window.firestore.query(
                window.firestore.collection(window.db,'accounts'),
                window.firestore.where('ownerUid','==', user.uid),
                window.firestore.limit(1)
            );

            try{
                const snap = await window.firestore.getDocs(q);
                if (snap.empty){
                    document.querySelector('#memberUI .recent')?.remove?.();
                    const card = document.getElementById('memberContent') || document.body;
                    card.innerHTML = `
                        <div class="p-4 border rounded">
                            No account found for this member.
                            Please ask the Admin to create your account and set <b>ownerUid</b>.
                        </div>`;
                    return;
                }
                
                const aDoc = snap.docs[0];
                const a = { id: aDoc.id, ...aDoc.data() };

                const createdAtText =
                    (a.createdAt && a.createdAt.toDate)
                        ? a.createdAt.toDate().toLocaleDateString()
                        : new Date(a.createdAt || Date.now()).toLocaleDateString();

                // UI ରେ ପ୍ରଦର୍ଶନ
                document.querySelector('#memberUI .status')?.textContent = a.status || 'Active';
                document.querySelector('#memberUI .balance')?.textContent = `₹${Number(a.currentBalance ?? 0).toFixed(2)}`;
                
                // Count transactions for this account
                const accountTransactions = transactions.filter(t => t.accountId === a.id);
                document.querySelector('#memberUI .txCount')?.textContent = accountTransactions.length;
                
                // Update balance color
                const balanceEl = document.querySelector('#memberUI .balance');
                if (balanceEl) {
                    balanceEl.className = `text-2xl font-bold ${a.currentBalance >= 0 ? 'text-green-600' : 'text-red-600'}`;
                }
                
                // Load account info
                const accountInfoEl = document.getElementById('memberAccountInfo');
                if (accountInfoEl) {
                    accountInfoEl.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-4">Personal Information</h4>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-sm font-medium text-gray-600">Name</label>
                                        <p class="text-gray-900">${a.name}</p>
                                    </div>
                                    ${a.businessName ? `
                                    <div>
                                        <label class="text-sm font-medium text-gray-600">Business Name</label>
                                        <p class="text-gray-900">${a.businessName}</p>
                                    </div>
                                    ` : ''}
                                    ${a.contactNumber ? `
                                    <div>
                                        <label class="text-sm font-medium text-gray-600">Contact Number</label>
                                        <p class="text-gray-900">${a.contactNumber}</p>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-4">Account Summary</h4>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-sm font-medium text-gray-600">Opening Balance</label>
                                        <p class="text-gray-900">₹${Number(a.openingBalance ?? 0).toFixed(2)}</p>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-gray-600">Current Balance</label>
                                        <p class="font-semibold ${a.currentBalance >= 0 ? 'text-green-600' : 'text-red-600'}">₹${Number(a.currentBalance ?? 0).toFixed(2)}</p>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-gray-600">Account Created</label>
                                        <p class="text-gray-900">${createdAtText}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Load member transactions for this specific account
                loadMemberTransactions(a.id);
                
            }catch(err){
                console.error('Error loading member data:', err);
                alert(err.message || 'Failed to load account');
            }
        }
        
        // Make it available globally
        window.loadMemberData = loadMemberData;

        function loadMemberTransactions(accountId = null) {
            if (!accountId) {
                // Try to get from current user's account
                const uid = window.auth.currentUser?.uid;
                if (!uid) return;
                
                // Find account by ownerUid
                const memberAccount = accounts.find(acc => acc.ownerUid === uid);
                if (!memberAccount) return;
                accountId = memberAccount.id;
            }
            
            const memberTransactions = transactions.filter(t => t.accountId === accountId);
            filterMemberTransactions(memberTransactions);
            
            // Load recent activity
            const recentTransactions = memberTransactions.slice(0, 5);
            if (recentTransactions.length > 0) {
                document.getElementById('memberRecentActivity').innerHTML = recentTransactions.map(transaction => `
                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg ${transaction.type === 'credit' ? 'transaction-credit' : 'transaction-debit'}">
                        <div class="flex-1">
                            <p class="font-medium text-gray-900">${transaction.description || 'No description'}</p>
                            <p class="text-xs text-gray-500">${new Date(transaction.date).toLocaleDateString()}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold ${transaction.type === 'credit' ? 'text-green-600' : 'text-red-600'}">
                                ${transaction.type === 'credit' ? '+' : '-'}₹${transaction.amount.toFixed(2)}
                            </p>
                        </div>
                    </div>
                `).join('');
            }
        }

        function filterMemberTransactions(memberTransactions = null) {
            if (!memberTransactions) {
                const memberAccount = accounts[0];
                if (!memberAccount) return;
                memberTransactions = transactions.filter(t => t.accountId === memberAccount.id);
            }
            
            const filter = document.getElementById('memberTransactionFilter').value;
            let filteredTransactions = [...memberTransactions];
            const now = new Date();
            
            switch (filter) {
                case 'today':
                    const today = now.toISOString().split('T')[0];
                    filteredTransactions = memberTransactions.filter(t => t.date === today);
                    break;
                case 'week':
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    filteredTransactions = memberTransactions.filter(t => new Date(t.date) >= weekAgo);
                    break;
                case 'month':
                    const monthAgo = new Date(now.getFullYear(), now.getMonth(), 1);
                    filteredTransactions = memberTransactions.filter(t => new Date(t.date) >= monthAgo);
                    break;
                case 'quarter':
                    const quarterAgo = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
                    filteredTransactions = memberTransactions.filter(t => new Date(t.date) >= quarterAgo);
                    break;
            }
            
            const transactionList = document.getElementById('memberTransactionList');
            
            if (filteredTransactions.length === 0) {
                transactionList.innerHTML = '<p class="text-gray-500 text-center py-8">No transactions found for selected period</p>';
                return;
            }
            
            // Sort by date (newest first)
            filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            transactionList.innerHTML = filteredTransactions.map(transaction => `
                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg ${transaction.type === 'credit' ? 'transaction-credit' : 'transaction-debit'}">
                    <div class="flex-1">
                        <p class="font-medium text-gray-900">${transaction.description || 'No description'}</p>
                        <p class="text-xs text-gray-500">${new Date(transaction.date).toLocaleDateString()}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold ${transaction.type === 'credit' ? 'text-green-600' : 'text-red-600'}">
                            ${transaction.type === 'credit' ? '+' : '-'}₹${transaction.amount.toFixed(2)}
                        </p>
                    </div>
                </div>
            `).join('');
        }

        function generateMemberStatement() {
            const memberAccount = accounts[0]; // Assuming first account for demo
            if (!memberAccount) {
                showToast('Account not found', 'error');
                return;
            }
            
            const period = document.getElementById('memberStatementPeriod').value;
            
            // Filter transactions by period
            let accountTransactions = transactions.filter(t => t.accountId === memberAccount.id);
            
            const now = new Date();
            switch (period) {
                case 'month':
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    accountTransactions = accountTransactions.filter(t => new Date(t.date) >= monthStart);
                    break;
                case 'quarter':
                    const quarterStart = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
                    accountTransactions = accountTransactions.filter(t => new Date(t.date) >= quarterStart);
                    break;
                case '6months':
                    const sixMonthsStart = new Date(now.getFullYear(), now.getMonth() - 6, 1);
                    accountTransactions = accountTransactions.filter(t => new Date(t.date) >= sixMonthsStart);
                    break;
                case 'year':
                    const yearStart = new Date(now.getFullYear(), 0, 1);
                    accountTransactions = accountTransactions.filter(t => new Date(t.date) >= yearStart);
                    break;
            }
            
            // Sort by date
            accountTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Generate statement HTML
            const statementContent = document.getElementById('memberStatementContent');
            
            if (accountTransactions.length === 0) {
                statementContent.innerHTML = '<p class="text-gray-500 text-center py-8">No transactions found for selected period</p>';
                return;
            }
            
            let runningBalance = memberAccount.openingBalance;
            const totalCredit = accountTransactions.filter(t => t.type === 'credit').reduce((sum, t) => sum + t.amount, 0);
            const totalDebit = accountTransactions.filter(t => t.type === 'debit').reduce((sum, t) => sum + t.amount, 0);
            
            statementContent.innerHTML = `
                <div class="statement-header mb-6 p-6 bg-gray-50 rounded-lg">
                    <div class="text-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-900">Deulasahi Bazar Committee</h2>
                        <p class="text-gray-600">Account Statement</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p><strong>Account Holder:</strong> ${memberAccount.name}</p>
                            ${memberAccount.businessName ? `<p><strong>Business:</strong> ${memberAccount.businessName}</p>` : ''}
                        </div>
                        <div>
                            <p><strong>Period:</strong> ${getPeriodText(period)}</p>
                            <p><strong>Generated:</strong> ${new Date().toLocaleDateString()}</p>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border border-gray-300 px-4 py-2 text-left">Date</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">Description</th>
                                <th class="border border-gray-300 px-4 py-2 text-right">Debit</th>
                                <th class="border border-gray-300 px-4 py-2 text-right">Credit</th>
                                <th class="border border-gray-300 px-4 py-2 text-right">Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${accountTransactions.map(transaction => {
                                if (transaction.type === 'credit') {
                                    runningBalance += transaction.amount;
                                } else {
                                    runningBalance -= transaction.amount;
                                }
                                
                                return `
                                    <tr>
                                        <td class="border border-gray-300 px-4 py-2">${new Date(transaction.date).toLocaleDateString()}</td>
                                        <td class="border border-gray-300 px-4 py-2">${transaction.description || 'No description'}</td>
                                        <td class="border border-gray-300 px-4 py-2 text-right">${transaction.type === 'debit' ? '₹' + transaction.amount.toFixed(2) : '-'}</td>
                                        <td class="border border-gray-300 px-4 py-2 text-right">${transaction.type === 'credit' ? '₹' + transaction.amount.toFixed(2) : '-'}</td>
                                        <td class="border border-gray-300 px-4 py-2 text-right font-semibold ${runningBalance >= 0 ? 'text-green-600' : 'text-red-600'}">₹${runningBalance.toFixed(2)}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div>
                            <p class="text-sm text-gray-600">Total Credit</p>
                            <p class="text-lg font-bold text-green-600">₹${totalCredit.toFixed(2)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Total Debit</p>
                            <p class="text-lg font-bold text-red-600">₹${totalDebit.toFixed(2)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Current Balance</p>
                            <p class="text-lg font-bold ${memberAccount.currentBalance >= 0 ? 'text-green-600' : 'text-red-600'}">₹${memberAccount.currentBalance.toFixed(2)}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function downloadMemberPDF() {
            const memberAccount = accounts[0]; // Assuming first account for demo
            if (!memberAccount) {
                showToast('Account not found', 'error');
                return;
            }
            
            const period = document.getElementById('memberStatementPeriod').value;
            
            // Create PDF using the same logic as admin PDF generation
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Deulasahi Bazar Committee', 105, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text('Account Statement', 105, 30, { align: 'center' });
            
            // Account details
            doc.text(`Account Holder: ${memberAccount.name}`, 20, 50);
            if (memberAccount.businessName) {
                doc.text(`Business: ${memberAccount.businessName}`, 20, 60);
            }
            doc.text(`Period: ${getPeriodText(period)}`, 20, 70);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 80);
            
            // Filter transactions (same logic as generateMemberStatement)
            let accountTransactions = transactions.filter(t => t.accountId === memberAccount.id);
            const now = new Date();
            
            switch (period) {
                case 'month':
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    accountTransactions = accountTransactions.filter(t => new Date(t.date) >= monthStart);
                    break;
                case 'quarter':
                    const quarterStart = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
                    accountTransactions = accountTransactions.filter(t => new Date(t.date) >= quarterStart);
                    break;
                case '6months':
                    const sixMonthsStart = new Date(now.getFullYear(), now.getMonth() - 6, 1);
                    accountTransactions = accountTransactions.filter(t => new Date(t.date) >= sixMonthsStart);
                    break;
                case 'year':
                    const yearStart = new Date(now.getFullYear(), 0, 1);
                    accountTransactions = accountTransactions.filter(t => new Date(t.date) >= yearStart);
                    break;
            }
            
            accountTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Create table data
            const tableData = [];
            let runningBalance = memberAccount.openingBalance;
            
            accountTransactions.forEach(transaction => {
                if (transaction.type === 'credit') {
                    runningBalance += transaction.amount;
                } else {
                    runningBalance -= transaction.amount;
                }
                
                tableData.push([
                    new Date(transaction.date).toLocaleDateString(),
                    transaction.description || 'No description',
                    transaction.type === 'debit' ? `₹${transaction.amount.toFixed(2)}` : '-',
                    transaction.type === 'credit' ? `₹${transaction.amount.toFixed(2)}` : '-',
                    `₹${runningBalance.toFixed(2)}`
                ]);
            });
            
            // Add table
            doc.autoTable({
                head: [['Date', 'Description', 'Debit', 'Credit', 'Balance']],
                body: tableData,
                startY: 90,
                styles: { fontSize: 10 },
                headStyles: { fillColor: [59, 130, 246] }
            });
            
            // Save PDF
            doc.save(`${memberAccount.name}_Statement_${getPeriodText(period)}.pdf`);
            
            showToast('PDF downloaded successfully!');
        }

        // Add event listener for member transaction filter
        document.getElementById('memberTransactionFilter').addEventListener('change', () => filterMemberTransactions());

        // Add role selection button event listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('btnMember').onclick = () => { 
                window.chosenRole = 'member'; 
                selectRole('member');
            };
            document.getElementById('btnAdmin').onclick = () => { 
                window.chosenRole = 'admin'; 
                selectRole('admin');
            };
        });

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            
            // Update colors based on type
            const toastDiv = toast.firstElementChild;
            if (type === 'error') {
                toastDiv.className = 'bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2';
            } else {
                toastDiv.className = 'bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2';
            }
            
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97dc162645a47a01',t:'MTc1NzY0NTMxMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>

</html>












